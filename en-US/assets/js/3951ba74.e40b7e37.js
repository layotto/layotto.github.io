"use strict";(self.webpackChunklayotto_docusaurus=self.webpackChunklayotto_docusaurus||[]).push([[5931],{995:(e,o,n)=>{n.r(o),n.d(o,{assets:()=>d,contentTitle:()=>c,default:()=>h,frontMatter:()=>s,metadata:()=>i,toc:()=>a});var t=n(4848),r=n(8453);const s={},c="How to generate code and documentation from the .proto files",i={id:"api_reference/how_to_generate_api_doc",title:"How to generate code and documentation from the .proto files",description:"Suppose you wrote a new proto file spec/proto/extension/v1/email/email.proto and you want to implement this API in Layotto:",source:"@site/i18n/en-US/docusaurus-plugin-content-docs/current/api_reference/how_to_generate_api_doc.md",sourceDirName:"api_reference",slug:"/api_reference/how_to_generate_api_doc",permalink:"/layotto/en-US/docs/api_reference/how_to_generate_api_doc",draft:!1,unlisted:!1,editUrl:"https://github.com/mosn/layotto/edit/main/api_reference/how_to_generate_api_doc.md",tags:[],version:"current",frontMatter:{},sidebar:"mySidebar",previous:{title:"layotto component reference",permalink:"/layotto/en-US/docs/development/component_ref/"},next:{title:"Comment specification of proto file",permalink:"/layotto/en-US/docs/api_reference/comment_spec_of_proto"}},d={},a=[{value:"step 1. Make sure your proto file meets the following requirements",id:"step-1-make-sure-your-proto-file-meets-the-following-requirements",level:2},{value:"step 2. Check the environment",id:"step-2-check-the-environment",level:2},{value:"step 3. Generate everything",id:"step-3-generate-everything",level:2},{value:"step 4. Write the rest of the code",id:"step-4-write-the-rest-of-the-code",level:2},{value:"Behind the scenes",id:"behind-the-scenes",level:2},{value:"What if I want to generate pb/documentation only?",id:"what-if-i-want-to-generate-pbdocumentation-only",level:2},{value:"How to compile the proto files into <code>.pb.go</code> code",id:"how-to-compile-the-proto-files-into-pbgo-code",level:3},{value:"<strong>Make cmmand(recommended)</strong>",id:"make-cmmandrecommended",level:4},{value:"<strong>Install protoc</strong>",id:"install-protoc",level:4},{value:"How to generate API reference doc according to the proto files",id:"how-to-generate-api-reference-doc-according-to-the-proto-files",level:3},{value:"<strong>Make command(recommended)</strong>",id:"make-commandrecommended",level:4},{value:"<strong>Use docker to run protoc-gen-doc</strong>",id:"use-docker-to-run-protoc-gen-doc",level:4}];function l(e){const o={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(o.h1,{id:"how-to-generate-code-and-documentation-from-the-proto-files",children:["How to generate code and documentation from the ",(0,t.jsx)(o.code,{children:".proto"})," files"]}),"\n",(0,t.jsxs)(o.p,{children:["Suppose you wrote a new proto file ",(0,t.jsx)(o.code,{children:"spec/proto/extension/v1/email/email.proto"})," and you want to implement this API in Layotto:"]}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{className:"language-protobuf",children:"// EmailService is used to send emails.\nservice EmailService {\n\n  // Send an email with template\n  rpc SendEmailWithTemplate(SendEmailWithTemplateRequest) returns (SendEmailWithTemplateResponse) {}\n\n  // Send an email with raw content instead of using templates.\n  rpc SendEmail(SendEmailRequest) returns (SendEmailResponse) {}\n\n}\n\n// different message types......\n"})}),"\n",(0,t.jsx)(o.p,{children:"It's a tedious job because you have to write a lot of code and docs."}),"\n",(0,t.jsx)(o.p,{children:"Fortunately, Layotto has tools to generate the code/docs/CI configuration automatically. You don't have to do the job yourself!"}),"\n",(0,t.jsx)(o.h2,{id:"step-1-make-sure-your-proto-file-meets-the-following-requirements",children:"step 1. Make sure your proto file meets the following requirements"}),"\n",(0,t.jsxs)(o.ul,{children:["\n",(0,t.jsxs)(o.li,{children:["The file path should be ",(0,t.jsx)(o.code,{children:"spec/proto/extension/v1/{api short name}/{api short name}.proto"})]}),"\n",(0,t.jsxs)(o.li,{children:["There should be only one ",(0,t.jsx)(o.code,{children:"service"})," in the proto file. For example, the following file is ",(0,t.jsx)(o.strong,{children:"WRONG"})," :"]}),"\n"]}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{className:"language-protobuf",children:"// EmailService is used to send emails.\nservice EmailService {\n  // ...\n}\n\n// Wrong: there should be only one `service` in a `.proto` file\nservice EmailService2 {\n  // ...\n}\n\n// different message types......\n"})}),"\n",(0,t.jsxs)(o.ul,{children:["\n",(0,t.jsxs)(o.li,{children:["If you don't want to generate the quickstart docs for the proto, add a comment ",(0,t.jsx)(o.code,{children:"/* @exclude skip quickstart_generator */"})," ."]}),"\n",(0,t.jsxs)(o.li,{children:["If you don't want to generate the sdk & sidecar code for the proto, add a comment ",(0,t.jsx)(o.code,{children:"/* @exclude skip code_generator */"})," ."]}),"\n"]}),"\n",(0,t.jsxs)(o.p,{children:["You can take the ",(0,t.jsx)(o.code,{children:"spec/proto/extension/v1/s3/oss.proto"})," as an example:"]}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{className:"language-protobuf",children:'/* @exclude skip quickstart_generator */\n/* @exclude skip code_generator */\n// ObjectStorageService is an abstraction for blob storage or so called "object storage", such as alibaba cloud OSS, such as AWS S3.\n// You invoke ObjectStorageService API to do some CRUD operations on your binary file, e.g. query my file, delete my file, etc.\nservice ObjectStorageService{\n  //......\n}\n'})}),"\n",(0,t.jsxs)(o.p,{children:['These special comments are called "Master\'s commands". There are many other commands, and you can check ',(0,t.jsx)(o.a,{href:"https://github.com/layotto/protoc-gen-p6#masters-commands",children:"the doc"})," for more details."]}),"\n",(0,t.jsx)(o.h2,{id:"step-2-check-the-environment",children:"step 2. Check the environment"}),"\n",(0,t.jsx)(o.p,{children:"To run the generator, you need:"}),"\n",(0,t.jsxs)(o.ul,{children:["\n",(0,t.jsx)(o.li,{children:"Go version >=1.16"}),"\n",(0,t.jsx)(o.li,{children:"Start Docker"}),"\n"]}),"\n",(0,t.jsx)(o.h2,{id:"step-3-generate-everything",children:"step 3. Generate everything"}),"\n",(0,t.jsx)(o.p,{children:"Note: the command below should be executed under layotto directory"}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{className:"language-shell",children:"make proto\n"})}),"\n",(0,t.jsx)(o.p,{children:"Then you get:"}),"\n",(0,t.jsxs)(o.ul,{children:["\n",(0,t.jsxs)(o.li,{children:["Generated code","\n",(0,t.jsxs)(o.ul,{children:["\n",(0,t.jsxs)(o.li,{children:[(0,t.jsx)(o.code,{children:".pb.go"})," code"]}),"\n",(0,t.jsxs)(o.li,{children:[(0,t.jsx)(o.code,{children:"_grpc.pb.go"})," code"]}),"\n",(0,t.jsx)(o.li,{children:"layotto go-sdk code"}),"\n",(0,t.jsx)(o.li,{children:"layotto sidecar code"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(o.li,{children:["Generated documentation","\n",(0,t.jsxs)(o.ul,{children:["\n",(0,t.jsx)(o.li,{children:"API reference docs"}),"\n",(0,t.jsx)(o.li,{children:"updated API reference list"}),"\n",(0,t.jsx)(o.li,{children:"quickstart document (both chinese and english)"}),"\n",(0,t.jsxs)(o.li,{children:["updated sidebar (The tool will add the generated quickstart doc into the sidebar of ",(0,t.jsx)(o.a,{href:"https://mosn.io/layotto",children:"https://mosn.io/layotto"})," )"]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(o.li,{children:["Updated CI (The tool will add the generated quickstart doc into the CI script ",(0,t.jsx)(o.code,{children:"etc/script/test-quickstart.sh"}),")"]}),"\n"]}),"\n",(0,t.jsx)(o.h2,{id:"step-4-write-the-rest-of-the-code",children:"step 4. Write the rest of the code"}),"\n",(0,t.jsx)(o.p,{children:"Now it's your job to implement:"}),"\n",(0,t.jsxs)(o.ul,{children:["\n",(0,t.jsx)(o.li,{children:"Layotto component"}),"\n",(0,t.jsx)(o.li,{children:"go examples"}),"\n"]}),"\n",(0,t.jsx)(o.p,{children:(0,t.jsx)(o.img,{src:"https://user-images.githubusercontent.com/26001097/188782762-bc1404a8-b891-45d3-a1ac-f86cafdbc0ab.png",alt:"image"})}),"\n",(0,t.jsxs)(o.ul,{children:["\n",(0,t.jsx)(o.li,{children:"java examples"}),"\n"]}),"\n",(0,t.jsx)(o.p,{children:(0,t.jsx)(o.img,{src:"https://user-images.githubusercontent.com/26001097/188782989-9aec893f-9d12-4ee6-9a64-940b0ba1ba1b.png",alt:"image"})}),"\n",(0,t.jsx)(o.h2,{id:"behind-the-scenes",children:"Behind the scenes"}),"\n",(0,t.jsxs)(o.p,{children:["We have a protoc plugin called ",(0,t.jsx)(o.a,{href:"https://github.com/layotto/protoc-gen-p6",children:"protoc-gen-p6"})," to generate code for Layotto."]}),"\n",(0,t.jsx)(o.h2,{id:"what-if-i-want-to-generate-pbdocumentation-only",children:"What if I want to generate pb/documentation only?"}),"\n",(0,t.jsxs)(o.p,{children:["The steps above generate everything, but what if I only want to generate ",(0,t.jsx)(o.code,{children:".pb.go"})," code ? What if I only want to generate the docs?"]}),"\n",(0,t.jsxs)(o.h3,{id:"how-to-compile-the-proto-files-into-pbgo-code",children:["How to compile the proto files into ",(0,t.jsx)(o.code,{children:".pb.go"})," code"]}),"\n",(0,t.jsx)(o.h4,{id:"make-cmmandrecommended",children:(0,t.jsx)(o.strong,{children:"Make cmmand(recommended)"})}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{className:"language-bash",children:"make proto-code\n"})}),"\n",(0,t.jsxs)(o.p,{children:["This command uses docker to run protoc and generate ",(0,t.jsx)(o.code,{children:".pb.go"})," code files."]}),"\n",(0,t.jsx)(o.h4,{id:"install-protoc",children:(0,t.jsx)(o.strong,{children:"Install protoc"})}),"\n",(0,t.jsxs)(o.ol,{children:["\n",(0,t.jsxs)(o.li,{children:["\n",(0,t.jsxs)(o.p,{children:["Install protoc version: ",(0,t.jsx)(o.a,{href:"https://github.com/protocolbuffers/protobuf/releases/tag/v3.17.3",children:"v3.17.3"})]}),"\n"]}),"\n",(0,t.jsxs)(o.li,{children:["\n",(0,t.jsx)(o.p,{children:"Install protoc-gen-go v1.28 and protoc-gen-go-grpc v1.2"}),"\n"]}),"\n",(0,t.jsxs)(o.li,{children:["\n",(0,t.jsxs)(o.p,{children:["Generate gRPC ",(0,t.jsx)(o.code,{children:".pb.go"})," code"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{className:"language-bash",children:"cd spec/proto/runtime/v1\nprotoc -I. --go_out=. --go_opt=paths=source_relative --go-grpc_out=. --go-grpc_opt=require_unimplemented_servers=false,paths=source_relative *.proto\n"})}),"\n",(0,t.jsx)(o.h3,{id:"how-to-generate-api-reference-doc-according-to-the-proto-files",children:"How to generate API reference doc according to the proto files"}),"\n",(0,t.jsxs)(o.p,{children:["We can use ",(0,t.jsx)(o.a,{href:"https://github.com/pseudomuto/protoc-gen-doc",children:"protoc-gen-doc"})," and docker to generate api documents,the command is as follows:"]}),"\n",(0,t.jsx)(o.h4,{id:"make-commandrecommended",children:(0,t.jsx)(o.strong,{children:"Make command(recommended)"})}),"\n",(0,t.jsx)(o.pre,{children:(0,t.jsx)(o.code,{className:"language-bash",children:"make proto-doc\n"})}),"\n",(0,t.jsx)(o.p,{children:"This command uses docker to run protoc-gen-doc and generate docs."}),"\n",(0,t.jsx)(o.h4,{id:"use-docker-to-run-protoc-gen-doc",children:(0,t.jsx)(o.strong,{children:"Use docker to run protoc-gen-doc"})}),"\n",(0,t.jsxs)(o.p,{children:[(0,t.jsx)(o.code,{children:"make proto-doc"})," invokes the script ",(0,t.jsx)(o.code,{children:"etc/script/generate-doc.sh"}),", which uses docker to run protoc-gen-doc."]}),"\n",(0,t.jsxs)(o.p,{children:["You can check ",(0,t.jsx)(o.code,{children:"etc/script/generate-doc.sh"})," for more details."]})]})}function h(e={}){const{wrapper:o}={...(0,r.R)(),...e.components};return o?(0,t.jsx)(o,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}},8453:(e,o,n)=>{n.d(o,{R:()=>c,x:()=>i});var t=n(6540);const r={},s=t.createContext(r);function c(e){const o=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(o):{...o,...e}}),[o,e])}function i(e){let o;return o=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:c(e.components),t.createElement(s.Provider,{value:o},e.children)}}}]);
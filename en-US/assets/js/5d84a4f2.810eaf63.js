"use strict";(self.webpackChunklayotto_docusaurus=self.webpackChunklayotto_docusaurus||[]).push([[7803],{872:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>r,default:()=>h,frontMatter:()=>o,metadata:()=>l,toc:()=>c});var t=s(4848),i=s(8453);const o={},r="Add TryLock and Unlock API",l={id:"design/lock/lock-api-design",title:"Add TryLock and Unlock API",description:"Add TryLock and Unlock API.",source:"@site/i18n/en-US/docusaurus-plugin-content-docs/current/design/lock/lock-api-design.md",sourceDirName:"design/lock",slug:"/design/lock/lock-api-design",permalink:"/en-US/docs/design/lock/lock-api-design",draft:!1,unlisted:!1,editUrl:"https://github.com/mosn/layotto/edit/main/design/lock/lock-api-design.md",tags:[],version:"current",frontMatter:{},sidebar:"mySidebar",previous:{title:"RPC Design Document",permalink:"/en-US/docs/design/rpc/rpc_design_document"},next:{title:"Sequencer API design document",permalink:"/en-US/docs/design/sequencer/design"}},a={},c=[{value:"API",id:"api",level:2},{value:"Design principles",id:"design-principles",level:3},{value:"TryLock/Unlock",id:"trylockunlock",level:3},{value:"Renewal",id:"renewal",level:3},{value:"Solvation A: add an API &quot;LockKeepAlive&quot;",id:"solvation-a-add-an-api-lockkeepalive",level:4},{value:"Solvolution B: Users are not aware of continued lease logic, auto-rent, app and sidecar maintain a unified heart jump",id:"solvolution-b-users-are-not-aware-of-continued-lease-logic-auto-rent-app-and-sidecar-maintain-a-unified-heart-jump",level:4},{value:"Solvation C retries unlock",id:"solvation-c-retries-unlock",level:4},{value:"Conclusion",id:"conclusion",level:4},{value:"Components",id:"components",level:2},{value:"How to deal with &quot;components do not support a feature option&quot;",id:"how-to-deal-with-components-do-not-support-a-feature-option",level:3},{value:"How to deal with &quot;components do not support an API&quot;",id:"how-to-deal-with-components-do-not-support-an-api",level:3},{value:"Selection:",id:"selection",level:3},{value:"&quot;Running missing&quot; designs destroy portability and how can users be made simpler to assess whether they can transplant?",id:"running-missing-designs-destroy-portability-and-how-can-users-be-made-simpler-to-assess-whether-they-can-transplant",level:3}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"add-trylock-and-unlock-api",children:"Add TryLock and Unlock API"}),"\n",(0,t.jsx)(n.p,{children:"Add TryLock and Unlock API."}),"\n",(0,t.jsx)(n.p,{children:"The renewal API is disputed and version 1 is not part of the renewal API"}),"\n",(0,t.jsx)(n.h1,{id:"research",children:"Research"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:(0,t.jsx)(n.strong,{children:"System"})}),(0,t.jsx)(n.th,{children:(0,t.jsx)(n.strong,{children:"Distributed Lock"})}),(0,t.jsx)(n.th,{children:(0,t.jsx)(n.strong,{children:"Block lock (watch)"})}),(0,t.jsx)(n.th,{children:(0,t.jsx)(n.strong,{children:"Availability"})}),(0,t.jsx)(n.th,{children:(0,t.jsx)(n.strong,{children:"Write line consistent"})}),(0,t.jsx)(n.th,{children:(0,t.jsxs)(n.strong,{children:["sequencer (",(0,t.jsx)(n.a,{href:"https://static.googleusercontent.com/media/research.google.com/zh-TW//archive/chubby-osdi06.pdf",children:"chubby\u8bba\u6587\u91cc\u63d0\u51fa\u7684feature"})]})}),(0,t.jsx)(n.th,{children:(0,t.jsx)(n.strong,{children:"Renewed"})})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Solo Redis"}),(0,t.jsx)(n.td,{children:"yes"}),(0,t.jsx)(n.td,{children:"x"}),(0,t.jsx)(n.td,{children:"Lock service is not available when single point expires"}),(0,t.jsx)(n.td,{children:"yes"}),(0,t.jsx)(n.td,{children:"yes(needed pic)"}),(0,t.jsx)(n.td,{children:"yes"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"rediscluster"}),(0,t.jsx)(n.td,{children:"yes"}),(0,t.jsx)(n.td,{children:"x"}),(0,t.jsx)(n.td,{children:"yes"}),(0,t.jsx)(n.td,{children:"no. Failures can cause locking"}),(0,t.jsx)(n.td,{children:"yes(needed pic)"}),(0,t.jsx)(n.td,{children:"yes"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"redis Redlock"}),(0,t.jsx)(n.td,{children:"yes"}),(0,t.jsx)(n.td,{}),(0,t.jsx)(n.td,{}),(0,t.jsx)(n.td,{}),(0,t.jsx)(n.td,{}),(0,t.jsx)(n.td,{})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"consul"}),(0,t.jsx)(n.td,{children:"yes"}),(0,t.jsx)(n.td,{}),(0,t.jsx)(n.td,{}),(0,t.jsx)(n.td,{}),(0,t.jsx)(n.td,{}),(0,t.jsx)(n.td,{})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"zookeeper"}),(0,t.jsx)(n.td,{children:"yes"}),(0,t.jsx)(n.td,{children:"yes"}),(0,t.jsxs)(n.td,{children:["yes has fo, [elections within 200 ms] (",(0,t.jsx)(n.a,{href:"https://pdos.csail.mit.edu/6.824/papers/zookeeper.pdf",children:"https://pdos.csail.mit.edu/6.824/papers/zookeeper.pdf"}),")"]}),(0,t.jsx)(n.td,{children:"yes"}),(0,t.jsx)(n.td,{children:"yes use zxid as sensor"}),(0,t.jsx)(n.td,{children:"yes"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"etcd"}),(0,t.jsx)(n.td,{children:"yes"}),(0,t.jsx)(n.td,{children:"yes"}),(0,t.jsx)(n.td,{children:"yes"}),(0,t.jsx)(n.td,{children:"yes"}),(0,t.jsx)(n.td,{children:"yes use revision"}),(0,t.jsx)(n.td,{children:"yes lease. KeepAlive"})]})]})]}),"\n",(0,t.jsx)(n.p,{children:"Can see some difference in capacity or"}),"\n",(0,t.jsx)(n.h1,{id:"high-level-design",children:"High-level design"}),"\n",(0,t.jsx)(n.h2,{id:"api",children:"API"}),"\n",(0,t.jsx)(n.h3,{id:"design-principles",children:"Design principles"}),"\n",(0,t.jsx)(n.p,{children:"We are faced with many temptations, distributive locks have many features that can be done (blocked, relocked, read, lock, sequencer, etc.)"}),"\n",(0,t.jsx)(n.p,{children:"But after all, our goal is to design a sufficient set of common API specifications, so as to be as conservative as possible on the API, to abstract simple and common features into API specifications before considering more features into API norms"}),"\n",(0,t.jsx)(n.h3,{id:"trylockunlock",children:"TryLock/Unlock"}),"\n",(0,t.jsx)(n.p,{children:"Base Lockout and unlock features.TryLock is not blocked, return directly if no locks are grabbed"}),"\n",(0,t.jsx)(n.p,{children:"proto:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-protobuf",children:"// Distributed Lock API\nrpc TryLock(TryLockRequest)returns (TryLockResponse) {}\n\nrpc Unlock(UnlockRequest)returns (UnlockResponse) {}\n\nmessage TryLockRequest {\n  string store_name = 1;\n  // resource_id is the lock key.\n  string resource_id = 2;\n  // lock_owner indicate the identifier of lock owner.\n  // This field is required.You can generate a uuid as lock_owner.For example,in golang:\n  //\n  // req.LockOwner = uuid.New().String()\n  //\n  // This field is per request,not per process,so it is different for each request,\n  // which aims to prevent multi-thread in the same process trying the same lock concurrently.\n  //\n  // The reason why we don't make it automatically generated is:\n  // 1. If it is automatically generated,there must be a 'my_lock_owner_id' field in the response.\n  // This name is so weird that we think it is inappropriate to put it into the api spec\n  // 2. If we change the field 'my_lock_owner_id' in the response to 'lock_owner',which means the current lock owner of this lock,\n  // we find that in some lock services users can't get the current lock owner.Actually users don't need it at all.\n  // 3. When reentrant lock is needed,the existing lock_owner is required to identify client and check \"whether this client can reenter this lock\".\n  // So this field in the request shouldn't be removed.\n  string lock_owner = 3;\n  // expire is the time before expire.The time unit is second.\n  int32 expire = 4;\n}\n\nmessage TryLockResponse {\n\n  bool success = 1;\n}\n\nmessage UnlockRequest {\n  string store_name = 1;\n  // resource_id is the lock key.\n  string resource_id = 2;\n\n  string lock_owner = 3;\n}\n\nmessage UnlockResponse {\n  enum Status {\n    SUCCESS = 0;\n    LOCK_UNEXIST = 1;\n    LOCK_BELONG_TO_OTHERS = 2;\n    INTERNAL_ERROR = 3;\n  }\n\n  Status status = 1;\n}\n\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Q: the time unit for the expire?"})}),"\n",(0,t.jsx)(n.p,{children:"A: seconds."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Q: Can you force users to make seconds large points without being too small?"})}),"\n",(0,t.jsx)(n.p,{children:"A: is not allowed on compilation or on startup."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Q: What if multiple clients transmit the same LockOwner?"})}),"\n",(0,t.jsx)(n.p,{children:"Case 1. Two client app-id is different, with the same lockOwner passed and no conflict"}),"\n",(0,t.jsx)(n.p,{children:"Case 2. Like the two client app-ids, there is a conflict between LockOwner with the same passage.There may be exceptional circumstances in which someone can be robbed, frees someone else's lock."}),"\n",(0,t.jsx)(n.p,{children:"The user therefore needs to ensure the uniqueness of LockOwner, such as assigning a UUID, golangprototype\uff1a per request"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-go",children:'import "github.com/google/uuid"\n//...\nreq.LockOwner = uuid.New().String()\n'})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Q: What does not meta"})}),"\n",(0,t.jsx)(n.p,{children:"A: Be as conservative as possible at the beginning, and some people get feedback about additional needs or find out in the implementation of the component that there is a real need for settlement"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Q: Do you want to support sequentier and relocking features like then?"})}),"\n",(0,t.jsx)(n.p,{children:"A: Add feature option to add components to support interface"}),"\n",(0,t.jsx)(n.h3,{id:"renewal",children:"Renewal"}),"\n",(0,t.jsx)(n.h4,{id:"solvation-a-add-an-api-lockkeepalive",children:'Solvation A: add an API "LockKeepAlive"'}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-protobuf",children:"rpc LockKeepAlive(stream LockKeepAliveRequest) returns (stream LockKeepAliveResponse) {}\n  \nmessage LockKeepAliveRequest L$\n  // resource_id is the lock key.\n  string resource_id = 1;\n\n  string client_id = 2;\n  // expire is the time to expire\n  int64 expire = 3;\n}\n\nmessage LockKeepAliveResponse LO\n  enum Status Fit\n    SUCCESS = 0;\n    LOCK_UNEXIST = 1;\n    LOCK_BELONG_TO_OTHERS = 2;\n  }\n  // resource_id is the lock key.\n  string resource_id = 1;\n\n  Status status = 2;\n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"The re-entry of the lease and the return result is stream, where the implementation of the reference etcd, the app and sidecar need to maintain only one connection and use the link to relay the renewal lease request every time the lock requires a renewal lease."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Q: Why don't you use the renewal as a stream parameter to tryLock?"})}),"\n",(0,t.jsx)(n.p,{children:"A: Many businesses are not rented to make trylock as simple as possible;"}),"\n",(0,t.jsx)(n.p,{children:"To maximize single responsibilities, followed by blocklocks that can be used to renew the API;"}),"\n",(0,t.jsx)(n.p,{children:"Split parts with streams into an interface to make it easy for https."}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Q: The renewal logic is too complex to make users unknown?"})}),"\n",(0,t.jsx)(n.p,{children:"A: sdk block this logic, start thread/protocol/nodejs timing, automatic renewal"}),"\n",(0,t.jsx)(n.h4,{id:"solvolution-b-users-are-not-aware-of-continued-lease-logic-auto-rent-app-and-sidecar-maintain-a-unified-heart-jump",children:"Solvolution B: Users are not aware of continued lease logic, auto-rent, app and sidecar maintain a unified heart jump"}),"\n",(0,t.jsx)(n.p,{children:"Disadvantages/Difficulty\uff1a"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Use uniform heart jumps, it is difficult to customize interval"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Solve is a guaranteed low jump intervals, for example 1 second time in 1 second"}),"\n",(0,t.jsxs)(n.ol,{start:"2",children:["\n",(0,t.jsx)(n.li,{children:"How to ensure reliable troubleshooting?"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"e.g. the java code below, unlock may fail\uff1a"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"tryLO\n\n}finallyLO\n  lock.unlock()   \n}\n"})}),"\n",(0,t.jsx)(n.p,{children:"If a single machine lock, unlock guarantees success (unless the entire jvm failure), but unlocks can fail.How can you make sure to jump off when the call fails?"}),"\n",(0,t.jsx)(n.p,{children:"This requires business to jump to the state of some fine particle levels when developing the business."}),"\n",(0,t.jsx)(n.p,{children:"We can define the HTML callback interface to be detected by actuator wheel and agree that the callback returned data structure is\uff1a"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "status": "UP",\n  "details": {\n    "lock": [\n      {\n        "resource_id": "res1",\n        "client_id": "dasfdasfasdfa",\n        "type": "unlock_fail"\n      }\n    ],\n    "xxx": []\n  }\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"App handles state gathering, reporting and clearing after successful reporting, limiting map capacity (e.g. the number of failed reports and the size of the map's big OOOM). Altogether, it requires the app to perform some complicated logic, as well as to release the sdk"}),"\n",(0,t.jsxs)(n.ol,{start:"3",children:["\n",(0,t.jsx)(n.li,{children:"This implementation, like renewal of rent, is managed on a separate connection that needs to be reported through this public connection."}),"\n",(0,t.jsx)(n.li,{children:"API speciality dependency jump logic.Dependency jumps interval and heart jump back data structure.The equivalent of the API speck relies on Layotto implementation, unless we can also standardize heart jump and drop (including intervals, returned data structures, etc.)"}),"\n",(0,t.jsx)(n.li,{children:"Heart jump failed once. Do sidecar continue rent?If the sidecar stopped renting anymore, will the next heart jump test be normal, will sidecar resume the lease?It is more difficult to define, because there is a skeptical mechanism (for example, a few failures of heart failure), when the skepticism ends too slowly and when the radical stop of the lease can be repeated"}),"\n",(0,t.jsx)(n.li,{children:"The app skipped once and then restored. sidecar knows how to know if the app continues to be locked (it may be just a short time to shake, then restored, or it may simply restart unlocked)"}),"\n"]}),"\n",(0,t.jsxs)(n.h4,{id:"solvation-c-retries-unlock",children:["Solvation C",":app"," retries unlock"]}),"\n",(0,t.jsx)(n.p,{children:"If unlocks fail, apply your own asynchronous retry unlock"}),"\n",(0,t.jsx)(n.h4,{id:"conclusion",children:"Conclusion"}),"\n",(0,t.jsx)(n.p,{children:"There are currently divergent views on the renewal of the rental scheme and the renewal of the rental function will not be achieved in one issue."}),"\n",(0,t.jsx)(n.p,{children:"Personal inclination to Program A, sdk blocks the logic of renewal of rent.While a grpc direct transfer would require the processing of the renewal logic, the renewal of the lease would be a distributed localized locking programme and a low cost of understanding by the developers."}),"\n",(0,t.jsx)(n.p,{children:"Throw out for everybody"}),"\n",(0,t.jsx)(n.h2,{id:"components",children:"Components"}),"\n",(0,t.jsx)(n.h3,{id:"how-to-deal-with-components-do-not-support-a-feature-option",children:'How to deal with "components do not support a feature option"'}),"\n",(0,t.jsx)(n.p,{children:"Simulate >Run Error>ignore"}),"\n",(0,t.jsx)(n.p,{children:"Exceptional circumstances, such as consistence, are eventual, but the storage system itself is strong and can be used as an option"}),"\n",(0,t.jsx)(n.h3,{id:"how-to-deal-with-components-do-not-support-an-api",children:'How to deal with "components do not support an API"'}),"\n",(0,t.jsx)(n.p,{children:"Simulate >Run Error"}),"\n",(0,t.jsx)(n.p,{children:"As transaction API examples"}),"\n",(0,t.jsx)(n.h3,{id:"selection",children:"Selection:"}),"\n",(0,t.jsx)(n.p,{children:"Select Single Machine Redisimplementation"}),"\n",(0,t.jsx)(n.h3,{id:"running-missing-designs-destroy-portability-and-how-can-users-be-made-simpler-to-assess-whether-they-can-transplant",children:'"Running missing" designs destroy portability and how can users be made simpler to assess whether they can transplant?'}),"\n",(0,t.jsx)(n.p,{children:"Providing a document, where each component of the document gives a different guarantee, feature, allowing users to assess themselves"}),"\n",(0,t.jsx)(n.p,{children:"Declares the feature option supported by the API in the sidecar configuration. If sidecar starts to discover that the component is not match, report an error on startup"}),"\n",(0,t.jsx)(n.p,{children:"C. Residecar running time logs, automatic statistical data on what features the app uses and log analysis when transplant is required"}),"\n",(0,t.jsx)(n.p,{children:"D. Profiling first"}),"\n",(0,t.jsx)(n.p,{children:"E. Providing a static analysis tool for automatic transplantation analysis"}),"\n",(0,t.jsx)(n.p,{children:"Conclusion\uff1aOption A because it is simple"}),"\n",(0,t.jsx)(n.h1,{id:"future-work",children:"Future work"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Remindable"}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"There will be some arithmetic logic.You need to consider whether all locks can be reentered by default, or add a feature to the upload."}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Block Lock"}),"\n",(0,t.jsx)(n.li,{children:"sequencer"}),"\n"]}),"\n",(0,t.jsx)(n.h1,{id:"reference",children:"Reference"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.a,{href:"https://martin.kleppmann.com/2016/02/08/how-to-do-distributed-locking.html",children:"How to do distressed blocking"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.a,{href:"https://static.googleusercontent.com/media/research.google.com/zh-TW//archive/chubby-osdi06.pdf",children:"The Chubby lock service for loosely-coupled distributed systems"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.a,{href:"https://www.jianshu.com/p/6e72eee5623",children:"https://www.jianshu.com/p/6e72e3eee5623"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.a,{href:"http://zhangtielei.com/posts/blog-redlock-reasoning.html",children:"http://zhangtielei.com/posts/blog-redlock-reasoning.html"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.a,{href:"http://zhangtielei.com/posts/blog-redlock-reasoning-part2.html",children:"http://zhangtielei.com/posts/blog-redlock-reasoning-part2.html"})})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>r,x:()=>l});var t=s(6540);const i={},o=t.createContext(i);function r(e){const n=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);
<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>Layotto Blog</title>
        <link>https://layotto.github.io/layotto/blog</link>
        <description>Layotto Blog</description>
        <lastBuildDate>Mon, 08 Jul 2024 02:29:46 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>zh-Hans</language>
        <item>
            <title><![CDATA[蚂蚁云原生应用运行时的探索和实践 - ArchSummit 上海]]></title>
            <link>https://layotto.github.io/layotto/blog/exploration-and-practice-of-antcloud-native-application-runtime-archsummit-shanghai</link>
            <guid>https://layotto.github.io/layotto/blog/exploration-and-practice-of-antcloud-native-application-runtime-archsummit-shanghai</guid>
            <pubDate>Mon, 08 Jul 2024 02:29:46 GMT</pubDate>
            <description><![CDATA[Mesh 模式的引入是实现应用云原生的关键路径，蚂蚁集团已在内部实现大规模落地。随着 Message、DB、Cache Mesh 等更多的中间件能力的下沉，从 Mesh 演进而来的应用运行时将是中间件技术的未来形态。应用运行时旨在帮助开发人员快速的构建云原生应用，帮助应用和基础设施进一步解耦，而应用运行时最核心是 API 标准，期望社区一起共建。]]></description>
            <content:encoded><![CDATA[<blockquote>
<p>Mesh 模式的引入是实现应用云原生的关键路径，蚂蚁集团已在内部实现大规模落地。随着 Message、DB、Cache Mesh 等更多的中间件能力的下沉，从 Mesh 演进而来的应用运行时将是中间件技术的未来形态。应用运行时旨在帮助开发人员快速的构建云原生应用，帮助应用和基础设施进一步解耦，而应用运行时最核心是 API 标准，期望社区一起共建。</p>
</blockquote>
<blockquote>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_1c90e8/afts/img/A*nergRo8-RI0AAAAAAAAAAAAAARQnAQ" alt="" class="img_ev3q"></p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="蚂蚁集团-mesh-化介绍">蚂蚁集团 Mesh 化介绍<a class="hash-link" aria-label="蚂蚁集团 Mesh 化介绍的直接链接" title="蚂蚁集团 Mesh 化介绍的直接链接" href="https://layotto.github.io/layotto/blog/exploration-and-practice-of-antcloud-native-application-runtime-archsummit-shanghai#%E8%9A%82%E8%9A%81%E9%9B%86%E5%9B%A2-mesh-%E5%8C%96%E4%BB%8B%E7%BB%8D">​</a></h2>
<p>蚂蚁是一家技术和创新驱动的公司，从最早淘宝里的一个支付应用，到现在服务
全球十二亿用户的大型公司，蚂蚁的技术架构演进大概会分为如下几个阶段：</p>
<p>2006 之前，最早的支付宝就是一个集中式的单体应用，不同的业务做了模块化的开发。</p>
<p>2007 年的时候，随着更多场景支付的推广，开始做了一下应用、数据的拆分，做了 SOA 化的一些改造。</p>
<p>2010 年之后，推出了快捷支付，移动支付，支撑双十一，还有余额宝等现象级产品，用户数到了亿这个级别，蚂蚁的应用数也数量级的增长，蚂蚁自研了很多全套的微服务中间件去支撑蚂蚁的业务；</p>
<p>2014 年，像借呗花呗、线下支付、更多场景更多业务形态的出现，对蚂蚁的可用性和稳定性提出更高的要求，蚂蚁对微服务中间件进行了 LDC 单元化的支持，支撑业务的异地多活，以及为了支撑双十一超大流量的混合云上的弹性扩缩容。</p>
<p>2018 年，蚂蚁的业务不仅仅是数字金融，还有数字生活、国际化等一些新战略的出现，促使我们要有更加高效的技术架构能让业务跑得更快更稳，所以蚂蚁结合业界比较流行的云原生的理念，在内部进行了 Service Mesh、Serverless、可信原生方向的一些落地。</p>
<blockquote>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_1c90e8/afts/img/A*KCSVTZWSf8wAAAAAAAAAAAAAARQnAQ" alt="" class="img_ev3q"></p>
</blockquote>
<p>可以看到蚂蚁的技术架构也是跟随公司的业务创新不断演进的，前面的从集中式到 SOA 再到微服务的过程，相信搞过微服务的同学都深有体会，而从微服务到云原生的实践是蚂蚁近几年自己探索出来的。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="为什么要引入-service-mesh">为什么要引入 Service Mesh<a class="hash-link" aria-label="为什么要引入 Service Mesh的直接链接" title="为什么要引入 Service Mesh的直接链接" href="https://layotto.github.io/layotto/blog/exploration-and-practice-of-antcloud-native-application-runtime-archsummit-shanghai#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E5%BC%95%E5%85%A5-service-mesh">​</a></h2>
<p>蚂蚁既然有一套完整的微服务治理中间件，那为什么还需要引入 Service Mesh 呢？</p>
<blockquote>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_1c90e8/afts/img/A*Sq7oR6eO2QAAAAAAAAAAAAAAARQnAQ" alt="" class="img_ev3q"></p>
</blockquote>
<p>拿蚂蚁自研的服务框架 SOFARPC 为例，它是一个功能强大的 SDK，包含了服务发现、路由、熔断限流等一系列能力。在一个基本的 SOFA(Java) 应用里，业务代码集成了 SOFARPC 的 SDK，两者在一个进程里运行。在蚂蚁的大规模落地微服务之后，我们就面临了如下的一些问题：</p>
<p><strong>升级成本高</strong>：SDK 是需要业务代码引入的，每次的升级都需要应用修改代码进行发布。由于应用规模较大，在一些大的技术变更或者安全问题修复的时候。每次需要数千个应用一起升级，费时费力。
<strong>版本碎片化</strong>：由于升级成本高，SDK 版本碎片化严重，这就导致我们写代码的时候需要兼容历史逻辑，整体技术演进困难。
<strong>跨语言无法治理</strong>：蚂蚁的中后台在线应用大多使用 Java 作为技术栈，但是在前台、AI、大数据等领域有很多的跨语言应用，例如 C++/Python/Golang 等等，由于没有对应语言的 SDK，他们的服务治理能力其实是缺失的。</p>
<p>我们注意到云原生里有 Service Mesh 一些理念开始出现，所以开始往这个方向探索。在 Service Mesh 的理念里，有两个概念，一个是 Control Plane 控制平面，一个是 Data Plane 数据平面。控制面这里暂时不展开，其中数据平面的核心思想就是解耦，将一些业务无需关系的复杂逻辑（如 RPC 调用里的服务发现、服务路由、熔断限流、安全）抽象到一个独立进程里去。只要保持业务和独立进程的通信协议不变，这些能力的演进可以跟随这个独立的进程自主升级，整个 Mesh 就可以做到统一演进。而我们的跨语言应用，只要流量是经过我们的 Data Plane 的，都可以享受到刚才提到的各种服务治理相关的能力，应用对底层的基础设施能力是透明的，真正的云原生的。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="蚂蚁-mesh-落地过程">蚂蚁 Mesh 落地过程<a class="hash-link" aria-label="蚂蚁 Mesh 落地过程的直接链接" title="蚂蚁 Mesh 落地过程的直接链接" href="https://layotto.github.io/layotto/blog/exploration-and-practice-of-antcloud-native-application-runtime-archsummit-shanghai#%E8%9A%82%E8%9A%81-mesh-%E8%90%BD%E5%9C%B0%E8%BF%87%E7%A8%8B">​</a></h2>
<p>所以从 2017 年底开始，蚂蚁就开始探索 Service Mesh 的技术方向，并提出了 基础设施统一，业务无感升级 的愿景。主要的里程碑就是：</p>
<p>2017 年底开始技术预研 Service Mesh 技术，并确定为未来发展方向；</p>
<p>2018 年初开始用 Golang 自研 Sidecar MOSN 并开源，主要支持 RPC 在双十一小范围试点；</p>
<p>2019 年 618，新增 Message Mesh 和 DB Mesh 的形态，覆盖若干核心链路，支撑 618 大促；</p>
<p>2019 年双十一，覆盖了所有大促核心链路几百个应用，支撑当时的双十一大促；</p>
<p>2020 年双十一，全站超过 80% 的在线应用接入了 Mesh 化，整套 Mesh 体系也具备了 2 个月从能力开发到全站升级完成的能力。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="蚂蚁-mesh-落地架构">蚂蚁 Mesh 落地架构<a class="hash-link" aria-label="蚂蚁 Mesh 落地架构的直接链接" title="蚂蚁 Mesh 落地架构的直接链接" href="https://layotto.github.io/layotto/blog/exploration-and-practice-of-antcloud-native-application-runtime-archsummit-shanghai#%E8%9A%82%E8%9A%81-mesh-%E8%90%BD%E5%9C%B0%E6%9E%B6%E6%9E%84">​</a></h2>
<p>目前 Mesh 化在蚂蚁落地规模是应用约数千个，容器数十万的级别，这个规模的落地，在业界是数一数二的，根本就没有前人的路可以学习，所以蚂蚁在落地过程中，也建设一套完整的研发运维体系去支撑蚂蚁的 Mesh 化。</p>
<blockquote>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_1c90e8/afts/img/A*eAlMT7SMTpMAAAAAAAAAAAAAARQnAQ" alt="" class="img_ev3q"></p>
</blockquote>
<p>蚂蚁 Mesh 架构大概如图所示，底下是我们的控制平面，里面部署了服务治理中心、PaaS、监控中心等平台的服务端，都是现有的一些产品。还有就是我们的运维体系，包括研发平台和 PaaS 平台。那中间是我们的主角数据平面 MOSN，里面管理了 RPC、消息、MVC、任务四种流量，还有健康检查、监控、配置、安全、技术风险都下沉的基础能力，同时 MOSN 也屏蔽了业务和基础平台的一些交互。DBMesh 在蚂蚁是一个独立的产品，图里就没画出来。然后最上层是我们的一些应用，目前支持 Java、Nodejs 等多种语言的接入。
对应用来说，Mesh 虽然能做到基础设施解耦，但是接入还是需要一次额外的升级成本，所以为了推进应用的接入，蚂蚁做了整个研发运维流程的打通，包括在现有框架上做最简化的接入，通过分批推进把控风险和进度，让新应用默认接入 Mesh 化等一些事情。</p>
<p>同时随着下沉能力的越来越多，各个能力之前也面临了研发协作的一些问题，甚至互相影响性能和稳定性的问题，所以对于 Mesh 自身的研发效能，我们也做了一下模块化隔离、新能力动态插拔、自动回归等改进，目前一个下沉能力从开发到全站推广完成可以在 2 个月内完成。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="云原生应用运行时上的探索">云原生应用运行时上的探索<a class="hash-link" aria-label="云原生应用运行时上的探索的直接链接" title="云原生应用运行时上的探索的直接链接" href="https://layotto.github.io/layotto/blog/exploration-and-practice-of-antcloud-native-application-runtime-archsummit-shanghai#%E4%BA%91%E5%8E%9F%E7%94%9F%E5%BA%94%E7%94%A8%E8%BF%90%E8%A1%8C%E6%97%B6%E4%B8%8A%E7%9A%84%E6%8E%A2%E7%B4%A2">​</a></h2>
<p><strong>大规模落地后的新问题与思考</strong></p>
<p>蚂蚁 Mesh 大规模落地之后，目前我们遇到了一些新的问题：
跨语言 SDK 的维护成本高：拿 RPC 举例，大部分逻辑已经下沉到了 MOSN 里，但是还有一部分通信编解码协议的逻辑是在 Java 的一个轻量级 SDK 里的，这个 SDK 还是有一定的维护成本的，有多少个语言就有多少个轻量级 SDK，一个团队不可能有精通所有语言的研发，所以这个轻量级 SDK 的代码质量就是一个问题。</p>
<p>业务兼容不同环境的新场景：蚂蚁的一部分应用是既部署在蚂蚁内部，也对外输出到金融机构的。当它们部署到蚂蚁时，对接的是蚂蚁的控制面，当对接到银行的时候，对接的是银行已有的控制面。目前大多数应用的做法是自己在代码里封装一层，遇到不支持的组件就临时支持对接一下。</p>
<p>从 Service Mesh 到 Multi-Mesh：蚂蚁最早的场景是 Service Mesh，MOSN 通过网络连接代理的方式进行了流量拦截，其它的中间件都是通过原始的 SDK 与服务端进行交互。而现在的 MOSN 已经不仅仅是 Service Mesh 了，而是 Multi-Mesh，因为除了 RPC，我们还支持了更多中间件的 Mesh 化落地，包括消息、配置、缓存的等等。可以看到每个下沉的中间件，在应用侧几乎都有一个对应的轻量级 SDK 存在，这个在结合刚才的第一问题，就发现有非常多的轻量级 SDK 需要维护。为了保持功能不互相影响，每个功能它们开启不同的端口，通过不同的协议去和 MOSN 进行调用。例如 RPC 用的 RPC 协议，消息用的 MQ 协议，缓存用的 Redis 协议。然后现在的 MOSN 其实也不仅仅是面向流量了，例如配置就是暴露了一下 API 给业务代码去使用。</p>
<blockquote>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_1c90e8/afts/img/A*80o8SYwyHJoAAAAAAAAAAAAAARQnAQ" alt="" class="img_ev3q"></p>
</blockquote>
<p>为了解决刚才的问题和场景，我们就在思考如下的几个点：</p>
<p>1.不同中间件、不同语言的 SDK 能否风格统一？</p>
<p>2.各个下沉能力的交互协议能否统一？</p>
<p>3.我们的中间件下沉是面向组件还是面向能力？</p>
<p>4.底层的实现是否可以替换？</p>
<blockquote>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_1c90e8/afts/img/A*hsZBQJg0VnoAAAAAAAAAAAAAARQnAQ" alt="" class="img_ev3q"></p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="蚂蚁云原生应用运行时架构">蚂蚁云原生应用运行时架构<a class="hash-link" aria-label="蚂蚁云原生应用运行时架构的直接链接" title="蚂蚁云原生应用运行时架构的直接链接" href="https://layotto.github.io/layotto/blog/exploration-and-practice-of-antcloud-native-application-runtime-archsummit-shanghai#%E8%9A%82%E8%9A%81%E4%BA%91%E5%8E%9F%E7%94%9F%E5%BA%94%E7%94%A8%E8%BF%90%E8%A1%8C%E6%97%B6%E6%9E%B6%E6%9E%84">​</a></h2>
<p>从去年的 3 月份开始，经过内部的多轮讨论，以及对业界一些新理念的调研，我们提出了一个“云原生应用运行时”（下称运行时）的概念。顾名思义，我们希望这个运行时能够包含应用所关心的所有分布式能力，帮助开发人员快速的构建云原生应用，帮助应用和基础设施进一步解耦！</p>
<blockquote>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_1c90e8/afts/img/A*iqQoTYAma4YAAAAAAAAAAAAAARQnAQ" alt="" class="img_ev3q"></p>
</blockquote>
<p>云原生应用运行时设计里核心的几个点如下：</p>
<p><strong>第一</strong>，由于有了 MOSN 规模化落地的经验和配套的运维体系，我们决定基于 MOSN 内核去开发我们的云原生应用运行时。</p>
<p><strong>第二</strong>，面向能力，而不是面向组件，统一定义出这个运行时的 API 能力。</p>
<p><strong>第三</strong>，业务代码和 Runtime API 之间的交互采用统一的 gRPC 协议，这样的话，业务端侧可以直接通过 proto 文件去反向生成一个客户端，直接进行调用。</p>
<p><strong>第四</strong>，能力后面对应的组件实现是可以替换的，例如注册服务的提供者可以是 SOFARegistry，也可以是 Nacos 或者 Zookeeper。</p>
<p><strong>运行时能力抽象</strong></p>
<blockquote>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_1c90e8/afts/img/A*hWIVR6ccduYAAAAAAAAAAAAAARQnAQ" alt="" class="img_ev3q"></p>
</blockquote>
<p>为了抽象出云原生应用最需要的一些能力，我们先定了几个原则：</p>
<p>1.关注分布式应用所需的 API 和场景而不是组件；
2.API 符合直觉，开箱即用，约定优于配置；
3.API 不绑定实现，实现差异化使用扩展字段。</p>
<p>有了原则之后，我们就抽象出了三组 API，分别是应用调用运行时的 mosn.proto，运行时调用应用的 appcallback.proto，运行时运维相关的 actuator.proto。例如 RPC 调用、发消息、读缓存、读配置这些都属于应用到运行时的，而 RPC  收请求、收消息、接收任务调度这些属于运行时调应用的，其它监控检查、组件管理、流量控制这些则属于运行时运维相关的。</p>
<p>这三个 proto 的示例可以看下图：</p>
<blockquote>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_1c90e8/afts/img/A*J76nQoLLYWgAAAAAAAAAAAAAARQnAQ" alt="" class="img_ev3q"></p>
</blockquote>
<p><strong>运行时组件管控</strong></p>
<p>另外一方面，为了实现运行时的实现可替换，我们也在 MOSN 提了两个概念，我们把一个个分布式能力称为 Service，然后有不同的 Component 去实现这个 Service，一个 Service 可以有多个组件实现它，一个组件可以实现多个 Service。例如图里的示例就是有“MQ-pub” 这个发消息的 Service 有 SOFAMQ 和 Kafka 两个 Component 去实现，而 Kafka Component 则实现了发消息和健康检查两个 Service。
当业务真正通过 gRPC 生成的客户端发起请求的时候，数据就会通过 gRPC 协议发送给 Runtime，并且分发到后面一个具体的实现上去。这样的话，应用只需要使用同一套 API，通过请求里的参数或者运行时的配置，就对接到不同的实现。</p>
<blockquote>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_1c90e8/afts/img/A*dK9rRLTvtlMAAAAAAAAAAAAAARQnAQ" alt="" class="img_ev3q"></p>
</blockquote>
<p><strong>运行时和 Mesh 的对比</strong></p>
<p>综上所述， 云原生应用运行时和刚才 Mesh 简单对比如下：</p>
<blockquote>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_1c90e8/afts/img/A*xyu9T74SD9MAAAAAAAAAAAAAARQnAQ" alt="" class="img_ev3q"></p>
</blockquote>
<p>云原生应用运行时落地场景
从去年中开始研发，运行时目前在蚂蚁内部主要落地了下面几个场景。</p>
<p><strong>异构技术栈接入</strong></p>
<blockquote>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_1c90e8/afts/img/A*8UJhRbBg3zsAAAAAAAAAAAAAARQnAQ" alt="" class="img_ev3q"></p>
</blockquote>
<p>在蚂蚁，不同的语言的应用除了 RPC 服务治理、消息等的需求之外，还希望使用上蚂蚁统一的中间件等基础设施能力，Java 和 Nodejs 是有对应的 SDK 的，而其他语言是没有的对应的 SDK 的。有了应用运行时之后，这些异构语言就可以直接通过 gRPC Client 调用运行时，对接上蚂蚁的基础设施。</p>
<p><strong>解除厂商绑定</strong></p>
<blockquote>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_1c90e8/afts/img/A*eVoqRbkTFFwAAAAAAAAAAAAAARQnAQ" alt="" class="img_ev3q"></p>
</blockquote>
<p>刚才提到，蚂蚁的区块链、风控、智能客服、金融中台等等业务是既在主站部署，又有阿里云或者专有云部署的场景。有了运行时之后，应用可以一套代码和运行时一起出一个镜像，通过配置去决定调用哪个底层的实现，不跟具体的实现绑定。例如在蚂蚁内部对接的是 SOFARegistry 和 SOFAMQ 等产品，而到云上对接的是 Nacos、RocketMQ 等产品，到专有云对接的又是 Zookeeper、Kafka 等。这个场景我们正在落地当中。当然这个也可以用在遗留系统治理上，例如从 SOFAMQ 1.0 升级到 SOFAMQ 2.0，接了运行时的应用也无需升级。</p>
<p><strong>FaaS 冷启预热池</strong></p>
<p>FaaS 冷启预热池也是我们近期在探索的一个场景，大家知道 FaaS 里的 Function 在冷启的时候，是需要从创建 Pod 到下载 Function 再到启动的，这个过程会比较长。有了运行时之后，我们可以提前把 Pod 创建出来并启动好运行时，等到应用启动的时候其实已经非常简单的应用逻辑了，经过测试发现可以将从 5s 缩短 80% 到 1s。这个方向我们还会持续探索当中。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="规划和展望">规划和展望<a class="hash-link" aria-label="规划和展望的直接链接" title="规划和展望的直接链接" href="https://layotto.github.io/layotto/blog/exploration-and-practice-of-antcloud-native-application-runtime-archsummit-shanghai#%E8%A7%84%E5%88%92%E5%92%8C%E5%B1%95%E6%9C%9B">​</a></h2>
<p><strong>API 共建</strong></p>
<p>运行时里最主要的一部分就是 API 的定义，为了落地内部，我们已经有一套较为完整的 API，但是我们也看到业界的很多产品有类似的诉求，例如 dapr、envoy 等等。所以接下来我们会去做的一件事情就是联合各个社区去推出一套大家都认可的云原生应用 API。</p>
<blockquote>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_1c90e8/afts/img/A*d2BORogVotoAAAAAAAAAAAAAARQnAQ" alt="" class="img_ev3q"></p>
</blockquote>
<p><strong>持续开源</strong></p>
<p>另外我们近期也会将内部的运行时实践逐步开发出来，预计五六月份会发布 0.1 版本，并保持每月发布一个小版本的节奏，争取年底之前发布 1.0 版本。</p>
<blockquote>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_1c90e8/afts/img/A*Kgr9QLc5TH4AAAAAAAAAAAAAARQnAQ" alt="" class="img_ev3q"></p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a class="hash-link" aria-label="总结的直接链接" title="总结的直接链接" href="https://layotto.github.io/layotto/blog/exploration-and-practice-of-antcloud-native-application-runtime-archsummit-shanghai#%E6%80%BB%E7%BB%93">​</a></h2>
<p><strong>最后做一下小结：</strong></p>
<p>1.Service Mesh 模式的引入是实现应用原云生的关键路径；</p>
<p>2.任何中间件兼可 Mesh 化，但研发效率问题依然部分存在；</p>
<p>3.Mesh 大规模落地是工程化的事情，需要完整的配套体系；</p>
<p>4.云原生应用运行时将是中间件等基础技术的未来形态，进一步解耦应用与分布式能力；</p>
<p>5.云原生应用运行时核心是 API，期望社区共建一个标准。</p>
<p>延伸阅读</p>
<ul>
<li>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzUzMzU5Mjc1Nw==&amp;mid=2247488044&amp;idx=1&amp;sn=ef6300d4b451723aa5001cd3deb17fbc&amp;chksm=faa0fdf6cdd774e03ccd9130099674720a81e7e109ecf810af147e08778c6582636769646490&amp;scene=21" target="_blank" rel="noopener noreferrer">带你走进云原生技术：云原生开放运维体系探索和实践</a></p>
</li>
<li>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzUzMzU5Mjc1Nw==&amp;mid=2247487717&amp;idx=1&amp;sn=ca9452cdc10989f61afbac2f012ed712&amp;chksm=faa0ff3fcdd77629d8e5c8f6c42af3b4ea227ee3da3d5cdf297b970f51d18b8b1580aac786c3&amp;scene=21" target="_blank" rel="noopener noreferrer">积跬步至千里：QUIC 协议在蚂蚁集团落地之综述</a></p>
</li>
<li>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzUzMzU5Mjc1Nw==&amp;mid=2247487576&amp;idx=1&amp;sn=0d0575395476db930dab4e0f75e863e5&amp;chksm=faa0ff82cdd77694a6fc42e47d6f20c20310b26cedc13f104f979acd1f02eb5a37ea9cdc8ea5&amp;scene=21" target="_blank" rel="noopener noreferrer">Rust 大展拳脚的新兴领域：机密计算</a></p>
</li>
<li>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzUzMzU5Mjc1Nw==&amp;mid=2247487546&amp;idx=1&amp;sn=72c3f1ede27ca4ace7988e11ca20d5f9&amp;chksm=faa0ffe0cdd776f6d17323466b500acee50a371663f18da34d8e4cbe32304d7681cf58ff9b45&amp;scene=21" target="_blank" rel="noopener noreferrer">Protocol Extension Base On Wasm——协议扩展篇</a></p>
</li>
</ul>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[源码解析 4层流量治理，tcp流量dump]]></title>
            <link>https://layotto.github.io/layotto/blog/tcpcopy_code_analyze</link>
            <guid>https://layotto.github.io/layotto/blog/tcpcopy_code_analyze</guid>
            <pubDate>Mon, 08 Jul 2024 02:29:46 GMT</pubDate>
            <description><![CDATA[作者简介：]]></description>
            <content:encoded><![CDATA[<blockquote>
<p>作者简介：
龚中强，是开源社区的爱好者，致力于拥抱开源。</p>
<p>写作时间: 2022年4月26日</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a class="hash-link" aria-label="Overview的直接链接" title="Overview的直接链接" href="https://layotto.github.io/layotto/blog/tcpcopy_code_analyze#overview">​</a></h2>
<p>此文档的目的在于分析 tcp 流量 dump 的实现</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="前提">前提：<a class="hash-link" aria-label="前提：的直接链接" title="前提：的直接链接" href="https://layotto.github.io/layotto/blog/tcpcopy_code_analyze#%E5%89%8D%E6%8F%90">​</a></h2>
<p>文档内容所涉及代码版本如下</p>
<p><a href="https://github.com/mosn/layotto" target="_blank" rel="noopener noreferrer">https://github.com/mosn/layotto</a></p>
<p>Layotto   0e97e970dc504e0298017bd956d2841c44c0810b（main分支）</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="源码分析">源码分析<a class="hash-link" aria-label="源码分析的直接链接" title="源码分析的直接链接" href="https://layotto.github.io/layotto/blog/tcpcopy_code_analyze#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="代码均在-tcpcopy代码">代码均在： <a href="https://github.com/mosn/layotto/tree/main/pkg/filter/network/tcpcopy" target="_blank" rel="noopener noreferrer">tcpcopy代码</a><a class="hash-link" aria-label="代码均在-tcpcopy代码的直接链接" title="代码均在-tcpcopy代码的直接链接" href="https://layotto.github.io/layotto/blog/tcpcopy_code_analyze#%E4%BB%A3%E7%A0%81%E5%9D%87%E5%9C%A8-tcpcopy%E4%BB%A3%E7%A0%81">​</a></h3>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="modelgo分析">model.go分析<a class="hash-link" aria-label="model.go分析的直接链接" title="model.go分析的直接链接" href="https://layotto.github.io/layotto/blog/tcpcopy_code_analyze#modelgo%E5%88%86%E6%9E%90">​</a></h3>
<p>此类是 tcpcopy 的配置对象的核心类</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> DumpConfig </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Switch     </span><span class="token builtin">string</span><span class="token plain">  </span><span class="token string" style="color:#e3116c">`json:"switch"`</span><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">// dump 开关.配置值：'ON' 或 'OFF'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Interval   </span><span class="token builtin">int</span><span class="token plain">     </span><span class="token string" style="color:#e3116c">`json:"interval"`</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">// dump 采样间隔， 单位: 秒</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Duration   </span><span class="token builtin">int</span><span class="token plain">     </span><span class="token string" style="color:#e3116c">`json:"duration"`</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">// 单个采样周期， 单位: 秒</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	CpuMaxRate </span><span class="token builtin">float64</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`json:"cpu_max_rate"`</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// cpu 最大使用率。当超过此阈值,dump 功能将停止</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	MemMaxRate </span><span class="token builtin">float64</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`json:"mem_max_rate"`</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// mem 最大使用率。当超过此阈值,dump 功能将停止</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> DumpUploadDynamicConfig </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Unique_sample_window </span><span class="token builtin">string</span><span class="token plain">             </span><span class="token comment" style="color:#999988;font-style:italic">// 指定采样窗口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	BusinessType         _type</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BusinessType </span><span class="token comment" style="color:#999988;font-style:italic">// 业务类型</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Port                 </span><span class="token builtin">string</span><span class="token plain">             </span><span class="token comment" style="color:#999988;font-style:italic">// 端口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Binary_flow_data     </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">byte</span><span class="token plain">             </span><span class="token comment" style="color:#999988;font-style:italic">// 二进制数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Portrait_data        </span><span class="token builtin">string</span><span class="token plain">             </span><span class="token comment" style="color:#999988;font-style:italic">// 用户上传的数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="persistencego分析">persistence.go分析<a class="hash-link" aria-label="persistence.go分析的直接链接" title="persistence.go分析的直接链接" href="https://layotto.github.io/layotto/blog/tcpcopy_code_analyze#persistencego%E5%88%86%E6%9E%90">​</a></h3>
<p>此类是 tcpcopy 的 dump 持久化核心处理类</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 该方法在 tcpcopy.go 中 OnData 中调用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">IsPersistence</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">bool</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 判断 dump 开关是否开启</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">strategy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DumpSwitch </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetLogLevel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DEBUG </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Debugf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"%s the dump switch is %t"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">LogDumpKey</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> strategy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DumpSwitch</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 判断是否在采样窗口中</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> atomic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">LoadInt32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">strategy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DumpSampleFlag</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetLogLevel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DEBUG </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Debugf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"%s the dump sample flag is %d"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">LogDumpKey</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> strategy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DumpSampleFlag</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 判断是否 dump 功能停止（获取系统负载判断处理器和内存是否超过 tcpcopy 的阈值，如果超过则停止）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">strategy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">IsAvaliable</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetLogLevel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DEBUG </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Debugf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"%s the system usages are beyond max rate."</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">LogDumpKey</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 根据配置信息持久化数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">persistence</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DumpUploadDynamicConfig</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 1.持久化二进制数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Binary_flow_data </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Port </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetTcpcopyLogger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetLogLevel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">INFO </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token function" style="color:#d73a49">GetTcpcopyLogger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Infof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"[%s][%s]% x"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Unique_sample_window</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Port</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Binary_flow_data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Portrait_data </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BusinessType </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// 2. 持久化用户定义的数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetPortraitDataLogger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetLogLevel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">INFO </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token function" style="color:#d73a49">GetPortraitDataLogger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Infof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"[%s][%s][%s]%s"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Unique_sample_window</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">BusinessType</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Port</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Portrait_data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// 3. 增量持久化内存中的配置信息的变动内容</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		buf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> configmanager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">DumpJSON</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetLogLevel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DEBUG </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Debugf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"[dump] Failed to load mosn config mem."</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// 3.1. 如果数据变化则 dump </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		tmpMd5ValueOfMemDump </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> common</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">CalculateMd5ForBytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		memLogger </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetMemLogger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> tmpMd5ValueOfMemDump </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> md5ValueOfMemDump </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tmpMd5ValueOfMemDump </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> md5ValueOfMemDump </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> common</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetFileSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">getMemConfDumpFilePath</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			md5ValueOfMemDump </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tmpMd5ValueOfMemDump</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> memLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetLogLevel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">INFO </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				memLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Infof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"[%s]%s"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Unique_sample_window</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> buf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> memLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetLogLevel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">INFO </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				memLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Infof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"[%s]%+v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Unique_sample_window</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> incrementLog</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tcpcopygo分析">tcpcopy.go分析<a class="hash-link" aria-label="tcpcopy.go分析的直接链接" title="tcpcopy.go分析的直接链接" href="https://layotto.github.io/layotto/blog/tcpcopy_code_analyze#tcpcopygo%E5%88%86%E6%9E%90">​</a></h3>
<p>此类为是 tcpcopy 的核心类。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 向 Mosn 注册 NetWork </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">RegisterNetwork</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"tcpcopy"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> CreateTcpcopyFactory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 返回 tcpcopy 工厂</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CreateTcpcopyFactory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cfg </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">NetworkFilterChainFactory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	tcpConfig </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// dump 策略转静态配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> stg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ok </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> cfg</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">"strategy"</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> ok </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// TODO extract some other fields</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">tcpcopyFactory</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		cfg</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> tcpConfig</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 供 pkg/configmanager/parser.go 调用添加或者更新Network filter factory</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">tcpcopyFactory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">param </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 设置监听的地址和端口配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 实现的是 ReadFilter 的 OnData 接口，每次从连接拿到数据都进方法进行处理</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">tcpcopyFactory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">OnData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IoBuffer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">res api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FilterStatus</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 判断当前请求数据是否需要采样 dump </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">persistence</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">IsPersistence</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 异步的采样 dump</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	config </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewDumpUploadDynamicConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">strategy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DumpSampleUuid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cfg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">port</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Bytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	persistence</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetDumpWorkPoolInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Schedule</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>最后我们再来回顾一下整体流程走向:</p>
<ol>
<li>
<p>从 tcpcopy.go 的初始化函数init() 开始,程序向 CreateGRPCServerFilterFactory 传入 CreateTcpcopyFactory.</p>
</li>
<li>
<p>Mosn 创建出一个filter chain(代码位置<a href="https://github.com/mosn/mosn/tree/master/pkg/filter/network/proxy/factory.go" target="_blank" rel="noopener noreferrer">factory.go</a>) ,通过循环调用CreateFilterChain将所有的filter加入到链路结构包括本文的 tcpcopy.</p>
</li>
<li>
<p>当流量通过 mosn 将会进入到 tcpcopy.go 的 OnData 方法进行 tcpdump 的逻辑处理.</p>
</li>
</ol>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[MOSN 子项目 Layotto：开启服务网格+应用运行时新篇章]]></title>
            <link>https://layotto.github.io/layotto/blog/mosn-subproject-layotto-opening-a-new-chapter-in-service-grid-application-runtime</link>
            <guid>https://layotto.github.io/layotto/blog/mosn-subproject-layotto-opening-a-new-chapter-in-service-grid-application-runtime</guid>
            <pubDate>Mon, 08 Jul 2024 02:29:46 GMT</pubDate>
            <description><![CDATA[作者简介：]]></description>
            <content:encoded><![CDATA[<blockquote>
<p>作者简介：
马振军，花名古今，在基础架构领域耕耘多年，对 Service Mesh 有深度实践经验，目前在蚂蚁集团中间件团队负责 MOSN、Layotto 等项目的开发工作。
Layotto 官方 GitHub 地址:<a href="https://github.com/mosn/layotto" target="_blank" rel="noopener noreferrer">https://github.com/mosn/layotto</a></p>
</blockquote>
<p>点击链接即可观看现场视频：<a href="https://www.bilibili.com/video/BV1hq4y1L7FY/" target="_blank" rel="noopener noreferrer">https://www.bilibili.com/video/BV1hq4y1L7FY/</a></p>
<p>Service Mesh 在微服务领域已经非常流行，越来越多的公司开始在内部落地，蚂蚁从 Service Mesh 刚出现的时候开始，就一直在这个方向上大力投入，到目前为止，内部的 Mesh 方案已经覆盖数千个应用、数十万容器并且经过了多次大促考验，Service Mesh 带来的业务解耦，平滑升级等优势大大提高了中间件的迭代效率。</p>
<p>在大规模落地以后，我们又遇到了新的问题，本文主要对 Service Mesh 在蚂蚁内部落地情况进行回顾总结，并分享对 Service Mesh 落地后遇到的新问题的解决方案。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="一service-mesh-回顾与总结">一、Service Mesh 回顾与总结<a class="hash-link" aria-label="一、Service Mesh 回顾与总结的直接链接" title="一、Service Mesh 回顾与总结的直接链接" href="https://layotto.github.io/layotto/blog/mosn-subproject-layotto-opening-a-new-chapter-in-service-grid-application-runtime#%E4%B8%80service-mesh-%E5%9B%9E%E9%A1%BE%E4%B8%8E%E6%80%BB%E7%BB%93">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="aservice-mesh-的初衷">A、Service Mesh 的初衷<a class="hash-link" aria-label="A、Service Mesh 的初衷的直接链接" title="A、Service Mesh 的初衷的直接链接" href="https://layotto.github.io/layotto/blog/mosn-subproject-layotto-opening-a-new-chapter-in-service-grid-application-runtime#aservice-mesh-%E7%9A%84%E5%88%9D%E8%A1%B7">​</a></h3>
<blockquote>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_1c90e8/afts/img/A*p8tGTbpLRegAAAAAAAAAAAAAARQnAQ" alt="" class="img_ev3q">
在微服务架构下，基础架构团队一般会为应用提供一个封装了各种服务治理能力的 SDK，这种做法虽然保障了应用的正常运行，但缺点也非常明显，每次基础架构团队迭代一个新功能都需要业务方参与升级才能使用，尤其是 bugfix 版本，往往需要强推业务方升级，这里面的痛苦程度每一个基础架构团队成员都深有体会。</p>
</blockquote>
<p>伴随着升级的困难，随之而来的就是应用使用的 SDK 版本差别非常大，生产环境同时跑着各种版本的 SDK，这种现象又会让新功能的迭代必须考虑各种兼容，就好像带着枷锁前进一般，这样随着不断迭代，会让代码维护非常困难，有些祖传逻辑更是一不小心就会掉坑里。</p>
<p>同时这种“重”SDK 的开发模式，导致异构语言的治理能力非常薄弱，如果想为各种编程语言都提供一个功能完整且能持续迭代的 SDK 其中的成本可想而知。</p>
<p>18 年的时候，Service Mesh 在国内持续火爆，这种架构理念旨在把服务治理能力跟业务解耦，让两者通过进程级别的通信方式进行交互。在这种架构模式下，服务治理能力从应用中剥离，运行在独立的进程中，迭代升级跟业务进程无关，这就可以让各种服务治理能力快速迭代，并且由于升级成本低，因此每个版本都可以全部升级，解决了历史包袱问题，同时 SDK 变“轻”直接降低了异构语言的治理门槛，再也不用为需要给各个语言开发相同服务治理能力的 SDK 头疼了。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="bservice-mesh-落地现状">B、Service Mesh 落地现状<a class="hash-link" aria-label="B、Service Mesh 落地现状的直接链接" title="B、Service Mesh 落地现状的直接链接" href="https://layotto.github.io/layotto/blog/mosn-subproject-layotto-opening-a-new-chapter-in-service-grid-application-runtime#bservice-mesh-%E8%90%BD%E5%9C%B0%E7%8E%B0%E7%8A%B6">​</a></h3>
<blockquote>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_1c90e8/afts/img/A*rRG_TYlHMqYAAAAAAAAAAAAAARQnAQ" alt="" class="img_ev3q">
蚂蚁很快意识到了 Service Mesh 的价值，全力投入到这个方向，用 Go 语言开发了 MOSN 这样可以对标 envoy 的优秀数据面，全权负责服务路由，负载均衡，熔断限流等能力的建设，大大加快了公司内部落地 Service Mesh 的进度。</p>
</blockquote>
<p>现在 MOSN 在蚂蚁内部已经覆盖了数千个应用、数十万容器，新创建的应用默认接入 MOSN，形成闭环。而且在大家最关心的资源占用、性能损耗方面 MOSN 也交出了一份让人满意的答卷：</p>
<ol>
<li>
<p>RT 小于 0.2ms</p>
</li>
<li>
<p>CPU 占用增加 0%~2%</p>
</li>
<li>
<p>内存消耗增长小于 15M</p>
</li>
</ol>
<p>由于 Service Mesh 降低了异构语言的服务治理门槛，NodeJS、C++等异构技术栈也在持续接入到 MOSN 中。</p>
<p>在看到 RPC 能力 Mesh 化带来的巨大收益之后，蚂蚁内部还把 MQ，Cache，Config 等中间件能力都进行了 Mesh 化改造，下沉到 MOSN，提高了中间件产品整体的迭代效率。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="c新的挑战">C、新的挑战<a class="hash-link" aria-label="C、新的挑战的直接链接" title="C、新的挑战的直接链接" href="https://layotto.github.io/layotto/blog/mosn-subproject-layotto-opening-a-new-chapter-in-service-grid-application-runtime#c%E6%96%B0%E7%9A%84%E6%8C%91%E6%88%98">​</a></h3>
<ol>
<li>应用跟基础设施强绑定</li>
</ol>
<blockquote>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_1c90e8/afts/img/A*nKxcTKLp4EoAAAAAAAAAAAAAARQnAQ" alt="" class="img_ev3q">
一个现代分布式应用，往往会同时依赖 RPC、Cache、MQ、Config 等各种分布式能力来完成业务逻辑的处理。</p>
</blockquote>
<p>当初看到 RPC 下沉的红利以后，其他各种能力也都快速下沉。初期，大家都会以自己最熟悉的方式来开发，这就导致没有统一的规划管理，如上图所示，应用依赖了各种基础设施的 SDK，而每种 SDK 又以自己特有的方式跟 MOSN 进行交互，使用的往往都是由原生基础设施提供的私有协议，这直接导致了复杂的中间件能力虽然下沉，但应用本质上还是被绑定到了基础设施，比如想把缓存从 Redis 迁移到 Memcache 的话，仍旧需要业务方升级 SDK，这种问题在应用上云的大趋势下表现的更为突出，试想一下，如果一个应用要部署在云上，由于该应用依赖了各种基础设施，势必要先把整个基础设施搬到云上才能让应用顺利部署，这其中的成本可想而知。
因此如何让应用跟基础设施解绑，使其具备可移植能力，能够无感知跨平台部署是我们面临的第一个问题。</p>
<ol start="2">
<li>异构语言接入成本高</li>
</ol>
<blockquote>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_1c90e8/afts/img/A*oIdQQZmgtyUAAAAAAAAAAAAAARQnAQ" alt="" class="img_ev3q">
事实证明 Service Mesh 确实降低了异构语言的接入门槛，但在越来越多的基础能力下沉到 MOSN 以后，我们逐渐意识到为了让应用跟 MOSN 交互，各种 SDK 里都需要对通信协议，序列化协议进行开发，如果再加上需要对各种异构语言都提供相同的功能，那维护难度就会成倍上涨，</p>
</blockquote>
<p>Service Mesh 让重 SDK 成为了历史，但对于现在各种编程语言百花齐放、各种应用又强依赖基础设施的场景来说，我们发现现有的 SDK 还不够薄，异构语言接入的门槛还不够低，如何进一步降低异构语言的接入门槛是我们面临的第二个问题。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="二multi-runtime-理论概述">二、Multi Runtime 理论概述<a class="hash-link" aria-label="二、Multi Runtime 理论概述的直接链接" title="二、Multi Runtime 理论概述的直接链接" href="https://layotto.github.io/layotto/blog/mosn-subproject-layotto-opening-a-new-chapter-in-service-grid-application-runtime#%E4%BA%8Cmulti-runtime-%E7%90%86%E8%AE%BA%E6%A6%82%E8%BF%B0">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="a什么是-runtime">A、什么是 Runtime?<a class="hash-link" aria-label="A、什么是 Runtime?的直接链接" title="A、什么是 Runtime?的直接链接" href="https://layotto.github.io/layotto/blog/mosn-subproject-layotto-opening-a-new-chapter-in-service-grid-application-runtime#a%E4%BB%80%E4%B9%88%E6%98%AF-runtime">​</a></h3>
<blockquote>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_1c90e8/afts/img/A*hQT-Spc5rI4AAAAAAAAAAAAAARQnAQ" alt="" class="img_ev3q">
20 年初的时候，Bilgin lbryam 发表了一篇名为
Multi-Runtime Microservices Architecture
的文章，里面对微服务架构下一阶段的形态进行了讨论。</p>
</blockquote>
<p>如上图所示，作者把分布式服务的需求进行了抽象，总共分为了四大类：</p>
<ol>
<li>
<p>生命周期（Lifecycle）
主要指应用的编译、打包、部署等事情，在云原生的大趋势下基本被 docker、kubernetes 承包。</p>
</li>
<li>
<p>网络（Networking）
可靠的网络是微服务之间进行通信的基本保障，Service Mesh 正是在这方面做了尝试，目前 MOSN、envoy 等流行的数据面的稳定性、实用性都已经得到了充分验证。</p>
</li>
<li>
<p>状态（State）
分布式系统需要的服务编排，工作流，分布式单例，调度，幂等性，有状态的错误恢复，缓存等操作都可以统一归为底层的状态管理。</p>
</li>
<li>
<p>绑定（Binding）
在分布式系统中，不仅需要跟其他系统通信，还需要集成各种外部系统，因此对于协议转换，多种交互模型、错误恢复流程等功能也都有强依赖。</p>
</li>
</ol>
<p>明确了需求以后，借鉴了 Service Mesh 的思路，作者对分布式服务的架构演进进行了如下总结：</p>
<blockquote>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_1c90e8/afts/img/A*rwS2Q5yMp_sAAAAAAAAAAAAAARQnAQ" alt="" class="img_ev3q">
第一阶段就是把各种基础设施能力从应用中剥离解耦，通通变成独立 sidecar 模型伴随着应用一起运行。</p>
</blockquote>
<p>第二阶段是把各种 sidecar 提供的能力统一抽象成若干个 Runtime，这样应用从面向基础组件开发就演变成了面向各种分布式能力开发，彻底屏蔽掉了底层实现细节，而且由于是面向能力，除了调用提供各种能力的 API 之外，应用再也不需要依赖各种各样基础设施提供的 SDK 了。</p>
<p>作者的思路跟我们希望解决的问题一致，我们决定使用 Runtime 的理念来解决 Service Mesh 发展到现在所遇到的新问题。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="bservice-mesh-vs-runtime">B、Service Mesh vs Runtime<a class="hash-link" aria-label="B、Service Mesh vs Runtime的直接链接" title="B、Service Mesh vs Runtime的直接链接" href="https://layotto.github.io/layotto/blog/mosn-subproject-layotto-opening-a-new-chapter-in-service-grid-application-runtime#bservice-mesh-vs-runtime">​</a></h3>
<blockquote>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_1c90e8/afts/img/A*srPVSYTEHc4AAAAAAAAAAAAAARQnAQ" alt="" class="img_ev3q">
为了让大家对 Runtime 有一个更加清晰的认识，上图针对 Service Mesh 跟 Runtime 两种理念的定位、交互方式、通信协议以及能力丰富度进行了总结，可以看到相比 Service Mesh 而言，Runtime 提供了语义明确、能力丰富的 API，可以让应用跟它的交互变得更加简单直接。</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="三mosn-子项目-layotto">三、MOSN 子项目 Layotto<a class="hash-link" aria-label="三、MOSN 子项目 Layotto的直接链接" title="三、MOSN 子项目 Layotto的直接链接" href="https://layotto.github.io/layotto/blog/mosn-subproject-layotto-opening-a-new-chapter-in-service-grid-application-runtime#%E4%B8%89mosn-%E5%AD%90%E9%A1%B9%E7%9B%AE-layotto">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="adapr-调研">A、dapr 调研<a class="hash-link" aria-label="A、dapr 调研的直接链接" title="A、dapr 调研的直接链接" href="https://layotto.github.io/layotto/blog/mosn-subproject-layotto-opening-a-new-chapter-in-service-grid-application-runtime#adapr-%E8%B0%83%E7%A0%94">​</a></h3>
<blockquote>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_1c90e8/afts/img/A*Ab9HSYIK7CQAAAAAAAAAAAAAARQnAQ" alt="" class="img_ev3q">
dapr 是社区中一款知名的 Runtime 实现产品，活跃度也比较高，因此我们首先调研了 dapr 的情况，发现 dapr 具有如下优势：</p>
</blockquote>
<ol>
<li>
<p>提供了多种分布式能力，API 定义清晰，基本能满足一般的使用场景。</p>
</li>
<li>
<p>针对各种能力都提供了不同的实现组件，基本涵盖了常用的中间件产品，用户可以根据需要自由选择。</p>
</li>
</ol>
<p>当考虑如何在公司内部落地 dapr 时，我们提出了两种方案，如上图所示：</p>
<ol>
<li>替换：废弃掉现在的 MOSN，用 dapr 进行替换，这种方案存在两个问题：</li>
</ol>
<p>a.  dapr 虽然提供了很多分布式能力，但目前并不具备 Service Mesh 包含的丰富的服务治理能力。</p>
<p>b.  MOSN 在公司内部已经大规模落地，并且经过了多次大促考验，直接用 dapr 来替换 MOSN 稳定性有待验证。</p>
<ol start="2">
<li>共存：新增一个 dapr 容器，跟 MOSN 以两个 sidecar 的模式进行部署。这种方案同样存在两个问题：</li>
</ol>
<p>a.  引入一个新的 sidecar，我们就需要考虑它配套的升级、监控、注入等等事情，运维成本飙升。</p>
<p>b.  多维护一个容器意味着多了一层挂掉的风险，这会降低现在的系统可用性。</p>
<p>同样的，如果你目前正在使用 envoy 作为数据面，也会面临上述问题。
因此我们希望把 Runtime 跟 Service Mesh 两者结合起来，通过一个完整的 sidecar 进行部署，在保证稳定性、运维成本不变的前提下，最大程度复用现有的各种 Mesh 能力。此外我们还希望这部分 Runtime 能力除了跟 MOSN 结合起来之外，未来也可以跟 envoy 结合起来，解决更多场景中的问题，Layotto 就是在这样的背景下诞生。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="blayotto-架构">B、Layotto 架构<a class="hash-link" aria-label="B、Layotto 架构的直接链接" title="B、Layotto 架构的直接链接" href="https://layotto.github.io/layotto/blog/mosn-subproject-layotto-opening-a-new-chapter-in-service-grid-application-runtime#blayotto-%E6%9E%B6%E6%9E%84">​</a></h3>
<blockquote>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_1c90e8/afts/img/A*sdGoSYB_XFUAAAAAAAAAAAAAARQnAQ" alt="" class="img_ev3q">
如上图所示，Layotto 是构建在 MOSN 之上，在下层对接了各种基础设施，向上层应用提供了统一的，具有各种各样分布式能力的标准 API。对于接入 Layotto 的应用来说，开发者不再需要关心底层各种组件的实现差异，只需要关注应用需要什么样的能力，然后调用对应能力的 API 即可，这样可以彻底跟底层基础设施解绑。</p>
</blockquote>
<p>对应用来说，交互分为两块，一个是作为 gRPC Client 调用 Layotto 的标准 API，一个是作为 gRPC Server 来实现 Layotto 的回调，得利于gRPC 优秀的跨语言支持能力，应用不再需要关心通信、序列化等细节问题，进一步降低了异构技术栈的使用门槛。</p>
<p>除了面向应用，Layotto 也向运维平台提供了统一的接口，这些接口可以把应用跟 sidecar 的运行状态反馈给运维平台，方便 SRE 同学及时了解应用的运行状态并针对不同状态做出不同的举措，该功能考虑到跟 k8s 等已有的平台集成，因此我们提供了 HTTP 协议的访问方式。</p>
<p>除了 Layotto 本身设计以外，项目还涉及两块标准化建设，首先想要制定一套语义明确，适用场景广泛的 API 并不是一件容易的事情，为此我们跟阿里、 dapr 社区进行了合作，希望能够推进 Runtime API 标准化的建设，其次对于 dapr 社区已经实现的各种能力的 Components 来说，我们的原则是优先复用、其次开发，尽量不把精力浪费在已有的组件上面，重复造轮子。</p>
<p>最后 Layotto 目前虽然是构建在 MOSN 之上，未来我们希望 Layotto 可以跑在 envoy 上，这样只要应用接入了 Service Mesh，无论数据面使用的是 MOSN 还是 envoy，都可以在上面增加 Runtime能力。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="clayotto-的移植性">C、Layotto 的移植性<a class="hash-link" aria-label="C、Layotto 的移植性的直接链接" title="C、Layotto 的移植性的直接链接" href="https://layotto.github.io/layotto/blog/mosn-subproject-layotto-opening-a-new-chapter-in-service-grid-application-runtime#clayotto-%E7%9A%84%E7%A7%BB%E6%A4%8D%E6%80%A7">​</a></h3>
<blockquote>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_1c90e8/afts/img/A*2DrSQJ6GL8cAAAAAAAAAAAAAARQnAQ" alt="" class="img_ev3q">
如上图所示，一旦完成 Runtime API 的标准化建设，接入 Layotto 的应用天然具备了可移植性，应用不需要任何改造就可以在私有云以及各种公有云上部署，并且由于使用的是标准 API，应用也可以无需任何改造就在 Layotto 跟 dapr 之间自由切换。</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="d名字含义">D、名字含义<a class="hash-link" aria-label="D、名字含义的直接链接" title="D、名字含义的直接链接" href="https://layotto.github.io/layotto/blog/mosn-subproject-layotto-opening-a-new-chapter-in-service-grid-application-runtime#d%E5%90%8D%E5%AD%97%E5%90%AB%E4%B9%89">​</a></h3>
<blockquote>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_1c90e8/afts/img/A*CCckTZ_gRsMAAAAAAAAAAAAAARQnAQ" alt="" class="img_ev3q">
从上面的架构图可以看出，Layotto 项目本身是希望屏蔽基础设施的实现细节，向上层应用统一提供各种分布式能力，这种做法就好像是在应用跟基础设施之间加了一层抽象，因此我们借鉴了 OSI 对网络定义七层模型的思路，希望 Layotto 可以作为第八层对应用提供服务，otto 是意大利语中8的意思，Layer otto 就是第八层的意思，简化了一下变成了 Layotto，同时项目代号 L8，也是第八层的意思，这个代号也是设计我们项目 LOGO 时灵感的来源。</p>
</blockquote>
<p>介绍完项目的整体情况，下面对其中四个主要功能的实现细节进行说明。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="e配置原语">E、配置原语<a class="hash-link" aria-label="E、配置原语的直接链接" title="E、配置原语的直接链接" href="https://layotto.github.io/layotto/blog/mosn-subproject-layotto-opening-a-new-chapter-in-service-grid-application-runtime#e%E9%85%8D%E7%BD%AE%E5%8E%9F%E8%AF%AD">​</a></h3>
<blockquote>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_1c90e8/afts/img/A*mfkRQZH3oNwAAAAAAAAAAAAAARQnAQ" alt="" class="img_ev3q">
首先是分布式系统中经常使用的配置功能，应用一般使用配置中心来做开关或者动态调整应用的运行状态。Layotto 中配置模块的实现包括两部分，一个是对如何定义配置这种能力的 API 的思考，一个是具体的实现，下面逐个来看。</p>
</blockquote>
<p>想要定义一个能满足大部分实际生产诉求的配置 API 并不是一件容易的事，dapr 目前也缺失这个能力，因此我们跟阿里以及 dapr 社区一起合作，为如何定义一版合理的配置 API 进行了激烈讨论。</p>
<p>目前讨论结果还没有最终确定，因此 Layotto 是基于我们提给社区的第一版草案进行实现，下面对我们的草案进行简要说明。</p>
<p>我们先定义了一般配置所需的基本元素：</p>
<ol>
<li>
<p>appId：表示配置属于哪个应用</p>
</li>
<li>
<p>key：配置的 key</p>
</li>
<li>
<p>content：配置的值</p>
</li>
<li>
<p>group：配置所属的分组，如果一个 appId 下面的配置过多，我们可以给这些配置进行分组归类，便于维护。</p>
</li>
</ol>
<p>此外我们追加了两种高级特性，用来适配更加复杂的配置使用场景：</p>
<ol>
<li>
<p>label，用于给配置打标签，比如该配置属于哪个环境，在进行配置查询的时候，我们会使用 label + key 来查询配置。</p>
</li>
<li>
<p>tags，用户给配置追加的一些附加信息，如描述信息、创建者信息，最后修改时间等等，方便配置的管理，审计等。</p>
</li>
</ol>
<p>对于上述定义的配置 API 的具体实现，目前支持查询、订阅、删除、创建、修改五种操作，其中订阅配置变更后的推送使用的是 gRPC 的 stream 特性，而底层实现这些配置能力的组件，我们选择了国内流行的 apollo，后面也会根据需求增加其他实现。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="fpubsub-原语">F、Pub/Sub 原语<a class="hash-link" aria-label="F、Pub/Sub 原语的直接链接" title="F、Pub/Sub 原语的直接链接" href="https://layotto.github.io/layotto/blog/mosn-subproject-layotto-opening-a-new-chapter-in-service-grid-application-runtime#fpubsub-%E5%8E%9F%E8%AF%AD">​</a></h3>
<blockquote>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_1c90e8/afts/img/A*YJs-R6WFhkgAAAAAAAAAAAAAARQnAQ" alt="" class="img_ev3q">
对于 Pub/Sub 能力的支持，我们调研了 dapr 现在的实现，发现基本上已经可以满足我们的需求，因此我们直接复用了 dapr 的 API 以及 components，只是在 Layotto 里面做了适配，这为我们节省了大量的重复劳动，我们希望跟 dapr 社区保持一种合作共建的思路，而不是重复造轮子。</p>
</blockquote>
<p>其中 Pub 功能是 App 调用 Layotto 提供的 PublishEvent 接口，而 Sub 功能则是应用通过 gRPC Server 的形式实现了 ListTopicSubscriptions 跟 OnTopicEvent 两个接口，一个用来告诉 Layotto 应用需要订阅哪些 topic，一个用于接收 topic 变化时 Layotto 的回调事件。</p>
<p>dapr 对于 Pub/Sub 的定义基本满足我们的需求，但在某些场景下仍有不足，dapr 采用了 CloudEvent 标准，因此 Pub 接口没有返回值，这无法满足我们生产场景中要求 Pub 消息以后服务端返回对应的 messageID 的需求，这一点我们已经把需求提交给了 dapr 社区，还在等待反馈，考虑到社区异步协作的机制，我们可能会先社区一步增加返回结果，然后再跟社区探讨一种更好的兼容方案。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="grpc-原语">G、RPC 原语<a class="hash-link" aria-label="G、RPC 原�语的直接链接" title="G、RPC 原语的直接链接" href="https://layotto.github.io/layotto/blog/mosn-subproject-layotto-opening-a-new-chapter-in-service-grid-application-runtime#grpc-%E5%8E%9F%E8%AF%AD">​</a></h3>
<blockquote>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_1c90e8/afts/img/A*i-JnSaeZbJ4AAAAAAAAAAAAAARQnAQ" alt="" class="img_ev3q">
RPC 的能力大家不会陌生，这可能是微服务架构下最最基础的需求，对于 RPC 接口的定义，我们同样参考了 dapr 社区的定义，发现完全可以满足我们的需求，因此接口定义就直接复用 dapr 的，但目前 dapr 提供的 RPC 实现方案还比较薄弱，而 MOSN 经过多年迭代，能力已经非常成熟完善，因此我们大胆把 Runtime 跟 Service Mesh 两种思路结合在一起，把 MOSN 本身作为我们实现 RPC 能力的一个 Component，这样 Layotto 在收到 RPC 请求以后交给 MOSN 进行实际数据传输，这种方案可以通过 istio 动态改变路由规则，降级限流等等设置，相当于直接复用了 Service Mesh 的各种能力，这也说明 Runtime 不是要推翻 Service Mesh，而是要在此基础上继续向前迈一步。</p>
</blockquote>
<p>具体实现细节上，为了更好的跟 MOSN 融合，我们在 RPC 的实现上面加了一层 Channel，默认支持dubbo，bolt，http 三种常见的 RPC 协议，如果仍然不能满足用户场景，我们还追加了 Before/After 两种 Filter，可以让用户做自定义扩展，实现协议转换等需求。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="hactuator-原语">H、Actuator 原语<a class="hash-link" aria-label="H、Actuator 原语的直接链接" title="H、Actuator 原语的直接链接" href="https://layotto.github.io/layotto/blog/mosn-subproject-layotto-opening-a-new-chapter-in-service-grid-application-runtime#hactuator-%E5%8E%9F%E8%AF%AD">​</a></h3>
<blockquote>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_1c90e8/afts/img/A*E_Q-T4d_bm4AAAAAAAAAAAAAARQnAQ" alt="" class="img_ev3q">
在实际生产环境中，除了应用所需要的各种分布式能力以外，PaaS 等运维平台往往需要了解应用的运行状态，基于这种需求，我们抽象了一套 Actuator 接口，目前 dapr 还没有提供这方面的能力，因此我们根据内部的需求场景进行了设计，旨在把应用在启动期、运行期等阶段各种各样的信息暴露出去，方便 PaaS 了解应用的运行情况。</p>
</blockquote>
<p>Layotto 把暴露信息分为两大类：</p>
<ol>
<li>Health：该模块判断应用当前运行状态是否健康，比如某个强依赖的组件如果初始化失败就需要表示为非健康状态，而对于健康检查的类型我们参考了 k8s，分为：</li>
</ol>
<p>a.  Readiness：表示应用启动完成，可以开始处理请求。</p>
<p>b.  Liveness：表示应用存活状态，如果不存活则需要切流等。</p>
<ol start="2">
<li>Info：该模块预期会暴露应用的一些依赖信息出去，如应用依赖的服务，订阅的配置等等，用于排查问题。</li>
</ol>
<p>Health 对外暴露的健康状态分为以下三种：</p>
<ol>
<li>
<p>INIT：表示应用还在启动中，如果应用发布过程中返回该值，这个时候 PaaS 平台应该继续等待应用完成启动。</p>
</li>
<li>
<p>UP：表示应用启动正常，如果应用发布过程中返回该值，意味着 PasS 平台可以开始放入流量。</p>
</li>
<li>
<p>DOWN：表示应用启动失败，如果应用发布过程中返回该值，意味着 PaaS 需要停止发布并通知应用 owner。</p>
</li>
</ol>
<p>到这里关于 Layotto 目前在 Runtime 方向上的探索基本讲完了，我们通过定义明确语义的 API，使用 gRPC 这种标准的交互协议解决了目前面临的基础设施强绑定、异构语言接入成本高两大问题。随着未来 API 标准化的建设，一方面可以让接入 Layotto 的应用无感知的在各种私有云、公有云上面部署，另一方面也能让应用在 Layotto，dapr 之间自由切换，提高研发效率。</p>
<p>目前 Serverless 领域也是百花齐放，没有一种统一的解决方案，因此 Layotto 除了在上述 Runtime 方向上的投入以外，还在 Serverless 方向上也进行了一些尝试，下面就尝试方案进行介绍。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="四webassembly-的探索">四、WebAssembly 的探索<a class="hash-link" aria-label="四、WebAssembly 的探索的直接链接" title="四、WebAssembly 的探索的直接链接" href="https://layotto.github.io/layotto/blog/mosn-subproject-layotto-opening-a-new-chapter-in-service-grid-application-runtime#%E5%9B%9Bwebassembly-%E7%9A%84%E6%8E%A2%E7%B4%A2">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="awebassembly-简介">A、WebAssembly 简介<a class="hash-link" aria-label="A、WebAssembly 简介的直接链接" title="A、WebAssembly 简介的直接链接" href="https://layotto.github.io/layotto/blog/mosn-subproject-layotto-opening-a-new-chapter-in-service-grid-application-runtime#awebassembly-%E7%AE%80%E4%BB%8B">​</a></h3>
<blockquote>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_1c90e8/afts/img/A*-ACRSpqbuJ0AAAAAAAAAAAAAARQnAQ" alt="" class="img_ev3q">
WebAssembly，简称 WASM，是一个二进制指令集，最初是跑在浏览器上来解决 JavaScript 的性能问题，但由于它良好的安全性，隔离性以及语言无关性等优秀特性，很快人们便开始让它跑在浏览器之外的地方，随着 WASI 定义的出现，只需要一个 WASM 运行时，就可以让 WASM 文件随处执行。</p>
</blockquote>
<p>既然 WebAssembly 可以在浏览器以外的地方运行，那么我们是否能把它用在 Serverless 领域？目前已经有人在这方面做了一些尝试，不过如果这种方案真的想落地的话，首先要考虑的就是如何解决运行中的 WebAssembly 对各种基础设施的依赖问题。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="bwebassembly-落地原理">B、WebAssembly 落地原理<a class="hash-link" aria-label="B、WebAssembly 落地原理的直�接链接" title="B、WebAssembly 落地原理的直接链接" href="https://layotto.github.io/layotto/blog/mosn-subproject-layotto-opening-a-new-chapter-in-service-grid-application-runtime#bwebassembly-%E8%90%BD%E5%9C%B0%E5%8E%9F%E7%90%86">​</a></h3>
<p>目前 MOSN 通过集成 WASM Runtime 的方式让 WASM 跑在 MOSN 上面，以此来满足对 MOSN 做自定义扩展的需求。同时，Layotto 也是构建在 MOSN 之上，因此我们考虑把二者结合在一起，实现方案如下图所示：</p>
<blockquote>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_1c90e8/afts/img/A*U7UDRYyBOvIAAAAAAAAAAAAAARQnAQ" alt="" class="img_ev3q">
开发者可以使用 Go/C++/Rust 等各种各样自己喜欢的语言来开发应用代码，然后把它们编译成 WASM 文件跑在 MOSN 上面，当 WASM 形态的应用在处理请求的过程中需要依赖各种分布式能力时就可以通过本地函数调用的方式调用 Layotto 提供的标准 API，这样直接解决了 WASM 形态应用的依赖问题。</p>
</blockquote>
<p>目前 Layotto 提供了 Go 跟 Rust 版 WASM 的实现，虽然只支持 demo 级功能，但已经足够让我们看到这种方案的潜在价值。</p>
<p>此外，WASM 社区目前还处于初期阶段，有很多地方需要完善，我们也给社区提交了一些 PR共同建设，为 WASM 技术的落地添砖加瓦。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cwebassembly-落地展望">C、WebAssembly 落地展望<a class="hash-link" aria-label="C、WebAssembly 落地展望的直接链接" title="C、WebAssembly 落地展望的直接链接" href="https://layotto.github.io/layotto/blog/mosn-subproject-layotto-opening-a-new-chapter-in-service-grid-application-runtime#cwebassembly-%E8%90%BD%E5%9C%B0%E5%B1%95%E6%9C%9B">​</a></h3>
<blockquote>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_1c90e8/afts/img/A*NzwKRY2GZPcAAAAAAAAAAAAAARQnAQ" alt="" class="img_ev3q">
虽然现在 Layotto 中对 WASM 的使用还处于试验阶段，但我们希望它最终可以成为 Serverless 的一种实现形态，如上图所示，应用通过各种编程语言开发，然后统一编译成 WASM 文件，最后跑在 Layotto+MOSN 上面，而对于应用的运维管理统一由 k8s、docker、prometheus 等产品负责。</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="五社区规划">五、社区规划<a class="hash-link" aria-label="五、社区规划的直接链接" title="五、社区规划的直接链接" href="https://layotto.github.io/layotto/blog/mosn-subproject-layotto-opening-a-new-chapter-in-service-grid-application-runtime#%E4%BA%94%E7%A4%BE%E5%8C%BA%E8%A7%84%E5%88%92">​</a></h2>
<p>最后来看下 Layotto 在社区的做的一些事情。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="alayotto-vs-dapr">A、Layotto vs Dapr<a class="hash-link" aria-label="A、Layotto vs Dapr的直接链接" title="A、Layotto vs Dapr的直接链接" href="https://layotto.github.io/layotto/blog/mosn-subproject-layotto-opening-a-new-chapter-in-service-grid-application-runtime#alayotto-vs-dapr">​</a></h3>
<blockquote>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_1c90e8/afts/img/A*OpQTRqoMpK0AAAAAAAAAAAAAARQnAQ" alt="" class="img_ev3q">
上图列出了 Layotto 跟 dapr 现有的能力对比，在 Layotto 的开发过程中，我们借鉴 dapr 的思路，始终以优先复用、其次开发为原则，旨在达成共建的目标，而对于正在建设或者未来要建设的能力来说，我们计划优先在 Layotto 上落地，然后再提给社区，合并到标准 API，鉴于社区异步协作的机制，沟通成本较高，因此短期内可能 Layotto 的 API 会先于社区，但长期来看一定会统一。</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="bapi-共建计划">B、API 共建计划<a class="hash-link" aria-label="B、API 共建计划的直接链接" title="B、API 共建计划的直接链接" href="https://layotto.github.io/layotto/blog/mosn-subproject-layotto-opening-a-new-chapter-in-service-grid-application-runtime#bapi-%E5%85%B1%E5%BB%BA%E8%AE%A1%E5%88%92">​</a></h3>
<blockquote>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_1c90e8/afts/img/A*GAe8QqZ03eoAAAAAAAAAAAAAARQnAQ" alt="" class="img_ev3q">
关于如何定义一套标准的 API 以及如何让 Layotto 可以跑在 envoy 上等等事项，我们已经在各个社区进行了深入讨论，并且以后也还会继续推进。</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="croadmap">C、Roadmap<a class="hash-link" aria-label="C、Roadmap的直接链接" title="C、Roadmap的直接链接" href="https://layotto.github.io/layotto/blog/mosn-subproject-layotto-opening-a-new-chapter-in-service-grid-application-runtime#croadmap">​</a></h3>
<blockquote>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_1c90e8/afts/img/A*iUV3Q7S3VLEAAAAAAAAAAAAAARQnAQ" alt="" class="img_ev3q">
Layotto 在目前主要支持 RPC、Config、Pub/Sub、Actuator 四大功能，预计在九月会把精力投入到分布式锁、State、可观测性上面，十二月份会支持 Layotto 插件化，也就是让它可以跑在 envoy 上，同时希望对 WebAssembly 的探索会有进一步的产出。</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="d正式开源">D、正式开源<a class="hash-link" aria-label="D、正式开源的直接链接" title="D、正式开源的直接链接" href="https://layotto.github.io/layotto/blog/mosn-subproject-layotto-opening-a-new-chapter-in-service-grid-application-runtime#d%E6%AD%A3%E5%BC%8F%E5%BC%80%E6%BA%90">​</a></h3>
<blockquote>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_1c90e8/afts/img/A*S6mdTqAapLQAAAAAAAAAAAAAARQnAQ" alt="" class="img_ev3q">
前面详细介绍了 Layotto 项目，最重要的还是该项目今天作为 MOSN 的子项目正式开源，我们提供了详细的文档以及 demo 示例方便大家快速上手体验。</p>
</blockquote>
<p>对于 API 标准化的建设是一件需要长期推动的事情，同时标准化意味着不是满足一两种场景，而是尽可能的适配大多数使用场景，为此我们希望更多的人可以参与到 Layotto 项目中，描述你的使用场景，讨论 API 的定义方案，一起提交给社区，最终达成 Write once, Run anywhere 的终极目标！</p>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[源码解析 7层流量治理,接口限流]]></title>
            <link>https://layotto.github.io/layotto/blog/code/flowcontrol/flowcontrol_code_analyze</link>
            <guid>https://layotto.github.io/layotto/blog/code/flowcontrol/flowcontrol_code_analyze</guid>
            <pubDate>Mon, 08 Jul 2024 02:29:46 GMT</pubDate>
            <description><![CDATA[作者简介：]]></description>
            <content:encoded><![CDATA[<blockquote>
<p>作者简介：
张晨，是开源社区的爱好者，致力于拥抱开源，希望能和社区的各位开源爱好者互相交流互相进步和成长。</p>
<p>写作时间: 2022年4月20日</p>
</blockquote>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a class="hash-link" aria-label="Overview的直接链接" title="Overview的直接链接" href="https://layotto.github.io/layotto/blog/code/flowcontrol/flowcontrol_code_analyze#overview">​</a></h2>
<p>此文档的目的在于分析接口限流的实现</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="前提">前提：<a class="hash-link" aria-label="前提：的直接链接" title="前提：的直接链接" href="https://layotto.github.io/layotto/blog/code/flowcontrol/flowcontrol_code_analyze#%E5%89%8D%E6%8F%90">​</a></h2>
<p>文档内容所涉及代码版本如下</p>
<p><a href="https://github.com/mosn/mosn" target="_blank" rel="noopener noreferrer">https://github.com/mosn/mosn</a></p>
<p>Mosn   d11b5a638a137045c2fbb03d9d8ca36ecc0def11（develop分支）</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="源码分析">源码分析<a class="hash-link" aria-label="源码分析的直接链接" title="源码分析的直接链接" href="https://layotto.github.io/layotto/blog/code/flowcontrol/flowcontrol_code_analyze#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="总体分析">总体分析<a class="hash-link" aria-label="总体分析的直接链接" title="总体分析的直接链接" href="https://layotto.github.io/layotto/blog/code/flowcontrol/flowcontrol_code_analyze#%E6%80%BB%E4%BD%93%E5%88%86%E6%9E%90">​</a></h3>
<p>参考 <br><a href="https://mosn.io/docs/concept/extensions/" target="_blank" rel="noopener noreferrer">https://mosn.io/docs/concept/extensions/</a></p>
<p>Mosn 的 Stream Filter 扩展机制</p>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_5891a1/afts/img/A*tSn4SpIkAa4AAAAAAAAAAAAAARQnAQ" alt="01.png" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="代码均在-flowcontrol代码">代码均在： <a href="https://github.com/mosn/mosn/tree/master/pkg/filter/stream/flowcontrol" target="_blank" rel="noopener noreferrer">flowcontrol代码</a><a class="hash-link" aria-label="代码均在-flowcontrol代码的直接链接" title="代码均在-flowcontrol代码的直接链接" href="https://layotto.github.io/layotto/blog/code/flowcontrol/flowcontrol_code_analyze#%E4%BB%A3%E7%A0%81%E5%9D%87%E5%9C%A8-flowcontrol%E4%BB%A3%E7%A0%81">​</a></h3>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="stream_filter_factorygo分析">stream_filter_factory.go分析<a class="hash-link" aria-label="stream_filter_factory.go分析的直接链接" title="stream_filter_factory.go分析的直接链接" href="https://layotto.github.io/layotto/blog/code/flowcontrol/flowcontrol_code_analyze#stream_filter_factorygo%E5%88%86%E6%9E%90">​</a></h3>
<p>此类为一个工厂类，用于创建 StreamFilter</p>
<p>定义了一些常量用作默认值</p>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_5891a1/afts/img/A*PAWCTL6MS40AAAAAAAAAAAAAARQnAQ" alt="02.png" class="img_ev3q"></p>
<p>定义了限流配置类用作加载yaml定义并且解析生产出对应的功能</p>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_5891a1/afts/img/A*Ua32SokhILEAAAAAAAAAAAAAARQnAQ" alt="03.png" class="img_ev3q"></p>
<p>init() 初始化内部就是将 name 和 对应构造函数存储到 filter拦截工厂的map中</p>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_5891a1/afts/img/A*kb3qRqWnqxYAAAAAAAAAAAAAARQnAQ" alt="04.png" class="img_ev3q"></p>
<p>着重讲一下 createRpcFlowControlFilterFactory  生产出rpc流控工厂</p>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_5891a1/afts/img/A*u5rkS54zkgAAAAAAAAAAAAAAARQnAQ" alt="05.png" class="img_ev3q"></p>
<p>在查看streamFilter之前我们来看看工厂类是如何生产出限流器的</p>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_5891a1/afts/img/A*cj0nT5O69OYAAAAAAAAAAAAAARQnAQ" alt="06.png" class="img_ev3q"></p>
<p>限流器加入到限流链路结构中按照设定顺序依次生效。</p>
<p>CreateFilterChain 方法将多个filter 加入到链路结构中</p>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_5891a1/afts/img/A*a8ClQ76odpEAAAAAAAAAAAAAARQnAQ" alt="07.png" class="img_ev3q"></p>
<p>我们可以看到有各种各样的工厂类包括我们今天研究的限流工厂类实现了此接口</p>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_5891a1/afts/img/A*sBDbT44r2vgAAAAAAAAAAAAAARQnAQ" alt="08.png" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="stream_filtergo分析">Stream_filter.go分析<a class="hash-link" aria-label="Stream_filter.go分析的直接链接" title="Stream_filter.go分析的直接链接" href="https://layotto.github.io/layotto/blog/code/flowcontrol/flowcontrol_code_analyze#stream_filtergo%E5%88%86%E6%9E%90">​</a></h3>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_5891a1/afts/img/A*wsw3RKe1GH8AAAAAAAAAAAAAARQnAQ" alt="09.png" class="img_ev3q"></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="整体流程">整体流程：<a class="hash-link" aria-label="整体流程：的直接链接" title="整体流程：的直接链接" href="https://layotto.github.io/layotto/blog/code/flowcontrol/flowcontrol_code_analyze#%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B">​</a></h2>
<p>最后我们再来回顾一下整体流程走向:</p>
<ol>
<li>
<p>从stream_filter_factory.go的初始化函数init() 开始,程序向creatorStreamFactory(map类型)插入了 createRpcFlowControlFilterFactory.</p>
</li>
<li>
<p>Mosn 创建出一个filter chain(代码位置<a href="https://github.com/mosn/mosn/tree/master/pkg/streamfilter/factory.go" target="_blank" rel="noopener noreferrer">factory.go</a>) ,通过循环调用CreateFilterChain将所有的filter加入到链路结构包括我们今天的主人公限流器.</p>
</li>
<li>
<p>创建限流器 NewStreamFilter().</p>
</li>
<li>
<p>当流量通过mosn 将会进入到限流器的方法 OnReceive() 中并最终借助sentinel实现限流逻辑(是否已经达到阈值,是放行流量还是拦截流量, StreamFilterStop or StreamFilterContinue).</p>
</li>
</ol>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Layotto 源码解析 —— 处理 RPC 请求]]></title>
            <link>https://layotto.github.io/layotto/blog/code/layotto-rpc</link>
            <guid>https://layotto.github.io/layotto/blog/code/layotto-rpc</guid>
            <pubDate>Mon, 08 Jul 2024 02:29:46 GMT</pubDate>
            <description><![CDATA[本文主要以 Dubbo Json RPC 为例来分析 Layotto RPC 处理流程。]]></description>
            <content:encoded><![CDATA[<blockquote>
<p>本文主要以 Dubbo Json RPC 为例来分析 Layotto RPC 处理流程。</p>
<p>作者：<a href="https://github.com/rayowang" target="_blank" rel="noopener noreferrer">王志龙</a> | 2022年4月21日</p>
</blockquote>
<ul>
<li><a href="https://layotto.github.io/layotto/blog/code/layotto-rpc#%E6%A6%82%E8%BF%B0">概述</a></li>
<li><a href="https://layotto.github.io/layotto/blog/code/layotto-rpc#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90">源码分析</a>
<ul>
<li><a href="https://layotto.github.io/layotto/blog/code/layotto-rpc#_0x00-layotto-%E5%88%9D%E5%A7%8B%E5%8C%96-rpc">0x00 Layotto 初始化 RPC</a></li>
<li><a href="https://layotto.github.io/layotto/blog/code/layotto-rpc#_0x01-dubbo-go-sample-client-%E5%8F%91%E8%B5%B7%E8%AF%B7%E6%B1%82">0x01 Dubbo-go-sample client 发起请求</a></li>
<li><a href="https://layotto.github.io/layotto/blog/code/layotto-rpc#_0x02-mosn-eventloop-%E8%AF%BB%E5%8D%8F%E7%A8%8B%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82%E6%95%B0%E6%8D%AE">0x02 Mosn EventLoop 读协程处理请求数据</a></li>
<li><a href="https://layotto.github.io/layotto/blog/code/layotto-rpc#_0x03-grpc-sever-%E4%BD%9C%E4%B8%BA-networkfilter-%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82">0x03 Grpc Sever 作为 NetworkFilter 处理请求</a></li>
<li><a href="https://layotto.github.io/layotto/blog/code/layotto-rpc#_0x04-layotto-%E5%8F%91%E9%80%81-rpc-%E8%AF%B7%E6%B1%82%E5%B9%B6%E5%86%99%E5%85%A5-local-%E8%99%9A%E6%8B%9F%E8%BF%9E%E6%8E%A5">0x04 Layotto 发送 RPC 请求并写入 Local 虚拟连接</a></li>
<li><a href="https://layotto.github.io/layotto/blog/code/layotto-rpc#_0x05-mosn-%E8%AF%BB%E5%8F%96-remote-%E5%B9%B6%E6%89%A7%E8%A1%8C-filter-%E5%92%8C%E4%BB%A3%E7%90%86%E8%BD%AC%E5%8F%91">0x05 Mosn 读取 Remote 并执行 Filter 和代理转发</a></li>
<li><a href="https://layotto.github.io/layotto/blog/code/layotto-rpc#_0x06-dubbo-go-sample-server-%E6%94%B6%E5%88%B0%E8%AF%B7%E6%B1%82%E8%BF%94%E5%9B%9E%E5%93%8D%E5%BA%94">0x06 Dubbo-go-sample server 收到请求返回响应</a></li>
<li><a href="https://layotto.github.io/layotto/blog/code/layotto-rpc#_0x07-mosn-%E6%A1%86%E6%9E%B6%E5%A4%84%E7%90%86%E5%93%8D%E5%BA%94%E5%B9%B6%E5%86%99%E5%9B%9E-remote-%E8%99%9A%E6%8B%9F%E8%BF%9E%E6%8E%A5">0x07 Mosn 框架处理响应并写回 Remote 虚拟连接</a></li>
<li><a href="https://layotto.github.io/layotto/blog/code/layotto-rpc#_0x08-layotto-%E6%8E%A5%E6%94%B6-rpc-%E5%93%8D%E5%BA%94%E5%B9%B6%E8%AF%BB%E5%8F%96-local-%E8%99%9A%E6%8B%9F%E8%BF%9E%E6%8E%A5">0x08 Layotto 接收 RPC 响应并读取 Local 虚拟连接</a></li>
<li><a href="https://layotto.github.io/layotto/blog/code/layotto-rpc#_0x09-grpc-sever-%E5%A4%84%E7%90%86%E6%95%B0%E6%8D%AE%E5%B8%A7%E8%BF%94%E5%9B%9E%E7%BB%99%E5%AE%A2%E6%88%B7%E7%AB%AF">0x09 Grpc Sever 处理数据帧返回给客户端</a></li>
<li><a href="https://layotto.github.io/layotto/blog/code/layotto-rpc#_0x10-dubbo-go-sample-client-%E6%8E%A5%E6%94%B6%E5%93%8D%E5%BA%94">0x10 Dubbo-go-sample client 接收响应</a></li>
</ul>
</li>
<li><a href="https://layotto.github.io/layotto/blog/code/layotto-rpc#%E6%80%BB%E7%BB%93">总结</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="概述">概述<a class="hash-link" aria-label="概述的直接链接" title="概述的直接链接" href="https://layotto.github.io/layotto/blog/code/layotto-rpc#%E6%A6%82%E8%BF%B0">​</a></h2>
<p>Layotto 作为区别于网络代理 Service Mesh 的分布式原语集合且使用标准协议的 Runtime，具有明确和丰富的语义 API，而 RPC API 就是众多 API 中的一种。通过 RPC API 应用程序开发者可以通过与同样使用 Sidecar 架构的应用本地 Layotto 实例进行交互，从而间接的调用不同服务的方法，并可以利用内置能力完成分布式追踪和诊断，流量调控，错误处理，安全链路等操作。并且 Layotto 的 RPC API 基于 Mosn 的 Grpc handler 设计，除了 Http/Grpc，与其它服务通信时还可以利用Mosn的多协议机制，使用 X-Protocol 协议进行安全可靠通信。如下代码所示，RPC API 的接口与 Dapr 一致，通过 Grpc 接口 InvokeService 即可进行 RPC 调用。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> DaprClient </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Invokes a method on a remote Dapr app.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">InvokeService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> in </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">InvokeServiceRequest</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> opts </span><span class="token operator" style="color:#393A34">...</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CallOption</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">InvokeResponse</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="源码分析">源码分析<a class="hash-link" aria-label="源码分析的直接链接" title="源码分析的直接链接" href="https://layotto.github.io/layotto/blog/code/layotto-rpc#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90">​</a></h2>
<p>为了便于理解，这里从外到内，再从内到外，由数据流转映射到源代码，也就是从Client发起请求，穿越一层一层的逻辑，到 Server 收到请求返回响应，再一层层的回到 Client 收到响应，一层层来分析 Layotto 的 RPC 流程，总共拆分成十步。另外因为 Grpc Client 和 Server 握手及交互相关的内容不是本文重点，所以分析的相对简略一些，其它步骤内容相对详细一些，大家也可以根据自己的情况直接从目录跳转到相应步骤。</p>
<p>备注：本文基于 commit hash：1d2bed68c3b2372c34a12aeed41be125a4fdd15a</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="0x00-layotto-初始化-rpc">0x00 Layotto 初始化 RPC<a class="hash-link" aria-label="0x00 Layotto 初始化 RPC的直接链接" title="0x00 Layotto 初始化 RPC的直接链接" href="https://layotto.github.io/layotto/blog/code/layotto-rpc#0x00-layotto-%E5%88%9D%E5%A7%8B%E5%8C%96-rpc">​</a></h3>
<p>Layotto 启动流程涉及众多本流程，在此只分析下跟 RPC 相关的及下述流程用的初始化，因为 Layotto 是建立在 Mosn 之上，所以从 Main 函数出发，urfave/cli 库会调用 Mosn 的 StageManager 初始化 Mosn, 进而在 Mosn NetworkFilter 中初始化 GrpcServer，具体流程如下。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">stagemanager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">StageManager</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">runInitStage at stage_manager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Mosn</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">initServer at mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">filter</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">network</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">grpcServerFilterFactory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Init at factory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">filter</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">network</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Handler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">New at factory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 新建一个带有地址的 Grpc 服务器。同一个地址返回同一个服务器，只能启动一次</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Handler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">New</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> conf json</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RawMessage</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> options </span><span class="token operator" style="color:#393A34">...</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServerOption</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">registerServerWrapper</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mutex</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Lock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mutex</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Unlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sw</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ok </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">servers</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">addr</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> ok </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> sw</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ln</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">NewListener</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"create a listener failed: %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 调用 NewRuntimeGrpcServer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    srv</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">f</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">conf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> options</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"create a registered server failed: %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sw </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">registerServerWrapper</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        server</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> srv</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ln</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">     ln</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">servers</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">addr</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sw</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> sw</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">main</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">NewRunvtimeGrpcServer at main</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">layotto</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">runtime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">MosnRuntime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">initRuntime at runtime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">layotto</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">runtime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">MosnRuntime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">initRpcs at runtime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">layotto</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">components</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">rpc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">invoker</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">mosnInvoker</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Init at mosninvoker</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">mosnInvoker</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">conf rpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RpcConfig</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> config mosnConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> json</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Unmarshal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">conf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 初始化 RPC 调用前的 Filter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> before </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Before </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AddBeforeInvoke</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">before</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 初始化 RPC 调用后的 Filter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> after </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">After </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AddAfterInvoke</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">after</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Channel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> errors</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">New</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"missing channel config"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 初始化与 Mosn 通信使用的通道、协议及对应端口</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    channel</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetChannel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Channel</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">channel </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> channel</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 完成一些列初始化后在 grpcServerFilter 中启动 Grpc Server</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">filter</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">network</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">grpcServerFilterFactory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Init at factory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">grpcServerFilterFactory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">param </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    opts </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServerOption</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">UnaryInterceptor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UnaryInterceptorFilter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">StreamInterceptor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StreamInterceptorFilter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 经过上述初始化，完成 Grpc registerServerWrapper 的初始化</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sw</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">handler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">New</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">GrpcConfig</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> opts</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 启动 Grpc sever</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sw</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">GracefulStopTimeout</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">server </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sw</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Debugf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"grpc server filter initialized success"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// StageManager 在 runInitStage 之后进入 runStartStage 启动 Mosn</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stm </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">StageManager</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">runStartStage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    st </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Starting</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> f </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> stm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">startupStages </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">f</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">wg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 在所有启动阶段完成后启动 Mosn</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    stm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="0x01-dubbo-go-sample-client-发起请求">0x01 Dubbo-go-sample client 发起请求<a class="hash-link" aria-label="0x01 Dubbo-go-sample client 发起请求的直接链接" title="0x01 Dubbo-go-sample client 发起请求的直接链接" href="https://layotto.github.io/layotto/blog/code/layotto-rpc#0x01-dubbo-go-sample-client-%E5%8F%91%E8%B5%B7%E8%AF%B7%E6%B1%82">​</a></h3>
<p>根据 <a href="https://mosn.io/layotto/#/zh/start/rpc/dubbo_json_rpc" target="_blank" rel="noopener noreferrer">Dubbo Json Rpc Example</a> 例子运行如下命令</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">go run demo/rpc/dubbo_json_rpc/dubbo_json_client/client.go -d '{"jsonrpc":"2.0","method":"GetUser","params":["A003"],"id":9527}'</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>使用 Layotto 对 App 提供的 Grpc API InvokeService 发起 RPC 调用，经过数据填充和连接建立等流程，最终通过 Grpc clientStream 中调用 SendMsg 向 Layotto 发送数据，具体流程如下。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    data </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> flag</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"d"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">`{"jsonrpc":"2.0","method":"GetUser","params":["A003"],"id":9527}`</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"-d"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    flag</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Parse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    conn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Dial</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"localhost:34904"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithInsecure</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cli </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> runtimev1pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewRuntimeClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">conn</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cancel </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithCancel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">TODO</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">cancel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 通过 Grpc 接口 InvokeService 进行 RPC 调用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> cli</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">InvokeService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">// 使用 runtimev1pb.InvokeServiceRequest 发起 Grpc 请求</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">runtimev1pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">InvokeServiceRequest</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic">// 要请求的 server 接口 ID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           Id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"org.apache.dubbo.samples.UserProvider"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            Message</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">runtimev1pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CommonInvokeRequest</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token comment" style="color:#999988;font-style:italic">// 要请求的接口对应的方法名</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Method</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">        </span><span class="token string" style="color:#e3116c">"GetUser"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ContentType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token string" style="color:#e3116c">""</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                Data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">          </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">anypb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Any</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token function" style="color:#d73a49">byte</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                HttpExtension</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">runtimev1pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">HTTPExtension</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Verb</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> runtimev1pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">HTTPExtension_POST</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">resp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">layotto</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">spec</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">proto</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">runtime</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">runtimeClient</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">InvokeService at runtime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">google</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">golang</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">org</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ClientConn</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Invoke at call</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">google</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">golang</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">org</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">clientStream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SendMsg at stream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">google</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">golang</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">org</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">csAttempt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendMsg at stream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">google</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">golang</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">org</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">grpc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">internal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">transport</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">http2Client</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Write at http2_client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="0x02-mosn-eventloop-读协程处理请求数据">0x02 Mosn EventLoop 读协程处理请求数据<a class="hash-link" aria-label="0x02 Mosn EventLoop 读协程处理请求数据的直接链接" title="0x02 Mosn EventLoop 读协程处理请求数据的直接链接" href="https://layotto.github.io/layotto/blog/code/layotto-rpc#0x02-mosn-eventloop-%E8%AF%BB%E5%8D%8F%E7%A8%8B%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82%E6%95%B0%E6%8D%AE">​</a></h3>
<p>上文说过 Layotto 的内核相当于是 Mosn，所以当网络连接数据到达时，会先到 Mosn 的 L4 网络层进行读写，具体流程如下。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">network</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">listener</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">accept at listener</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">activeListener</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OnAccept at handler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">activeRawConn</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ContinueFilterChain at handler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">activeListener</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">newConnection at handler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">network</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">connection</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Start at connection</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">network</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">connection</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">startRWLoop at connection</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">connection</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">startRWLoop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">internalLoopStarted </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    utils</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GoWithRecover</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">// 读协程</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">startReadLoop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">r </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">NoFlush</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">LocalClose</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">checkUseWriteLoop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">useWriteLoop </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        utils</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GoWithRecover</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic">// 写协程</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">startWriteLoop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">r </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">NoFlush</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">LocalClose</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在 startRWLoop 方法中我们可以看到会分别开启两个协程来分别处理该连接上的读写操作，即 startReadLoop 和 startWriteLoop，在 startReadLoop 中经过如下流转，把网络层读到的数据，由 filterManager 过滤器管理器把数据交由过滤器链进行处理，具体流程如下。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">network</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">connection</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">doRead at connection</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">network</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">connection</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">onRead at connection</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">network</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">filterManager</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OnRead at filtermanager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">network</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">filterManager</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">onContinueReading at filtermanager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fm </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">filterManager</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">onContinueReading</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">filter </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">activeReadFilter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> index </span><span class="token builtin">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> uf </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">activeReadFilter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> filter </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        index </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> filter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">index </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// filterManager遍历过滤器进行数据处理</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> index </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">upstreamFilters</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> index</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">upstreamFilters</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        uf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">index </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> index</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 对没有初始化的过滤器调用其初始化方法 OnNewConnection，本例为func (f *grpcFilter) OnNewConnection() api.FilterStatus（向 Listener 发送 grpc 连接以唤醒 Listener 的 Accept）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">uf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">initialized </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            uf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">initialized </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            status </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> uf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">filter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">OnNewConnection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> status </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Stop </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        buf </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> fm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetReadBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> buf </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> buf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic">// 通知相应过滤器处理</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            status </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> uf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">filter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">OnData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> status </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Stop </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">filter</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">network</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">grpcFilter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OnData at filter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">filter</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">network</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">grpcFilter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dispatch at filter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">grpcFilter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">dispatch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">buf buffer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IoBuffer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetLogLevel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DEBUG </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Debugf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"grpc get datas: %d"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> buf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 发送数据唤醒连接读取</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetLogLevel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DEBUG </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Debugf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"read dispatch finished"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="0x03-grpc-sever-作为-networkfilter-处理请求">0x03 Grpc Sever 作为 NetworkFilter 处理请求<a class="hash-link" aria-label="0x03 Grpc Sever 作为 NetworkFilter 处理请求的直接链接" title="0x03 Grpc Sever 作为 NetworkFilter 处理请求的直接链接" href="https://layotto.github.io/layotto/blog/code/layotto-rpc#0x03-grpc-sever-%E4%BD%9C%E4%B8%BA-networkfilter-%E5%A4%84%E7%90%86%E8%AF%B7%E6%B1%82">​</a></h3>
<p>第一阶段中从原始连接读取数据，会进入 Grpc Serve 处理，Serve 方法通过 net.Listener 监听连接，每次启动一个新的协程来处理新的连接（handleRawConn），建立一个基于Http2 的 Transport 进行传输层的 RPC 调用，具体流程如下。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">google</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">golang</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">org</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Server</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">handleRawConn at server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Server</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handleRawConn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lisAddr </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rawConn net</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Conn</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 校验服务状态</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">quit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">HasFired</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rawConn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rawConn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetDeadline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">opts</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">connectionTimeout</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    conn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> authInfo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">useTransportAuthenticator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rawConn</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// HTTP2 握手，创建 Http2Server 与客户端交换帧的初始化信息，帧和窗口大小等</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    st </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">newHTTP2Transport</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">conn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> authInfo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> st </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rawConn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetDeadline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Time</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">addConn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lisAddr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> st</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 创建一个协程进行流处理</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">serveStreams</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">st</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">removeConn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lisAddr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> st</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">google</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">golang</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">org</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Server</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">serveStreams at server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">google</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">golang</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">org</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Server</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">handleStream at server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Server</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handleStream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t transport</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServerTransport</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> stream </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">transport</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Stream</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> trInfo </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">traceInfo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 找到到需要调用的 FullMethod，此例为 spec.proto.runtime.v1.Runtime/InvokeService</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sm </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> stream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Method</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> sm </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> sm</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token char">'/'</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sm </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sm</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    service </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> sm</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">pos</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    method </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> sm</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">pos</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 从注册的 service 列表中找到对应 serviceInfo 对象</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    srv</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> knownService </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">services</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">service</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> knownService </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 根据方法名找到单向请求的 md——MethodDesc，此 demo 为 mosn.io/layotto/spec/proto/runtime/v1._Runtime_InvokeService_Handler</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> md</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ok </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> srv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">methods</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">method</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> ok </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">processUnaryRPC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> stream</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> srv</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> md</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> trInfo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 流式请求</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> sd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ok </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> srv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">streams</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">method</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> ok </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">processStreamingRPC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> stream</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> srv</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> trInfo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">google</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">golang</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">org</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Server</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">processUnaryRPC at server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">layotto</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">spec</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">proto</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">runtime</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_Runtime_InvokeService_Handler at runtime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">google</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">golang</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">org</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">chainUnaryServerInterceptors at server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 服务端单向调用拦截器，用以调用 Mosn 的 streamfilter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">filter</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">network</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">grpcServerFilterFactory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UnaryInterceptorFilter at factory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">google</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">golang</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">org</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getChainUnaryHandler at server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 递归生成链式UnaryHandler</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getChainUnaryHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">interceptors </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">UnaryServerInterceptor</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> curr </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> info </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">UnaryServerInfo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> finalHandler UnaryHandler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> UnaryHandler </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> curr </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">interceptors</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> finalHandler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> req </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">// finalHandler就是mosn.io/layotto/spec/proto/runtime/v1._Runtime_InvokeService_Handler</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> interceptors</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">curr</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> req</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> info</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getChainUnaryHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">interceptors</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> curr</span><span class="token operator" style="color:#393A34">+</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> info</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> finalHandler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="0x04-layotto-发送-rpc-请求并写入-local-虚拟连接">0x04 Layotto 发送 RPC 请求并写入 Local 虚拟连接<a class="hash-link" aria-label="0x04 Layotto 发送 RPC 请求并写入 Local 虚拟连接的直接链接" title="0x04 Layotto 发送 RPC 请求并写入 Local 虚拟连接的直接链接" href="https://layotto.github.io/layotto/blog/code/layotto-rpc#0x04-layotto-%E5%8F%91%E9%80%81-rpc-%E8%AF%B7%E6%B1%82%E5%B9%B6%E5%86%99%E5%85%A5-local-%E8%99%9A%E6%8B%9F%E8%BF%9E%E6%8E%A5">​</a></h3>
<p>接上述 0x03 流程，从 Runtime_InvokeService_Handler 起，由 GRPC 默认 API 转换为 Dapr API，进入 Layotto 提供的对接 Mosn 的轻量 RPC 框架，具体流程如下。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">layotto</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">spec</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">proto</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">runtime</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_Runtime_InvokeService_Handler at runtime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">layotto</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">grpc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">default_api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">api</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">InvokeService at api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">layotto</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">grpc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">dapr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">daprGrpcAPI</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">InvokeService at dapr_api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">layotto</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">components</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">rpc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">invoker</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">mosnInvoker</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Invoke at mosninvoker</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 请求 Mosn 底座和返回响应</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">mosnInvoker</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Invoke</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> req </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">rpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RPCRequest</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">resp </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">rpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RPCResponse</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> r </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">recover</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> r </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"[runtime][rpc]mosn invoker panic: %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> r</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"%v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 1. 如果超时时间为 0，设置默认 3000ms 超时</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Timeout </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Timeout </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ctx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ctx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Debugf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"[runtime][rpc]request %+v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> req</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 2. 触发请求执行前的自定义逻辑</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    req</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">BeforeInvoke</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"[runtime][rpc]before filter error %s"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 3. 核心调用，下文会进行详细分析</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Do</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"[runtime][rpc]error %s"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ctx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ctx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 4. 触发请求返回后的自定义逻辑</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AfterInvoke</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">resp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"[runtime][rpc]after filter error %s"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> resp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">layotto</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">components</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">rpc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">invoker</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">httpChannel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Do at httpchannel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">h </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">httpChannel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Do</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">req </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">rpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RPCRequest</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">rpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RPCResponse</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 1. 使用上一阶段设置的默认超时设置 context 超时</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    timeout </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Duration</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Timeout</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Millisecond</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cancel </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithTimeout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> timeout</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">cancel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 2. 创建连接得到，启动 readloop 协程进行 Layotto 和 Mosn 的读写交互（具体见下文分析）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    conn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> h</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 3. 设置数据写入连接的超时时间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hstate </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">hstate</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    deadline</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Deadline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetWriteDeadline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">deadline</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hstate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        h</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">conn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> common</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">common</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UnavailebleCode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 4. 因为初始化时配置的 Layotto 与 Mosn 交互使用的是 Http 协议，所以这里会构造 Http 请求</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    httpReq </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> h</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">constructReq</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">req</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> fasthttp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ReleaseRequest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">httpReq</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 借助 fasthttp 请求体写入虚拟连接</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> httpReq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WriteTo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">conn</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hstate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        h</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">conn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> common</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">common</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UnavailebleCode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 5. 构造 fasthttp.Response 结构体读取和解析 hstate 的返回，并设置读取超时时间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    httpResp </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">fasthttp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Response</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hstate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reader</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetReadDeadline</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">deadline</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 在 Mosn 数据返回前这里会阻塞，readloop 协程读取 Mosn 返回的数据之后流程见下述 0x08 阶段</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> httpResp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Read</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bufio</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewReader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hstate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reader</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hstate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        h</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">conn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> common</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">common</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UnavailebleCode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    h</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">conn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">layotto</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">components</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">rpc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">invoker</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">connPool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Get at connpool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Get is get wrapConn by context.Context</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">connPool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">wrapConn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">waitTurn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mu</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Lock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 1. 从连接池获取连接</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> ele </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">free</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Front</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> ele </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">free</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Remove</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ele</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mu</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Unlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        wc </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> ele</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">wrapConn</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">wc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isClose</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> wc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mu</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Unlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 2. 创建新的连接</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">dialFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">freeTurn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    wc </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">wrapConn</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Conn</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stateFunc </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        wc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">stateFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 3. 启动 readloop 独立协程读取 Mosn 返回的数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">onDataFunc </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        utils</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GoWithRecover</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">readloop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">wc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> wc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上面第二步创建新的连接需要注意下，是调用了 init 阶段的 RegistChannel 初始化的协议中的 dialFunc func() (net.Conn, error)，因为配置里与 Mosn 交互用的是 Http 协议，所以这里是 newHttpChanel，目前还支持 Bolt，Dubbo 等，详见如下代码。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">layotto</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">components</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">rpc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">invoker</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">newHttpChannel at httpchannel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// newHttpChannel is used to create rpc.Channel according to ChannelConfig</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">newHttpChannel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config ChannelConfig</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Channel</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hc </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">httpChannel</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 为减少连接创建开销的连接池，定义在 mosn.io/layotto/components/rpc/invoker/mosn/channel/connpool.go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pool </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">newConnPool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// dialFunc</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">net</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Conn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> net</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SplitHostPort</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Listener</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> net</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Dial</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"tcp"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Listener</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic">//创建一对虚拟连接(net.Pipe)，Layotto 持有 local，Mosn 持有 remote, Layotto 向 local 写入，Mosn 会收到数据, Mosn 从 remote读取，执行 filter 逻辑并进行代理转发，再将响应写到 remote ,最后 Layotto 从 remote 读取，获得响应</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            local</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> remote </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> net</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Pipe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            localTcpConn </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">fakeTcpConn</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> local</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            remoteTcpConn </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">fakeTcpConn</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> remote</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic">// acceptFunc 是定义在 mosn.io/layotto/components/rpc/invoker/mosn/channel.go 中的闭包，闭包中监听了 remote 虚拟连接</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">acceptFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">remoteTcpConn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Listener</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// the goroutine model is:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// request goroutine ---&gt;  localTcpConn ---&gt; mosn</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">//        ^                                        |</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">//        |                                        |</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">//        |                                        |</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">//         hstate &lt;-- readloop goroutine     &lt;------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> localTcpConn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// stateFunc</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// hstate 是 readloop 协程与 request 协程通信的管道，是一对读写 net.Conn，请求协程从 reader net.Conn 中读数据，readloop 协程序往 writer net.Conn 写数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            s </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">hstate</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reader</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">writer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> net</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Pipe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">onData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cleanup</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> hc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="0x05-mosn-读取-remote-并执行-filter-和代理转发">0x05 Mosn 读取 Remote 并执行 Filter 和代理转发<a class="hash-link" aria-label="0x05 Mosn 读取 Remote 并执行 Filter 和代理转发的直接链接" title="0x05 Mosn 读取 Remote 并执行 Filter 和代理转发的直接链接" href="https://layotto.github.io/layotto/blog/code/layotto-rpc#0x05-mosn-%E8%AF%BB%E5%8F%96-remote-%E5%B9%B6%E6%89%A7%E8%A1%8C-filter-%E5%92%8C%E4%BB%A3%E7%90%86%E8%BD%AC%E5%8F%91">​</a></h3>
<p>(1) 与 0x02 类似，filtermanager 执行过滤器处理阶段，这里会到 proxy 中进行代理转发，详见如下代码。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">network</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">filterManager</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">onContinueReading at filtermanager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">proxy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">proxy</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OnData at proxy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">proxy</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">OnData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">buf buffer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IoBuffer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FilterStatus </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fallback </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Continue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">serverStreamConn </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">serverStreamConn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> stream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">CreateServerStreamConnection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> proto</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">readCallbacks</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Connection</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//把数据分发到对应协议的解码器，在这里因为是 POST /org.apache.dubbo.samples.UserProvider HTTP/1.1，所以是 mosn.io/mosn/pkg/stream/http.(*serverStreamConnection).serve at stream.go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">serverStreamConn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Dispatch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Stop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>(2) serverStreamConnection.serve 监听并处理请求到 downstream OnReceive，详见如下代码。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">stream</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">serverStream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">handleRequest at stream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">serverStream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handleRequest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">request </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// set non-header info in request-line, like method, uri</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">injectCtxVarFromProtocolHeaders</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">header</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">URI</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hasData </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Body</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            hasData </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> hasData </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic">//在此进入 downstream OnReceive</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">receiver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">OnReceive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">header</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> buffer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewIoBufferBytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">request</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Body</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">receiver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">OnReceive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">header</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">proxy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">downStream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OnReceive at downstream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">downStream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">OnReceive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> headers types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">HeaderMap</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IoBuffer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> trailers types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">HeaderMap</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> task </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        phase </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">InitPhase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">cleanNotify</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            phase </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">receive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> phase</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">proxy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">serverStreamConn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">EnableWorkerPool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">proxy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">workerpool </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// use the worker pool for current proxy</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">proxy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">workerpool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Schedule</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">task</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// use the global shared worker pool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            pool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ScheduleAuto</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">task</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">task</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>(3) 上述 ScheduleAuto 调度后，经过 downStream 的 reveive 的各个阶段处理，经过 upstreamRequest、http clientStream 等处理，最终从网络层的 connection.Write 发送数据并进入 WaitNotify 阶段阻塞，详见如下代码。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">sync</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">workerPool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ScheduleAuto at workerpool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">sync</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">workerPool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">spawnWorker at workerpool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">proxy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">downStream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">receive at downstream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">InitPhase</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">DownFilter</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">MatchRoute</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">DownFilterAfterRoute</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">ChooseHost</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">DownFilterAfterChooseHost</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">DownRecvHeader</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain">DownRecvData</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">proxy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">downStream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">receiveData at downstream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">proxy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">upstreamRequest</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">appendData at upstream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">stream</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">clientStream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">doSend at stream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">github</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">com</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">valyala</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">fasthttp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Request</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">WriteTo at http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">stream</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">streamConnection</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Write at stream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">network</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">connection</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Write at connection</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">proxy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">downStream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">receive at downstream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">downStream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">receive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> id </span><span class="token builtin">uint32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> phase types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Phase</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Phase </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">End</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">InitPhase</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">phase </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> phase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> phase </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">WaitNotify</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">printPhaseInfo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">phase</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">waitNotify</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> p</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Proxy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetLogLevel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DEBUG </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            	log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Proxy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Debugf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"[proxy] [downstream] OnReceive send downstream response %+v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">downstreamRespHeaders</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">downStream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">waitNotify</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id </span><span class="token builtin">uint32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">phase types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Phase</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> atomic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">LoadUint32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ID</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> id </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">End</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ErrExit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Proxy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetLogLevel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DEBUG </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Proxy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Debugf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"[proxy] [downstream] waitNotify begin %p, proxyId = %d"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ID</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 阻塞等待</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">notify</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">processError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="0x06-dubbo-go-sample-server-收到请求返回响应">0x06 Dubbo-go-sample server 收到请求返回响应<a class="hash-link" aria-label="0x06 Dubbo-go-sample server 收到请求返回响应的直接链接" title="0x06 Dubbo-go-sample server 收到请求返回响应的直接链接" href="https://layotto.github.io/layotto/blog/code/layotto-rpc#0x06-dubbo-go-sample-server-%E6%94%B6%E5%88%B0%E8%AF%B7%E6%B1%82%E8%BF%94%E5%9B%9E%E5%93%8D%E5%BA%94">​</a></h3>
<p>这里就是 dubbo-go-sample server的处理，暂不展开，贴下日志信息，感兴趣的同学可以回去翻看源码。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[2022-04-18/21:03:18 github.com/apache/dubbo-go-samples/rpc/jsonrpc/go-server/pkg.(*UserProvider2).GetUser: user_provider2.go: 53] userID:"A003"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[2022-04-18/21:03:18 github.com/apache/dubbo-go-samples/rpc/jsonrpc/go-server/pkg.(*UserProvider2).GetUser: user_provider2.go: 56] rsp:&amp;pkg.User{ID:"113", Name:"Moorse", Age:30, sex:0, Birth:703394193, Sex:"MAN"}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="0x07-mosn-框架处理响应并写回-remote-虚拟连接">0x07 Mosn 框架处理响应并写回 Remote 虚拟连接<a class="hash-link" aria-label="0x07 Mosn 框架处理响应并写回 Remote 虚拟连接的直接链接" title="0x07 Mosn 框架处理响应并写回 Remote 虚拟连接的直接链接" href="https://layotto.github.io/layotto/blog/code/layotto-rpc#0x07-mosn-%E6%A1%86%E6%9E%B6%E5%A4%84%E7%90%86%E5%93%8D%E5%BA%94%E5%B9%B6%E5%86%99%E5%9B%9E-remote-%E8%99%9A%E6%8B%9F%E8%BF%9E%E6%8E%A5">​</a></h3>
<p>接上述 0x05 第三阶段，在 reveive 的循环阶段的 UpRecvData 阶段进入处理响应逻辑，经过一系列处理最终 Response 写回 0x04 中的 remote 虚拟连接，具体流程如下。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">proxy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">downStream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">receive at downstream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">downStream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">waitNotify</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id </span><span class="token builtin">uint32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">phase types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Phase</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> atomic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">LoadUint32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ID</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> id </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">End</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ErrExit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Proxy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetLogLevel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DEBUG </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Proxy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Debugf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"[proxy] [downstream] waitNotify begin %p, proxyId = %d"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ID</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 返回响应</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">notify</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">processError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">UpFilter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">UpRecvHeader</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">downStream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">receive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> id </span><span class="token builtin">uint32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> phase types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Phase</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Phase </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">End</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">InitPhase</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">phase </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> phase</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> phase </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UpRecvData</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">downstreamRespDataBuf </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            	s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">printPhaseInfo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">phase</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            	s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">upstreamRequest</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">receiveData</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">downstreamRespTrailers </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">processError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              	   </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> p</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">proxy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">upstreamRequest</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">receiveData at upstream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">proxy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">downStream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">onUpstreamData at downstream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">proxy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">downStream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">appendData at downstream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">stream</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">serverStream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AppendData at stream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">stream</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">serverStream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">endStream at stream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">stream</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">serverStream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">doSend at stream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">github</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">com</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">valyala</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">fasthttp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Response</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">WriteTo at http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">github</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">com</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">valyala</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">fasthttp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">writeBufio at http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">github</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">com</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">valyala</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">fasthttp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">statsWriter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Write at http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">stream</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">streamConnection</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Write at stream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="0x08-layotto-接收-rpc-响应并读取-local-虚拟连接">0x08 Layotto 接收 RPC 响应并读取 Local 虚拟连接<a class="hash-link" aria-label="0x08 Layotto 接收 RPC 响应并读取 Local 虚拟连接的直接链接" title="0x08 Layotto 接收 RPC 响应并读取 Local 虚拟连接的直接链接" href="https://layotto.github.io/layotto/blog/code/layotto-rpc#0x08-layotto-%E6%8E%A5%E6%94%B6-rpc-%E5%93%8D%E5%BA%94%E5%B9%B6%E8%AF%BB%E5%8F%96-local-%E8%99%9A%E6%8B%9F%E8%BF%9E%E6%8E%A5">​</a></h3>
<p>上述 0x04 启动的 readloop 协程读IO被激活，从连接读取数Mosn 传回的数据，然后交给 hstate 管道中转处理再返回给请求协程，具体流程如下。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">layotto</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">components</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">rpc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">invoker</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">connPool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">readloop at connpool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// readloop is loop to read connected then exec onDataFunc</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">connPool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">readloop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">wrapConn</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> err </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cleanupFunc </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">cleanupFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">buf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> buffer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewIoBuffer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">defaultBufSize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 从连接读取数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        n</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> readErr </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ReadOnce</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> readErr </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> readErr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> readErr </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> io</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EOF </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Debugf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"[runtime][rpc]connpool readloop err: %s"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> readErr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"[runtime][rpc]connpool readloop err: %s"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> readErr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> n </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// 在onDataFunc 委托给 hstate 处理数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> onDataErr </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">onDataFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> onDataErr </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> onDataErr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"[runtime][rpc]connpool onData err: %s"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> onDataErr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">break</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">buf </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Cap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> maxBufSize </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Free</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Alloc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">defaultBufSize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">layotto</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">components</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">rpc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">invoker</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">httpChannel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">onData at httpchannel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">layotto</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">components</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">rpc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">invoker</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">hstate</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">onData at httpchannel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pipe</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Write at pipe</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">layotto</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">components</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">rpc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">invoker</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">httpChannel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Do at httpchannel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">h </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">httpChannel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Do</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">req </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">rpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RPCRequest</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">rpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RPCResponse</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 接上述0x04阶段，mosn 数据返回后，从 hstate 读取 readloop 协程从 mosn 返回的数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> httpResp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Read</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bufio</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewReader</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hstate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reader</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hstate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        h</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">conn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> common</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">common</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UnavailebleCode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    h</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">conn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 获取 fasthttp 的数据部分，解析状态码，失败返回错误信息和状态码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    body </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> httpResp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Body</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> httpResp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">StatusCode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> http</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StatusOK </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> common</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">common</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UnavailebleCode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"http response code %d, body: %s"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> httpResp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">StatusCode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">body</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 6. 将结果转换为 rpc.RPCResponse 返回</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rpcResp </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">rpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RPCResponse</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ContentType</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">httpResp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Header</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ContentType</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">        body</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Header</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">      </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    httpResp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Header</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">VisitAll</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">byte</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rpcResp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Header</span><span class="token punctuation" style="color:#393A34">[</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">{</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> rpcResp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="0x09-grpc-sever-处理数据帧返回给客户端">0x09 Grpc Sever 处理数据帧返回给客户端<a class="hash-link" aria-label="0x09 Grpc Sever 处理数据帧返回给客户端的直接链接" title="0x09 Grpc Sever 处理数据帧返回给客户端的直接链接" href="https://layotto.github.io/layotto/blog/code/layotto-rpc#0x09-grpc-sever-%E5%A4%84%E7%90%86%E6%95%B0%E6%8D%AE%E5%B8%A7%E8%BF%94%E5%9B%9E%E7%BB%99%E5%AE%A2%E6%88%B7%E7%AB%AF">​</a></h3>
<p>Grpc 并没有直接写入数据到连接，而是用协程异步 loop 循环从一个缓存结构里面获取帧然后写回到客户端，具体流程如下。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">google</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">golang</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">org</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">grpc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">internal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">transport</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">NewServerTransport at http2_server</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">NewServerTransport</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">conn net</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Conn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ServerConfig</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> ServerTransport</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 协程异步loop循环</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">loopy </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">newLoopyWriter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">serverSide</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">framer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">controlBuf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bdpEst</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">loopy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ssGoAwayHandler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">outgoingGoAwayHandler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">loopy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">V</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">logLevel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"transport: loopyWriter.run returning. Err: %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">controlBuf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">finish</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">writerDone</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">keepalive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">google</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">golang</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">org</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">grpc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">internal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">transport</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">loopyWriter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">run at controlbuf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">google</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">golang</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">org</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">grpc</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">internal</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">transport</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">bufWriter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Flush at http_util</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">filter</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">network</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Connection</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Write at conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">network</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">connection</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Write at connection</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">network</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">connection</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">writeDirectly at connection</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mosn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">io</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">mosn</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">pkg</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">network</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">connection</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">doWrite at connection</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="0x10-dubbo-go-sample-client-接收响应">0x10 dubbo-go-sample client 接收响应<a class="hash-link" aria-label="0x10 dubbo-go-sample client 接收响应的直接链接" title="0x10 dubbo-go-sample client 接收响应的直接链接" href="https://layotto.github.io/layotto/blog/code/layotto-rpc#0x10-dubbo-go-sample-client-%E6%8E%A5%E6%94%B6%E5%93%8D%E5%BA%94">​</a></h3>
<p>接上述 0x01 发送数据之后会阻塞在 Client grpc 底层读IO中, Layotto经过上述一些列处理层层返回数据激活Client底层Read IO，具体流程如下。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">google</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">golang</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">org</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ClientConn</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Invoke at call</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">google</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">golang</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">org</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ClientConn</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Invoke at call</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">google</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">golang</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">org</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">clientStream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RecvMsg at stream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">google</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">golang</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">org</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">clientStream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">withRetry at stream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">google</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">golang</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">org</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">csAttempt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">recvMsg at stream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">google</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">golang</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">org</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">recvAndDecompress at rpc_util</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">google</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">golang</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">org</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">recv at rpc_util</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">google</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">golang</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">org</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">parser</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">recvMsg at rpc_util</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">google</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">golang</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">org</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">csAttempt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">recvMsg at stream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">parser</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">recvMsg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">maxReceiveMessageSize </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pf payloadFormat</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> msg </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">byte</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Read</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">header</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>最终收到返回数据：</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{"jsonrpc":"2.0","id":9527,"result":{"id":"113","name":"Moorse","age":30,"time":703394193,"sex":"MAN"}}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a class="hash-link" aria-label="总结的直接链接" title="总结的直接链接" href="https://layotto.github.io/layotto/blog/code/layotto-rpc#%E6%80%BB%E7%BB%93">​</a></h2>
<p>Layotto RPC 处理流程涉及 GRPC、Dapr、Mosn 等相关的知识，整体流程较长，不过单纯看 Layotto 针对 Mosn 抽象的轻量 RPC 框架还是比较清晰和简单的，与 Mosn 集成的方式也比较新颖，值得进一步研读。至此 Layotto RPC 请求处理就分析完了，时间有限，没有进行一些更全面和深入的剖析，如有纰漏之处，欢迎指正，联系方式：<a href="mailto:rayo.wangzl@gmail.com" target="_blank" rel="noopener noreferrer">rayo.wangzl@gmail.com</a>。另外在此也希望大家能踊跃参与源码分析和开源社区来，一起学习，共同进步。</p>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[源码解析  layotto启动流程]]></title>
            <link>https://layotto.github.io/layotto/blog/code/start_process/start_process</link>
            <guid>https://layotto.github.io/layotto/blog/code/start_process/start_process</guid>
            <pubDate>Mon, 08 Jul 2024 02:29:46 GMT</pubDate>
            <description><![CDATA[作者简介：]]></description>
            <content:encoded><![CDATA[<blockquote>
<p>作者简介：
张立斌，<a href="https://github.com/ZLBer" target="_blank" rel="noopener noreferrer">https://github.com/ZLBer</a></p>
<p>写作时间: 2022年5月4日</p>
</blockquote>
<ul>
<li><a href="https://layotto.github.io/layotto/blog/code/start_process/start_process#Overview">Overview</a></li>
<li><a href="https://layotto.github.io/layotto/blog/code/start_process/start_process#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90">源码分析</a>
<ul>
<li><a href="https://layotto.github.io/layotto/blog/code/start_process/start_process#1.cmd%E5%88%86%E6%9E%90">1.cmd分析</a></li>
<li><a href="https://layotto.github.io/layotto/blog/code/start_process/start_process#2.%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0NewRuntimeGrpcServer%E5%88%86%E6%9E%90">2.回调函数NewRuntimeGrpcServer分析</a></li>
<li><a href="https://layotto.github.io/layotto/blog/code/start_process/start_process#3.runtime%E5%88%86%E6%9E%90">3.runtime分析</a></li>
</ul>
</li>
<li><a href="https://layotto.github.io/layotto/blog/code/start_process/start_process#%E6%80%BB%E7%BB%93">总结</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a class="hash-link" aria-label="Overview的直接链接" title="Overview的直接链接" href="https://layotto.github.io/layotto/blog/code/start_process/start_process#overview">​</a></h2>
<p>Layotto “寄生”在 MOSN 里，启动流程其实是先启动 MOSN, MOSN 在启动过程中回调 Layotto ，让 Layotto 启动。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="源码分析">源码分析<a class="hash-link" aria-label="源码分析的直接链接" title="源码分析的直接链接" href="https://layotto.github.io/layotto/blog/code/start_process/start_process#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90">​</a></h2>
<p>一切起源于我们的命令行: layotto start  -c  <code>configpath</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1cmd分析">1.cmd分析<a class="hash-link" aria-label="1.cmd分析的直接链接" title="1.cmd分析的直接链接" href="https://layotto.github.io/layotto/blog/code/start_process/start_process#1cmd%E5%88%86%E6%9E%90">​</a></h3>
<p>main 的 init 函数首先运行：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func init() {   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     //将layotto的初始化函数传给mosn，让mosn启动的时候进行回调</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mgrpc.RegisterServerHandler("runtime", NewRuntimeGrpcServer)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     ....</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>cmd 的 action 开始执行：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">	Action: func(c *cli.Context) error {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		app := mosn.NewMosn()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		//stagemanager用于管理mosn启动的每个阶段，可以添加相应的阶段函数，比如下面的ParamsParsedStage、InitStage、PreStartStage、AfterStartStage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		//这里是将configpath传给mosn，下面都是mosn相关的逻辑</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		stm := stagemanager.InitStageManager(c, c.String("config"), app) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		stm.AppendParamsParsedStage(ExtensionsRegister)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		stm.AppendParamsParsedStage(func(c *cli.Context) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			err := featuregate.Set(c.String("feature-gates"))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			if err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				os.Exit(1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		})·</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		stm.AppendInitStage(mosn.DefaultInitStage)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		stm.AppendPreStartStage(mosn.DefaultPreStartStage)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		stm.AppendStartStage(mosn.DefaultStartStage)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		//这里添加layotto的健康检查机制</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		stm.AppendAfterStartStage(SetActuatorAfterStart)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		stm.Run()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		// wait mosn finished</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		stm.WaitFinish()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		return nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	},</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2回调函数newruntimegrpcserver分析">2.回调函数NewRuntimeGrpcServer分析<a class="hash-link" aria-label="2.回调函数NewRuntimeGrpcServer分析的直接链接" title="2.回调函数NewRuntimeGrpcServer分析的直接链接" href="https://layotto.github.io/layotto/blog/code/start_process/start_process#2%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0newruntimegrpcserver%E5%88%86%E6%9E%90">​</a></h3>
<p>MOSN 启动的时候回调 NewRuntimeGrpcServer ，data 是未解析的配置文件，opts 是 grpc 的配置项，返回 Grpc server</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func NewRuntimeGrpcServer(data json.RawMessage, opts ...grpc.ServerOption) (mgrpc.RegisteredServer, error) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	// 将原始的配置文件解析成结构体形式。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	cfg, err := runtime.ParseRuntimeConfig(data)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 新建layotto runtime， runtime包含各种组件的注册器和各种组件的实例。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	rt := runtime.NewMosnRuntime(cfg)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	// 3.runtime开始启动</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	server, err := rt.Run(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	       ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4. 添加所有组件的初始化函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	 	// 我们只看下File组件的，将NewXXX()添加到组件Factory里</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		runtime.WithFileFactory(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			file.NewFileFactory("aliyun.oss", alicloud.NewAliCloudOSS),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			file.NewFileFactory("minio", minio.NewMinioOss),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			file.NewFileFactory("aws.s3", aws.NewAwsOss),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			file.NewFileFactory("tencent.oss", tencentcloud.NewTencentCloudOSS),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			file.NewFileFactory("local", local.NewLocalStore),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			file.NewFileFactory("qiniu.oss", qiniu.NewQiniuOSS),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	     ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   return server, err		 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	//</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3runtime分析">3.runtime分析<a class="hash-link" aria-label="3.runtime分析的直接链接" title="3.runtime分析的直接链接" href="https://layotto.github.io/layotto/blog/code/start_process/start_process#3runtime%E5%88%86%E6%9E%90">​</a></h3>
<p>看一下 runtime 的结构体，从整体上把握 runtime 的构成：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type MosnRuntime struct {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	// 包括组件的config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	runtimeConfig *MosnRuntimeConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	info          *info.RuntimeInfo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	srv           mgrpc.RegisteredServer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	// 组件注册器，用来注册和新建组件，里面有组件的NewXXX()函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	helloRegistry           hello.Registry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	configStoreRegistry     configstores.Registry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	rpcRegistry             rpc.Registry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	pubSubRegistry          runtime_pubsub.Registry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	stateRegistry           runtime_state.Registry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	lockRegistry            runtime_lock.Registry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	sequencerRegistry       runtime_sequencer.Registry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	fileRegistry            file.Registry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	bindingsRegistry        mbindings.Registry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	secretStoresRegistry    msecretstores.Registry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	customComponentRegistry custom.Registry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	hellos map[string]hello.HelloService</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	// 各种组件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	configStores map[string]configstores.Store</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	rpcs         map[string]rpc.Invoker</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	pubSubs      map[string]pubsub.PubSub</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	states          map[string]state.Store</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	files           map[string]file.File</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	locks           map[string]lock.LockStore</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	sequencers      map[string]sequencer.Store</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	outputBindings  map[string]bindings.OutputBinding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	secretStores    map[string]secretstores.SecretStore</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	customComponent map[string]map[string]custom.Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	AppCallbackConn *rawGRPC.ClientConn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	errInt            ErrInterceptor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	started           bool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	//初始化函数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	initRuntimeStages []initRuntimeStage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>runtime 的 run 函数逻辑如下:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func (m *MosnRuntime) Run(opts ...Option) (mgrpc.RegisteredServer, error) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	// 启动标志</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	m.started = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	// 新建runtime配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	o := newRuntimeOptions()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	//这里运行我们之前传入的option函数，其实就是将各种组件Factory注册进来</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	for _, opt := range opts {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		opt(o)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	//初始化组件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	if err := m.initRuntime(o); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		return nil, err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	//初始化Grpc，api赋值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	var grpcOpts []grpc.Option</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	if o.srvMaker != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		grpcOpts = append(grpcOpts, grpc.WithNewServer(o.srvMaker))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	var apis []grpc.GrpcAPI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ac := &amp;grpc.ApplicationContext{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		m.runtimeConfig.AppManagement.AppId,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		m.hellos,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		m.configStores,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		m.rpcs,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		m.pubSubs,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		m.states,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		m.files,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		m.locks,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		m.sequencers,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		m.sendToOutputBinding,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		m.secretStores,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		m.customComponent,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     //调用组件的factory生成每个组件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	for _, apiFactory := range o.apiFactorys {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		api := apiFactory(ac)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		// init the GrpcAPI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		if err := api.Init(m.AppCallbackConn); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			return nil, err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		apis = append(apis, api)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	// 将api接口和配置传给grpc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	grpcOpts = append(grpcOpts,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		grpc.WithGrpcOptions(o.options...),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		grpc.WithGrpcAPIs(apis),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	//启动grpc</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	var err error = nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	m.srv, err = grpc.NewGrpcServer(grpcOpts...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	return m.srv, err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>组件的初始化函数 initRuntime ：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func (m *MosnRuntime) initRuntime(r *runtimeOptions) error {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	st := time.Now()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	if len(m.initRuntimeStages) == 0 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		m.initRuntimeStages = append(m.initRuntimeStages, DefaultInitRuntimeStage)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	// 调用DefaultInitRuntimeStage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	for _, f := range m.initRuntimeStages {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		err := f(r, m)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		if err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	return nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>DefaultInitRuntimeStage 组件初始化逻辑，调用每个组件的 init 方法:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func DefaultInitRuntimeStage(o *runtimeOptions, m *MosnRuntime) error {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	 ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	 //初始化config/state/file/lock/sequencer/secret等各种组件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	if err := m.initCustomComponents(o.services.custom); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	if err := m.initHellos(o.services.hellos...); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	if err := m.initConfigStores(o.services.configStores...); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	if err := m.initStates(o.services.states...); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	if err := m.initRpcs(o.services.rpcs...); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	if err := m.initOutputBinding(o.services.outputBinding...); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	if err := m.initPubSubs(o.services.pubSubs...); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	if err := m.initFiles(o.services.files...); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	if err := m.initLocks(o.services.locks...); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	if err := m.initSequencers(o.services.sequencers...); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	if err := m.initInputBinding(o.services.inputBinding...); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	if err := m.initSecretStores(o.services.secretStores...); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	return nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以 file 组件为例，看下初始化函数：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func (m *MosnRuntime) initFiles(files ...*file.FileFactory) error {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	//将配置的组件注册进去</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	m.fileRegistry.Register(files...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	for name, config := range m.runtimeConfig.Files {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	    //create调用NewXXX()函数新建一个组件实例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		c, err := m.fileRegistry.Create(name)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		if err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			m.errInt(err, "create files component %s failed", name)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		if err := c.Init(context.TODO(), &amp;config); err != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			m.errInt(err, "init files component %s failed", name)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			return err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		//赋值给runtime</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		m.files[name] = c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	return nil</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>至此 MOSN、Grpc、Layotto 都已经启动完成，通过 Grpc 的接口就可以调用到组件的代码逻辑。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a class="hash-link" aria-label="总结的直接链接" title="总结的直接链接" href="https://layotto.github.io/layotto/blog/code/start_process/start_process#%E6%80%BB%E7%BB%93">​</a></h2>
<p>总览整个启动流程，Layotto 结合 MOSN 来做启动，解析配置文件，生成配置文件中的组件类，将 Grpc 的 api 暴露出去。</p>]]></content:encoded>
        </item>
        <item>
            <title><![CDATA[Layotto 源码解析 —— WebAssembly]]></title>
            <link>https://layotto.github.io/layotto/blog/code/webassembly</link>
            <guid>https://layotto.github.io/layotto/blog/code/webassembly</guid>
            <pubDate>Mon, 08 Jul 2024 02:29:46 GMT</pubDate>
            <description><![CDATA[本文主要分析 Layotto 中 WASM 的相关实现和应用。]]></description>
            <content:encoded><![CDATA[<blockquote>
<p>本文主要分析 Layotto 中 WASM 的相关实现和应用。</p>
<p>作者：<a href="https://github.com/rayowang" target="_blank" rel="noopener noreferrer">王志龙</a> | 2022年5月18日</p>
</blockquote>
<ul>
<li><a href="https://layotto.github.io/layotto/blog/code/webassembly#%E6%A6%82%E8%BF%B0">概述</a></li>
<li><a href="https://layotto.github.io/layotto/blog/code/webassembly#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90">源码分析</a>
<ul>
<li><a href="https://layotto.github.io/layotto/blog/code/webassembly#%E6%A1%86%E6%9E%B6INIT">框架INIT</a></li>
<li><a href="https://layotto.github.io/layotto/blog/code/webassembly#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B">工作流程</a></li>
<li><a href="https://layotto.github.io/layotto/blog/code/webassembly#FaaS%E6%A8%A1%E5%BC%8F">FaaS模式</a></li>
</ul>
</li>
<li><a href="https://layotto.github.io/layotto/blog/code/webassembly#%E6%80%BB%E7%BB%93">总结</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="概述">概述<a class="hash-link" aria-label="概述的直接链接" title="概述的直接链接" href="https://layotto.github.io/layotto/blog/code/webassembly#%E6%A6%82%E8%BF%B0">​</a></h2>
<p>WebAssemly 简称 WASM，是一种运行在沙箱化的执行环境中的可移植、体积小、加载快的二进制格式，WASM最初设计是为了在网络浏览器中实现高性能应用，得益于它良好的隔离性和安全性、多语言支持、冷启动快等灵活性和敏捷性等特性，又被应用于嵌入其它应用程序中以获得较好的扩展能力，显然我们可以将它嵌入到 Layotto 中。Layotto 支持加载编译好的 WASM 文件，并通过 proxy_abi_version_0_2_0 的 API 与目标 WASM 进行交互;
另外 Layotto 也支持加载并运行以 WASM 为载体的 Function，并支持 Function 之间互相调用以及访问基础设施；同时 Layotto 社区也正在探索把 component 编译成 WASM 模块以此来增强模块间的隔离性。本文以 Layotto 官方 <a href="https://mosn.io/layotto/#/zh/start/wasm/start" target="_blank" rel="noopener noreferrer">quickstart</a> 即访问redis相关示例为例来分析 Layotto 中 WebAssemly 相关的实现和应用。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="源码分析">源码分析<a class="hash-link" aria-label="源码分析的直接链接" title="源码分析的直接链接" href="https://layotto.github.io/layotto/blog/code/webassembly#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90">​</a></h2>
<p>备注：本文基于 commit hash：f1cf350a52b5a1a0b3788a31681007a056e332ef</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="框架init">框架INIT<a class="hash-link" aria-label="框架INIT的直接链接" title="框架INIT的直接链接" href="https://layotto.github.io/layotto/blog/code/webassembly#%E6%A1%86%E6%9E%B6init">​</a></h3>
<p>由于 Layotto 的底层是 Mosn，WASM 的扩展框架也是复用 Mosn 的 WASM 扩展框架，如图1 Layotto &amp; Mosn WASM 框架 [1] 所示。</p>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_5891a1/afts/img/A*jz4BSJmVQ3gAAAAAAAAAAAAAARQnAQ" alt="mosn_wasm_ext_framework_module" class="img_ev3q">
</p><center>图1 Layotto &amp; Mosn WASM 框架 </center><p></p>
<p>其中，Manager 负责对 WASM 插件进行管理和动态更新；VM 负责对 WASM 虚拟机、模块和实例进行管理；ABI 作为应用程序二进制接口，提供对外使用接口 [2]。</p>
<p>这里首先简单回顾下几个概念：<br>
<a href="https://github.com/proxy-wasm" target="_blank" rel="noopener noreferrer">Proxy-Wasm</a> ：WebAssembly for Proxies (ABI specification) 是一个代理无关的 ABI 标准，它约定了代理和 WASM 模块如何以函数和回调的形式互动 [3]。<br>
<a href="https://github.com/tetratelabs/proxy-wasm-go-sdk" target="_blank" rel="noopener noreferrer">proxy-wasm-go-sdk</a> ：定义了函数访问系统资源及基础设施服务的接口，基于 <a href="https://github.com/proxy-wasm/spec" target="_blank" rel="noopener noreferrer">proxy-wasm/spec</a> 实现，在此基础上结合 Runtime API 增加了对基础设施访问的 ABI。<br>
<a href="https://github.com/mosn/proxy-wasm-go-host" target="_blank" rel="noopener noreferrer">proxy-wasm-go-host</a> WebAssembly for Proxies (GoLang host implementation)：Proxy-Wasm 的 golang 实现，用以在 Layotto 中实现 Runtime ABI 的具体逻辑。<br>
<!-- -->VM：Virtual Machine 虚拟机，Runtime类型有：wasmtime、Wasmer、V8、 Lucet、WAMR、wasm3，本文例子中使用 wasmer</p>
<p>1、首先看 <a href="https://mosn.io/layotto/#/zh/start/wasm/start" target="_blank" rel="noopener noreferrer">quickstart例子</a> 中 stream filter 的配置，如下可以看到配置中有两个 WASM 插件，使用 wasmer VM 分别启动一个实例，详见如下配置：</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> "stream_filters": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              "type": "Layotto",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              "config": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                "function1": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  "name": "function1", // 插件名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  "instance_num": 1, // 沙箱实例个数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  "vm_config": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    "engine": "wasmer", // 虚拟机 Runtime 类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    "path": "demo/faas/code/golang/client/function_1.wasm" // wasm 文件路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                "function2": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  "name": "function2", // 插件名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  "instance_num": 1, // 沙箱实例个数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  "vm_config": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    "engine": "wasmer", // 虚拟机 Runtime 类型</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    "path": "demo/faas/code/golang/server/function_2.wasm" // wasm 文件路径</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上述配置中 function1 主要逻辑就是接收 HTTP 请求，然后通过 ABI 调用 function2，并返回 function2 结果，详见如下代码：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">httpHeaders</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">OnHttpRequestBody</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bodySize </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> endOfStream </span><span class="token builtin">bool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Action </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">//1. get request body</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	body</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> proxywasm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetHttpRequestBody</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bodySize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		proxywasm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">LogErrorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"GetHttpRequestBody failed: %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ActionPause</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">//2. parse request param</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	bookName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getQueryParam</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">body</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"name"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		proxywasm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">LogErrorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"param not found: %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ActionPause</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">//3. request function2 through ABI</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	inventories</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> proxywasm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">InvokeService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"id_2"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bookName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		proxywasm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">LogErrorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"invoke service failed: %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ActionPause</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">//4. return result</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	proxywasm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AppendHttpResponseBody</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token function" style="color:#d73a49">byte</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"There are "</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> inventories </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">" inventories for "</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> bookName </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"."</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ActionContinue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>function2 主要逻辑就是接收 HTTP 请求，然后通过 ABI 调用 redis，并返回 redis 结果，详见如下代码：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">httpHeaders</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">OnHttpRequestBody</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bodySize </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> endOfStream </span><span class="token builtin">bool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Action </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">//1. get request body</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	body</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> proxywasm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetHttpRequestBody</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bodySize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		proxywasm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">LogErrorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"GetHttpRequestBody failed: %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ActionPause</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	bookName </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">body</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">//2. get request state from redis by specific key through ABI</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	inventories</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> proxywasm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"redis"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bookName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		proxywasm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">LogErrorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"GetState failed: %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ActionPause</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">//3. return result</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	proxywasm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AppendHttpResponseBody</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token function" style="color:#d73a49">byte</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">inventories</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ActionContinue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>2、对应图1 WASM 框架 中的 Manager 部分，在 Mosn filter Init 阶段进行初始化，详见如下代码：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Create a proxy factory for WasmFilter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">createProxyWasmFilterFactory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">confs </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StreamFilterChainFactory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	factory </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">FilterConfigFactory</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">        </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">filterConfigItem</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">confs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		RootContextID</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		plugins</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">       </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">WasmPlugin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		router</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">        </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">Router</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">routes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Group</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> configID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> confIf </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> confs </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		conf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ok </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> confIf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">ok </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"[proxywasm][factory] createProxyWasmFilterFactory config not a map, configID: %s"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> configID</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> errors</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">New</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"config not a map"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// 解析 wasm filter 配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">parseFilterConfigItem</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">conf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"[proxywasm][factory] createProxyWasmFilterFactory fail to parse config, configID: %s, err: %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> configID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> pluginName </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FromWasmPlugin </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			pluginName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> utils</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GenerateUUID</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token comment" style="color:#999988;font-style:italic">// 根据 stream filter 的配置初始化 WASM 插件配置，VmConfig 即 vm_config，InstanceNum 即 instance_num</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			v2Config </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> v2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">WasmPluginConfig</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				PluginName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  pluginName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				VmConfig</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">    config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VmConfig</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				InstanceNum</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">InstanceNum</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token comment" style="color:#999988;font-style:italic">// WasmManager 实例通过管理 PluginWrapper 对象对所有插件的配置进行统一管理，提供增删查改能力。下接3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> wasm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetWasmManager</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AddOrUpdateWasm</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">v2Config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PluginName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pluginName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token function" style="color:#d73a49">addWatchFile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> factory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">continue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token function" style="color:#d73a49">addWatchFile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> factory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			pluginName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FromWasmPlugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PluginName </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pluginName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// PluginWrapper 在上面的 AddOrUpdateWasm 中对插件及配置进行封装完成初始化，这里根据插件名从 sync.Map 拿出，以管理并注册 PluginHandler</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		pw </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> wasm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetWasmManager</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetWasmPluginWrapperByName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pluginName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> pw </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> errors</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">New</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"plugin not found"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VmConfig </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pw</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VmConfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		factory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">factory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		wasmPlugin </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">WasmPlugin</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			pluginName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">    config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PluginName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			plugin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">        pw</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetPlugin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			rootContextID</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RootContextID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">        config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		factory</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">plugins</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PluginName</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> wasmPlugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// 注册 PluginHandler，以对插件的生命周期提供扩展回调能力，例如插件启动 OnPluginStart、更新 OnConfigUpdate。下接4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		pw</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">RegisterPluginHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">factory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> factory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>3、对应图1 WASM 框架中 VM 部分，NewWasmPlugin 用来创建初始化 WASM 插件，其中 VM、Module 和 Instance 分别对应 WASM 中的虚拟机、模块和实例，详见如下代码：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">NewWasmPlugin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">wasmConfig v2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">WasmPluginConfig</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">WasmPlugin</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// check instance num</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	instanceNum </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> wasmConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">InstanceNum</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> instanceNum </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		instanceNum </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> runtime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NumCPU</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	wasmConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">InstanceNum </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> instanceNum</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 根据配置获取 wasmer 编译和执行引擎</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	vm </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetWasmEngine</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">wasmConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VmConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Engine</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> vm </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"[wasm][plugin] NewWasmPlugin fail to get wasm engine: %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> wasmConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VmConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Engine</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ErrEngineNotFound</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// load wasm bytes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> wasmBytes </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">byte</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> wasmConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VmConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Path </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		wasmBytes </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">loadWasmBytesFromPath</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">wasmConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VmConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		wasmBytes </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">loadWasmBytesFromUrl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">wasmConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VmConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Url</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">wasmBytes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"[wasm][plugin] NewWasmPlugin fail to load wasm bytes, config: %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> wasmConfig</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ErrWasmBytesLoad</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	md5Bytes </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> md5</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">wasmBytes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	newMd5 </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> hex</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">EncodeToString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">md5Bytes</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> wasmConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VmConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Md5 </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		wasmConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VmConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Md5 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> newMd5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> newMd5 </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> wasmConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VmConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Md5 </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"[wasm][plugin] NewWasmPlugin the hash(MD5) of wasm bytes is incorrect, config: %v, real hash: %s"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			wasmConfig</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> newMd5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ErrWasmBytesIncorrect</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 创建 WASM 模块，WASM 模块是已被编译的无状态二进制代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	module </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> vm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewModule</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">wasmBytes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> module </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"[wasm][plugin] NewWasmPlugin fail to create module, config: %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> wasmConfig</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ErrModuleCreate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	plugin </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">wasmPluginImpl</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">    wasmConfig</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		vm</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">        vm</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		wasmBytes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> wasmBytes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		module</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">    module</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	plugin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetCpuLimit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">wasmConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VmConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Cpu</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	plugin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetMemLimit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">wasmConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VmConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Mem</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 创建包含模块和运行时状态的实例，值得关注的是，这里最终会调用 proxywasm.RegisterImports 注册用户实现的 Imports 函数，比如示例中的 proxy_invoke_service 和 proxy_get_state</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">actual </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> plugin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">EnsureInstanceNum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">wasmConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">InstanceNum</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> actual </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"[wasm][plugin] NewWasmPlugin fail to ensure instance num, want: %v got 0"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> instanceNum</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ErrInstanceCreate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> plugin</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>4、 对应图1 WASM 框架 中的 ABI 部分，OnPluginStart 方法中会调用 proxy-wasm-go-host 的对应方法对 ABI 的 Exports 和 Imports 等进行相关设置。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Execute the plugin of FilterConfigFactory</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">FilterConfigFactory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">OnPluginStart</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">plugin types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">WasmPlugin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	plugin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Exec</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">instance types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">WasmInstance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">bool</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		wasmPlugin</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ok </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">plugins</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">plugin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">PluginName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">ok </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"[proxywasm][factory] createProxyWasmFilterFactory fail to get wasm plugin, PluginName: %s"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				plugin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">PluginName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// 获取 proxy_abi_version_0_2_0 版本的与 WASM 交互的 API</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		a </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> abi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetABI</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">instance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> AbiV2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetABIImports</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		exports </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetABIExports</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Exports</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">LayottoHandler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Instance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> instance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		instance</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Lock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> instance</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Unlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// 使用 exports 函数 proxy_get_id（对应到 WASM 插件中 GetID 函数）获取 WASM 的 ID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> exports</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ProxyGetID</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"[proxywasm][factory] createProxyWasmFilterFactory fail to get wasm id, PluginName: %s, err: %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				plugin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">PluginName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// 把ID 和 对应的插件注册到路由中，即可通过 http Header 中的键值对进行路由，比如 'id:id_1' 就会根据 id_1 路由到上面的 Function1 </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">router</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">RegisterRoute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> wasmPlugin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// 当第一个插件使用给定的根 ID 加载时通过 proxy_on_context_create 创建根上下文，并在虚拟机的整个生命周期中持续存在，直到 proxy_on_delete 删除 </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// 值得注意的是这里说的第一个插件指的是多个松散绑定的插件(通过 SDK 使用 Root ID 对 Root Context 访问）在同一已配置虚拟机内共享数据的使用场景 [4]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> exports</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ProxyOnContextCreate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RootContextID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"[proxywasm][factory] OnPluginStart fail to create root context id, err: %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		vmConfigSize </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> vmConfigBytes </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> wasmPlugin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetVmConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> vmConfigBytes </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			vmConfigSize </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> vmConfigBytes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// VM 伴随启动的插件启动时调用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> exports</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ProxyOnVmStart</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RootContextID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">int32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vmConfigSize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"[proxywasm][factory] OnPluginStart fail to create root context id, err: %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		pluginConfigSize </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> pluginConfigBytes </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> wasmPlugin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetPluginConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> pluginConfigBytes </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			pluginConfigSize </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pluginConfigBytes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// 当插件加载或重新加载其配置时调用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> exports</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ProxyOnConfigure</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RootContextID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">int32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pluginConfigSize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"[proxywasm][factory] OnPluginStart fail to create root context id, err: %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="工作流程">工作流程<a class="hash-link" aria-label="工作流程的直接链接" title="工作流程的直接链接" href="https://layotto.github.io/layotto/blog/code/webassembly#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B">​</a></h3>
<p>Layotto 中 WASM 的工作流程大致如下图2 Layotto &amp; Mosn WASM 工作流程所示，其中配置更新在上述初始化环节基本已囊括，这里重点看一下请求处理流程。
<img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_5891a1/afts/img/A*XTDeRq0alYsAAAAAAAAAAAAAARQnAQ" alt="mosn_wasm_ext_framework_workflow" class="img_ev3q">
</p><center>图2 Layotto &amp; Mosn WASM 工作流程 </center><p></p>
<p>1、由 Layotto 底层 Mosn 收到请求，经过 workpool 调度，在 proxy downstream 中按照配置依次执行 StreamFilterChain 到 Wasm StreamFilter 的 OnReceive 方法，具体逻辑详见如下代码：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Filter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">OnReceive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> headers api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">HeaderMap</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> buf buffer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IoBuffer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> trailers api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">HeaderMap</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StreamFilterStatus </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 获取 WASM 插件的 id</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ok </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> headers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"id"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">ok </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"[proxywasm][filter] OnReceive call ProxyOnRequestHeaders no id in headers"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StreamFilterStop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 从 router 中根据 id 获取对应的 WASM 插件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	wasmPlugin</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">router</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetRandomPluginByID</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"[proxywasm][filter] OnReceive call ProxyOnRequestHeaders id, err: %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StreamFilterStop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pluginUsed </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> wasmPlugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	plugin </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> wasmPlugin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">plugin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 获取 WasmInstance 实例</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	instance </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> plugin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">instance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> instance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">LayottoHandler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Instance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> instance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// ABI 包含 导出(Exports)和导入(Imports)两个部分，用户通过这它们与 WASM 扩展插件进行交互</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	pluginABI </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> abi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetABI</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">instance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> AbiV2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> pluginABI </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"[proxywasm][filter] OnReceive fail to get instance abi"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		plugin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ReleaseInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">instance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StreamFilterStop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 设置导入 Imports 部分，导入部分由用户提供，虚拟机的执行需要依赖宿主机 Layotto 提供的部分能力，例如获取请求信息，这些能力通过导入部分由用户提供，并由 WASM 扩展调用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	pluginABI</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetABIImports</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 导出 Exports 部分由 WASM 插件提供，用户可直接调用——唤醒 WASM 虚拟机，并在虚拟机中执行对应的 WASM 插件代码</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	exports </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> pluginABI</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetABIExports</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Exports</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exports </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> exports</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	instance</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Lock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pluginABI</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> instance</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Unlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 根据 rootContextID 和 contextID 创建当前插件上下文</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> exports</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ProxyOnContextCreate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">contextID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> wasmPlugin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rootContextID</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"[proxywasm][filter] NewFilter fail to create context id: %v, rootContextID: %v, err: %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">contextID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> wasmPlugin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rootContextID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StreamFilterStop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	endOfStream </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">buf </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> buf</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> trailers </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		endOfStream </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 调用 proxy-wasm-go-host，编码请求头为规范指定的格式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	action</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> exports</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ProxyOnRequestHeaders</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">contextID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">int32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">headerMapSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">headers</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">int32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">endOfStream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> action </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> proxywasm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ActionContinue </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"[proxywasm][filter] OnReceive call ProxyOnRequestHeaders err: %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StreamFilterStop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	endOfStream </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> trailers </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		endOfStream </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> buf </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		arg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> variable</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VarHttpRequestArg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">requestBuffer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> buffer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewIoBufferString</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">requestBuffer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> buf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">requestBuffer </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">requestBuffer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// 调用 proxy-wasm-go-host，编码请求体为规范指定的格式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		action</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> exports</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ProxyOnRequestBody</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">contextID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">int32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">requestBuffer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">int32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">endOfStream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> action </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> proxywasm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ActionContinue </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"[proxywasm][filter] OnReceive call ProxyOnRequestBody err: %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StreamFilterStop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> trailers </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// 调用 proxy-wasm-go-host，编码请求尾为规范指定的格式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		action</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> exports</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ProxyOnRequestTrailers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">contextID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">int32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">headerMapSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">trailers</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> action </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> proxywasm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ActionContinue </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultLogger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"[proxywasm][filter] OnReceive call ProxyOnRequestTrailers err: %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StreamFilterStop</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> api</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StreamFilterContinue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>2、proxy-wasm-go-host 将 Mosn 请求三元组编码成规范指定的格式，并调用Proxy-Wasm ABI 规范中的 proxy_on_request_headers 等对应接口，调用 WASMER 虚拟机将请求信息传至 WASM 插件。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ABIContext</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CallWasmFunction</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">funcName </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> args </span><span class="token operator" style="color:#393A34">...</span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Action</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ff</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Instance</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetExportsFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">funcName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ActionContinue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 调用 wasmer 虚拟机（github.com/wasmerio/wasmer-go/wasmer.(*Function).Call at function.go）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	res</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> ff</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Call</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">args</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Instance</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">HandleError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ActionContinue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// if we have sync call, e.g. HttpCall, then unlock the wasm instance and wait until it resp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	action </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Imports</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Wait</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> res</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> action</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>3、WASMER 虚拟机经过处理调用 WASM 插件的具体函数，比如例子中的 OnHttpRequestBody 函数
// function, <em>:= instance.Exports.GetFunction("exported_function")
// nativeFunction = function.Native()
//</em> = nativeFunction(1, 2, 3)
// Native 会将 Function 转换为可以调用的原生 Go 函数</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Function</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Native</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> NativeFunction </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lazyNative </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">receivedParameters </span><span class="token operator" style="color:#393A34">...</span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		numberOfReceivedParameters </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">receivedParameters</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		numberOfExpectedParameters </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">expectedParameters</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		results </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> C</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">wasm_val_vec_t</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		C</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">wasm_val_vec_new_uninitialized</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">results</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> C</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">size_t</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ty</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Results</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> C</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">wasm_val_vec_delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">results</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		arguments </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> C</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">wasm_val_vec_t</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> C</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">wasm_val_vec_delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">arguments</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> numberOfReceivedParameters </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			C</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">wasm_val_vec_new</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">arguments</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> C</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">size_t</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">numberOfReceivedParameters</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">C</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">wasm_val_t</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unsafe</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Pointer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">allArguments</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// 调用 WASM 插件内函数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		trap </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> C</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">wasm_func_call</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">inner</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">arguments</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">results</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		runtime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">KeepAlive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">arguments</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		runtime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">KeepAlive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">results</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lazyNative</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>4、proxy-wasm-go-sdk 将请求数据从规范格式转换为便于用户使用的格式，然后调用用户扩展代码。proxy-wasm-go-sdk 基于 proxy-wasm/spec 实现，定义了函数访问系统资源及基础设施服务的接口，并在此基础上结合 Runtime API 的思路，增加了对基础设施访问的ABI。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// function1主要逻辑就是接收 HTTP 请求，然后通过 ABI 调用 function2，并返回 function2 结果，具体代码如下所示</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">httpHeaders</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">OnHttpRequestBody</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bodySize </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> endOfStream </span><span class="token builtin">bool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Action </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">//1. get request body</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	body</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> proxywasm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetHttpRequestBody</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bodySize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		proxywasm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">LogErrorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"GetHttpRequestBody failed: %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ActionPause</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">//2. parse request param</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	bookName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getQueryParam</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">body</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"name"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		proxywasm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">LogErrorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"param not found: %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ActionPause</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">//3. request function2 through ABI</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	inventories</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> proxywasm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">InvokeService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"id_2"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bookName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		proxywasm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">LogErrorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"invoke service failed: %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ActionPause</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">//4. return result</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	proxywasm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AppendHttpResponseBody</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token function" style="color:#d73a49">byte</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"There are "</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> inventories </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">" inventories for "</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> bookName </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"."</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ActionContinue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>5、WASM 插件通过初始化时 RegisterFunc 注册的 ABI Imports 函数，比如例子中 Function1 RPC 调用 Function2 的 ProxyInvokeService，Function2 用以获取 Redis 中指定 Key 的 Valye 的 ProxyGetState，具体代码如下所示：</p>
<p>Function1 通过 ProxyInvokeService 调用 Function2，ProxyInvokeService 对应 Imports 函数 proxy_invoke_service</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ProxyInvokeService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">instance common</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">WasmInstance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> idPtr </span><span class="token builtin">int32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> idSize </span><span class="token builtin">int32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> methodPtr </span><span class="token builtin">int32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> methodSize </span><span class="token builtin">int32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> paramPtr </span><span class="token builtin">int32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> paramSize </span><span class="token builtin">int32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> resultPtr </span><span class="token builtin">int32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> resultSize </span><span class="token builtin">int32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">int32</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> instance</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetMemory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">uint64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">idPtr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">uint64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">idSize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> WasmResultInvalidMemoryAccess</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Int32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	method</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> instance</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetMemory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">uint64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">methodPtr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">uint64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">methodSize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> WasmResultInvalidMemoryAccess</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Int32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	param</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> instance</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetMemory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">uint64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">paramPtr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">uint64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">paramSize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> WasmResultInvalidMemoryAccess</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Int32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ctx </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getImportHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">instance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// Laytto rpc calls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ret</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> res </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">InvokeService</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">method</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">param</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> res </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> WasmResultOk </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Int32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">copyIntoInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">instance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ret</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> resultPtr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> resultSize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Int32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Function2 通过 ProxyGetState 获取 Redis 中指定 Key 的 Valye， ProxyGetState 对应 Imports 函数 proxy_get_state</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ProxyGetState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">instance common</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">WasmInstance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> storeNamePtr </span><span class="token builtin">int32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> storeNameSize </span><span class="token builtin">int32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> keyPtr </span><span class="token builtin">int32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> keySize </span><span class="token builtin">int32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> valuePtr </span><span class="token builtin">int32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> valueSize </span><span class="token builtin">int32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">int32</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	storeName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> instance</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetMemory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">uint64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">storeNamePtr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">uint64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">storeNameSize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> WasmResultInvalidMemoryAccess</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Int32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> instance</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetMemory</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">uint64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">keyPtr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">uint64</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">keySize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> WasmResultInvalidMemoryAccess</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Int32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ctx </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getImportHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">instance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ret</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> res </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> ctx</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">storeName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> res </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> WasmResultOk </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Int32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">copyIntoInstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">instance</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ret</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> valuePtr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> valueSize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Int32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>以上 Layotto rpc 流程简要说是通过两个虚拟连接借助 Dapr API 和 底层 Mosn 实现 [5],具体可参见前序文章<a href="https://mosn.io/layotto/#/zh/blog/code/layotto-rpc/index" target="_blank" rel="noopener noreferrer">Layotto源码解析——处理RPC请求</a>，从 Redis 中获取数据可直接阅读 Dapr State 相关代码，在此不一一展开了。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="faas模式">FaaS模式<a class="hash-link" aria-label="FaaS模式的直接链接" title="FaaS模式的直接链接" href="https://layotto.github.io/layotto/blog/code/webassembly#faas%E6%A8%A1%E5%BC%8F">​</a></h3>
<p>回过头来再看 WASM 的特性：字节码有与机器码相匹敌的性能；沙箱中执行保证良好的隔离性和安全性；编译后跨平台、易分发和加载运行；具备轻量且多语言开发的灵活性，似乎天然的就适合做 FaaS。</p>
<p>所以 Layotto 也探索支持了 WASM FaaS 模式，即加载并运行以 WASM 为载体的 Function，并支持 Function 之间相互调用及访问基础设施。因加载 WASM 的核心逻辑并未变化，只是使用和部署方式上与上述方式有差别，故 Layotto 加载 WASM 部分逻辑不再赘述。</p>
<p>除 Wasm-Proxy 相关实现外，FaaS 模式核心逻辑是通过扩展 Containerd 实现多运行时插件 containerd-shim-layotto-v2 [6]，并借此"穿针引线"的巧妙的利用了 Docker 的镜像能力来管理 *.wasm 包和 Kubernetes 优秀的编排能力来调度函数，具体架构和工作流可见图3 Layotto FaaS Workflow。</p>
<p><img decoding="async" loading="lazy" src="https://gw.alipayobjects.com/mdn/rms_5891a1/afts/img/A*XWmNT6-7FoEAAAAAAAAAAAAAARQnAQ" alt="layotto_faas_workflow" class="img_ev3q">
</p><center>图3 Layotto FaaS Workflow </center><p></p>
<p>这里简单看一下 containerd-shim-layotto-v2 的主函数，可以看到 shim.Run 设置的 WASM 的运行时为 io.containerd.layotto.v2，也就是 containerd 中 plugins.cri.containerd.runtimes 对应插件的 runtime_type。当创建 Pod 时，在 yaml 的 spec 中指定 runtimeClassName: layotto，经过调度，最终 kubelet 就会通过 cri-plugin 调用 containerd 中的 containerd-shim-layotto-v2 运行时来进行加载和运行等相关处理。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">startLayotto</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 解析输入参数，初始化运行时环境，调用 wasm.New 实例化 service 对象 </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	shim</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"io.containerd.layotto.v2"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> wasm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">New</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">startLayotto</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	conn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> net</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Dial</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"tcp"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"localhost:2045"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		conn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Close</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	cmd </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> exec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Command</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"layotto"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"start"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"-c"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"/home/docker/config.json"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	cmd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a class="hash-link" aria-label="总结的直接链接" title="总结的直接链接" href="https://layotto.github.io/layotto/blog/code/webassembly#%E6%80%BB%E7%BB%93">​</a></h2>
<p>Layotto WebAssemly 虽然涉及较多 WASM 相关的基础知识，但通过示例由浅入深，循序渐进也不难理解。最后整体看一下 WASM 技术，可以看到它已经被应用到Web前端、Serverless、游戏场景、边缘计算、服务网格等很多领域，甚至就连 Docker 之父 Solomon Hykes 在前不久都表示: "如果 WASM 这个技术在2008年就有的话，我就不搞Docker了"（后来又补充道：Docker 不会被替换，会与 WASM 并肩而行），不管怎么说，WASM 似乎在继 VM 和 Container 之后，正在成为更轻量及性能更好的云原生技术而被应用到更多的领域，与此同时，相信在 Mosn 社区的推动以及 Layotto 的继续探索中 WASM 也会有更多使用场景和用户，至此 Layotto WebAssemly 相关源码分析就完了，鉴于时间和篇幅，没有进行一些更全面和深入的剖析，如有纰漏之处，欢迎指正，联系方式：<a href="mailto:rayo.wangzl@gmail.com" target="_blank" rel="noopener noreferrer">rayo.wangzl@gmail.com</a>。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="参考资料">参考资料<a class="hash-link" aria-label="参考资料的直接链接" title="参考资料的直接链接" href="https://layotto.github.io/layotto/blog/code/webassembly#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99">​</a></h3>
<ul>
<li>[1] <a href="https://mosn.io/blog/posts/mosn-wasm-framework/" target="_blank" rel="noopener noreferrer">WebAssembly 在 MOSN 中的实践</a></li>
<li>[2] <a href="https://github.com/mosn/mosn/pull/1589" target="_blank" rel="noopener noreferrer">feature: WASM plugin framework</a></li>
<li>[3] <a href="https://github.com/proxy-wasm/spec" target="_blank" rel="noopener noreferrer">WebAssembly for Proxies (ABI Spec)</a></li>
<li>[4] <a href="https://techhenzy.com/proxy-webassembly-architecture/" target="_blank" rel="noopener noreferrer">Proxy WebAssembly Architecture</a></li>
<li>[5] <a href="https://mosn.io/layotto/#/zh/blog/code/layotto-rpc/index" target="_blank" rel="noopener noreferrer">Layotto源码解析——处理RPC请求</a></li>
<li>[6] <a href="https://www.sofastack.tech/blog/the-next-five-years-of-cloud-native-runtime/" target="_blank" rel="noopener noreferrer">云原生运行时的下一个五年</a></li>
</ul>]]></content:encoded>
        </item>
    </channel>
</rss>
"use strict";(self.webpackChunklayotto_docusaurus=self.webpackChunklayotto_docusaurus||[]).push([[2370],{5808:(e,t,s)=>{s.r(t),s.d(t,{assets:()=>l,contentTitle:()=>r,default:()=>h,frontMatter:()=>o,metadata:()=>a,toc:()=>c});var n=s(4848),i=s(8453);const o={},r="Use Pub/Sub API to implement pub/sub pattern",a={id:"start/pubsub/start",title:"Use Pub/Sub API to implement pub/sub pattern",description:"What is Pub/Sub API",source:"@site/i18n/en-US/docusaurus-plugin-content-docs/current/start/pubsub/start.md",sourceDirName:"start/pubsub",slug:"/start/pubsub/start",permalink:"/layotto/en-US/docs/start/pubsub/start",draft:!1,unlisted:!1,editUrl:"https://github.com/mosn/layotto/edit/main/start/pubsub/start.md",tags:[],version:"current",frontMatter:{},sidebar:"mySidebar",previous:{title:"Configuration API demo with Nacos",permalink:"/layotto/en-US/docs/start/configuration/start-nacos"},next:{title:"DelayQueue API demo",permalink:"/layotto/en-US/docs/start/delay_queue/start"}},l={},c=[{value:"What is Pub/Sub API",id:"what-is-pubsub-api",level:2},{value:"Quick start",id:"quick-start",level:2},{value:"Step 1. Start the Subscriber",id:"step-1-start-the-subscriber",level:3},{value:"<strong>Go</strong>",id:"go",level:4},{value:"<strong>Java</strong>",id:"java",level:4},{value:"Step 2. Deploy Redis and Layotto",id:"step-2-deploy-redis-and-layotto",level:3},{value:"<strong>with Docker Compose</strong>",id:"with-docker-compose",level:4},{value:"<strong>Compile locally (not for Windows)</strong>",id:"compile-locally-not-for-windows",level:4},{value:"step 2.1. Run Redis with Docker",id:"step-21-run-redis-with-docker",level:4},{value:"Step 2.2. Run Layotto",id:"step-22-run-layotto",level:4},{value:"Step 3. Run the Publisher program and call Layotto to publish events",id:"step-3-run-the-publisher-program-and-call-layotto-to-publish-events",level:3},{value:"<strong>Go</strong>",id:"go-1",level:4},{value:"<strong>Java</strong>",id:"java-1",level:4},{value:"Step 4. Check the event message received by the subscriber",id:"step-4-check-the-event-message-received-by-the-subscriber",level:3},{value:"step 5. Stop containers and release resources",id:"step-5-stop-containers-and-release-resources",level:3},{value:"<strong>Docker Compose</strong>",id:"docker-compose",level:4},{value:"<strong>Destroy the Redis container</strong>",id:"destroy-the-redis-container",level:4},{value:"Next Step",id:"next-step",level:3},{value:"What did this client Demo do?",id:"what-did-this-client-demo-do",level:4},{value:"Details later, let&#39;s continue to experience other APIs",id:"details-later-lets-continue-to-experience-other-apis",level:4},{value:"Understand the principle of Pub/Sub API implementation",id:"understand-the-principle-of-pubsub-api-implementation",level:4}];function d(e){const t={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t.h1,{id:"use-pubsub-api-to-implement-pubsub-pattern",children:"Use Pub/Sub API to implement pub/sub pattern"}),"\n",(0,n.jsx)(t.h2,{id:"what-is-pubsub-api",children:"What is Pub/Sub API"}),"\n",(0,n.jsx)(t.p,{children:"Developers often use message queues (such as open source Rocket MQ, Kafka, such as AWS SNS/SQS provided by cloud vendors) to implement message publishing and subscription. The publish-subscribe model can help applications better decouple and cope with peak traffic."}),"\n",(0,n.jsx)(t.p,{children:"Unfortunately, the APIs of these message queue products are different. When developers want to deploy their apps across clouds, or want their apps to be portable (for example, easily moving from Alibaba Cloud to Tencent Cloud), they have to refactor their code."}),"\n",(0,n.jsx)(t.p,{children:'The design goal of Layotto Pub/Sub API is to define a unified message publish/subscribe API. The application only needs to care about the API, and does not need to care about the specific message queue product being used, so that the application can be transplanted at will, and the application is sufficiently "cloud native" .'}),"\n",(0,n.jsx)(t.h2,{id:"quick-start",children:"Quick start"}),"\n",(0,n.jsx)(t.p,{children:"This example shows how to call redis through Layotto to publish/subscribe messages."}),"\n",(0,n.jsx)(t.p,{children:"The architecture of this example is shown in the figure below. The running processes are: redis, a Subscriber program that listens to events, Layotto, and a Publisher program that publishes events."}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.img,{alt:"img_1.png",src:s(7240).A+"",width:"489",height:"253"})}),"\n",(0,n.jsx)(t.h3,{id:"step-1-start-the-subscriber",children:"Step 1. Start the Subscriber"}),"\n",(0,n.jsx)(t.h4,{id:"go",children:(0,n.jsx)(t.strong,{children:"Go"})}),"\n",(0,n.jsx)(t.p,{children:"Build the golang subscriber"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-shell",children:" cd demo/pubsub/server/\n go build -o subscriber\n"})}),"\n",(0,n.jsx)(t.p,{children:"Start subscriber:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-shell",metastring:"@background",children:" ./subscriber -s pub_subs_demo\n"})}),"\n",(0,n.jsx)(t.h4,{id:"java",children:(0,n.jsx)(t.strong,{children:"Java"})}),"\n",(0,n.jsx)(t.p,{children:"Download the java sdk and examples:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:"git clone https://github.com/layotto/java-sdk\n"})}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:"cd java-sdk\n"})}),"\n",(0,n.jsx)(t.p,{children:"Build and run it:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:"# build example jar\nmvn -f examples-pubsub-subscriber/pom.xml clean package\n# run the example\njava -jar examples-pubsub-subscriber/target/examples-pubsub-subscriber-jar-with-dependencies.jar\n"})}),"\n",(0,n.jsx)(t.p,{children:"If the following information is printed out, it means the startup is successful:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:"Start listening on port 9999 ...... \n"})}),"\n",(0,n.jsxs)(t.blockquote,{children:["\n",(0,n.jsx)(t.p,{children:"[!TIP|label: What did this subscriber do]\nThe Subscriber program started a gRPC server and exported two gRPC API:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:"ListTopicSubscriptions"}),"\n"]}),"\n",(0,n.jsx)(t.p,{children:'Calling this API will return the topics subscribed by the application. This program will return "topic1" and "hello"'}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:"OnTopicEvent"}),"\n"]}),"\n",(0,n.jsx)(t.p,{children:"When a new event occurs, Layotto will call this API to notify the Subscriber of the new event."}),"\n",(0,n.jsx)(t.p,{children:"After the program receives a new event, it will print the event to the command line."}),"\n"]}),"\n",(0,n.jsx)(t.h3,{id:"step-2-deploy-redis-and-layotto",children:"Step 2. Deploy Redis and Layotto"}),"\n",(0,n.jsx)(t.h4,{id:"with-docker-compose",children:(0,n.jsx)(t.strong,{children:"with Docker Compose"})}),"\n",(0,n.jsx)(t.p,{children:"You can start Redis and Layotto with docker-compose"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:"cd docker/layotto-redis\n# Start redis and layotto with docker-compose\ndocker-compose up -d\n"})}),"\n",(0,n.jsx)(t.h4,{id:"compile-locally-not-for-windows",children:(0,n.jsx)(t.strong,{children:"Compile locally (not for Windows)"})}),"\n",(0,n.jsx)(t.p,{children:"You can run Redis with Docker, then compile and run Layotto locally."}),"\n",(0,n.jsxs)(t.blockquote,{children:["\n",(0,n.jsx)(t.p,{children:"[!TIP|label: Not for Windows users]\nLayotto fails to compile under Windows. Windows users are recommended to deploy using docker-compose"}),"\n"]}),"\n",(0,n.jsx)(t.h4,{id:"step-21-run-redis-with-docker",children:"step 2.1. Run Redis with Docker"}),"\n",(0,n.jsx)(t.p,{children:"We can use the following command to run the Redis container:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-shell",children:"docker run -itd --name redis-test -p 6380:6379 redis\n"})}),"\n",(0,n.jsx)(t.p,{children:"Parameter Description:"}),"\n",(0,n.jsxs)(t.p,{children:[(0,n.jsx)(t.code,{children:"-p 6380:6379"}),": Map port 6379 of the container to port 6380 of the host. The outside can directly access the Redis service through the host ip:6380."]}),"\n",(0,n.jsx)(t.h4,{id:"step-22-run-layotto",children:"Step 2.2. Run Layotto"}),"\n",(0,n.jsx)(t.p,{children:"After downloading the project code to the local, switch the code directory and compile:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-shell",children:"cd ${project_path}/cmd/layotto\n"})}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-shell",metastring:"@if.not.exist layotto",children:"go build\n"})}),"\n",(0,n.jsx)(t.p,{children:"After completion, the layotto file will be generated in the directory, run it:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-shell",metastring:"@background",children:"./layotto start -c ../../configs/config_redis.json\n"})}),"\n",(0,n.jsx)(t.h3,{id:"step-3-run-the-publisher-program-and-call-layotto-to-publish-events",children:"Step 3. Run the Publisher program and call Layotto to publish events"}),"\n",(0,n.jsx)(t.h4,{id:"go-1",children:(0,n.jsx)(t.strong,{children:"Go"})}),"\n",(0,n.jsx)(t.p,{children:"Build the golang publisher:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-shell",children:" cd ${project_path}/demo/pubsub/client/\n go build -o publisher\n ./publisher -s pub_subs_demo\n"})}),"\n",(0,n.jsx)(t.h4,{id:"java-1",children:(0,n.jsx)(t.strong,{children:"Java"})}),"\n",(0,n.jsx)(t.p,{children:"Download the java sdk and examples:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-shell",metastring:"@if.not.exist java-sdk",children:"git clone https://github.com/layotto/java-sdk\n"})}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-shell",children:"cd java-sdk\n"})}),"\n",(0,n.jsx)(t.p,{children:"Build:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-shell",metastring:"@if.not.exist examples-pubsub-publisher/target/examples-pubsub-publisher-jar-with-dependencies.jar",children:"# build example jar\nmvn -f examples-pubsub-publisher/pom.xml clean package\n"})}),"\n",(0,n.jsx)(t.p,{children:"Run it:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-shell",children:"# run the example\njava -jar examples-pubsub-publisher/target/examples-pubsub-publisher-jar-with-dependencies.jar\n"})}),"\n",(0,n.jsx)(t.p,{children:"If the following information is printed, the call is successful:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:"Published a new event.Topic: hello ,Data: world\nPublished a new event.Topic: topic1 ,Data: value1\n"})}),"\n",(0,n.jsx)(t.h3,{id:"step-4-check-the-event-message-received-by-the-subscriber",children:"Step 4. Check the event message received by the subscriber"}),"\n",(0,n.jsx)(t.p,{children:"Go back to the subscriber's command line and you will see that a new message has been received:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:"Start listening on port 9999 ......\nReceived a new event.Topic: topic1 , Data: value1\nReceived a new event.Topic: hello , Data: world\n"})}),"\n",(0,n.jsx)(t.h3,{id:"step-5-stop-containers-and-release-resources",children:"step 5. Stop containers and release resources"}),"\n",(0,n.jsx)(t.h4,{id:"docker-compose",children:(0,n.jsx)(t.strong,{children:"Docker Compose"})}),"\n",(0,n.jsx)(t.p,{children:"If you started Redis and Layotto with docker-compose, you can shut them down as follows:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:"cd ${project_path}/docker/layotto-redis\ndocker-compose stop\n"})}),"\n",(0,n.jsx)(t.h4,{id:"destroy-the-redis-container",children:(0,n.jsx)(t.strong,{children:"Destroy the Redis container"})}),"\n",(0,n.jsx)(t.p,{children:"If you started Redis with Docker, you can destroy the Redis container as follows:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-shell",children:"docker rm -f redis-test\n"})}),"\n",(0,n.jsx)(t.h3,{id:"next-step",children:"Next Step"}),"\n",(0,n.jsx)(t.h4,{id:"what-did-this-client-demo-do",children:"What did this client Demo do?"}),"\n",(0,n.jsx)(t.p,{children:"The demo client program uses the golang version SDK provided by Layotto, calls Layotto Pub/Sub API, and publishes events to redis. Later, Layotto received the new events in redis, and sent the new events back to the callback API opened by the Subscriber program to notify the Subscriber."}),"\n",(0,n.jsxs)(t.p,{children:["The sdk is located in the ",(0,n.jsx)(t.code,{children:"sdk"})," directory, and users can call the API provided by Layotto through the sdk."]}),"\n",(0,n.jsx)(t.p,{children:"In addition to using sdk, you can also interact with Layotto directly through grpc in any language you like."}),"\n",(0,n.jsx)(t.p,{children:"In fact, sdk is only a very thin package for grpc, using sdk is about equal to directly using grpc."}),"\n",(0,n.jsx)(t.h4,{id:"details-later-lets-continue-to-experience-other-apis",children:"Details later, let's continue to experience other APIs"}),"\n",(0,n.jsx)(t.p,{children:"Explore other Quickstarts through the navigation bar on the left."}),"\n",(0,n.jsx)(t.h4,{id:"understand-the-principle-of-pubsub-api-implementation",children:"Understand the principle of Pub/Sub API implementation"}),"\n",(0,n.jsxs)(t.p,{children:["If you are interested in the implementation principle, or want to extend some functions, you can read ",(0,n.jsx)(t.a,{href:"/layotto/en-US/docs/design/pubsub/pubsub-api-and-compability-with-dapr-component",children:"Pub/Sub API design document"})]})]})}function h(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(d,{...e})}):d(e)}},7240:(e,t,s)=>{s.d(t,{A:()=>n});const n=s.p+"assets/images/img_1-a77af1bb1f9614c443aa9f8fdc7bbd4f.png"},8453:(e,t,s)=>{s.d(t,{R:()=>r,x:()=>a});var n=s(6540);const i={},o=n.createContext(i);function r(e){const t=n.useContext(o);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),n.createElement(o.Provider,{value:t},e.children)}}}]);
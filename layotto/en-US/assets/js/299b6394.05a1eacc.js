"use strict";(self.webpackChunklayotto_docusaurus=self.webpackChunklayotto_docusaurus||[]).push([[3599],{6665:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>p,frontMatter:()=>s,metadata:()=>a,toc:()=>d});var o=t(4848),i=t(8453);const s={},r="Component Development Guide",a={id:"development/developing-component",title:"Component Development Guide",description:"Thank you for your support in Layotto!",source:"@site/i18n/en-US/docusaurus-plugin-content-docs/current/development/developing-component.md",sourceDirName:"development",slug:"/development/developing-component",permalink:"/en-US/docs/development/developing-component",draft:!1,unlisted:!1,editUrl:"https://github.com/mosn/layotto/edit/main/development/developing-component.md",tags:[],version:"current",frontMatter:{},sidebar:"mySidebar",previous:{title:"Automate testing of Quickstart documentation with tools",permalink:"/en-US/docs/development/test-quickstart"},next:{title:"layotto component reference",permalink:"/en-US/docs/development/component_ref/"}},c={},d=[{value:"1\u3001Preparation Work",id:"1preparation-work",level:2},{value:"2\u3001Development Components and Unit Tests",id:"2development-components-and-unit-tests",level:2},{value:"2.1.Create a new folder under Components/API directory to develop your components",id:"21create-a-new-folder-under-componentsapi-directory-to-develop-your-components",level:3},{value:"2.2. Copy and Paste Other Components",id:"22-copy-and-paste-other-components",level:3},{value:"2.3. Write Unit Tests!",id:"23-write-unit-tests",level:3},{value:"2.3.1. Unit testing tips",id:"231-unit-testing-tips",level:4},{value:"2.3.2. How to mock out dependencies in the environment when running unit tests? (Such as Mock ZooKeeper or Mock Redis)",id:"232-how-to-mock-out-dependencies-in-the-environment-when-running-unit-tests-such-as-mock-zookeeper-or-mock-redis",level:4},{value:"3\u3001Register components when Layotto starts",id:"3register-components-when-layotto-starts",level:2},{value:"3.1. Import your components in main.go",id:"31-import-your-components-in-maingo",level:3},{value:"3.2. Register your component in the NewRuntimeGrpcServer function of main.go",id:"32-register-your-component-in-the-newruntimegrpcserver-function-of-maingo",level:3},{value:"4\u3001Add demo for integration test",id:"4add-demo-for-integration-test",level:2},{value:"4.1. Add a sample configuration file",id:"41-add-a-sample-configuration-file",level:3},{value:"4.2. Add client Demo",id:"42-add-client-demo",level:3},{value:"a. If the component has a generic client, it doesn&#39;t need to be developed",id:"a-if-the-component-has-a-generic-client-it-doesnt-need-to-be-developed",level:4},{value:"b. If the component does not have a generic client or requires custom metadata arguments, copy and paste them",id:"b-if-the-component-does-not-have-a-generic-client-or-requires-custom-metadata-arguments-copy-and-paste-them",level:4},{value:"4.3. Refer to the QuickStart documentation to start Layotto and Demo and see if any errors are reported",id:"43-refer-to-the-quickstart-documentation-to-start-layotto-and-demo-and-see-if-any-errors-are-reported",level:3},{value:"5\u3001New component description documents",id:"5new-component-description-documents",level:2}];function l(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.h1,{id:"component-development-guide",children:"Component Development Guide"}),"\n",(0,o.jsx)(n.p,{children:"Thank you for your support in Layotto!"}),"\n",(0,o.jsxs)(n.p,{children:["This is a Layotto components development guide. Layotto components are written in Go. If you are unfamiliar with Go, check out here ",(0,o.jsx)(n.a,{href:"https://tour.golang.org/welcome/1",children:"Go tutorial"}),"."]}),"\n",(0,o.jsx)(n.p,{children:"When developing new components, you can refer to the existing components. For example, if you want to implement distributed lock API with ZooKeeper, you can refer to the realization of the redis, related demos, and design documents to make your development easier."}),"\n",(0,o.jsx)(n.h2,{id:"1preparation-work",children:"1\u3001Preparation Work"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsx)(n.li,{children:"Git clone the repository to your preferred directory"}),"\n",(0,o.jsxs)(n.li,{children:["Use Docker to launch the environment you need. For example, if you want to develop a distributed lock API with ZooKeeper, you need to start a ZooKeeper container locally with Docker for local tests.\nIf you do not have Docker locally, you can install a Docker Desktop by following ",(0,o.jsx)(n.a,{href:"https://www.runoob.com/docker/windows-docker-install.html",children:"Docker Desktop tutorial"}),". Mac and Windows are both supported which is easy to use."]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"2development-components-and-unit-tests",children:"2\u3001Development Components and Unit Tests"}),"\n",(0,o.jsx)(n.h3,{id:"21create-a-new-folder-under-componentsapi-directory-to-develop-your-components",children:"2.1.Create a new folder under Components/API directory to develop your components"}),"\n",(0,o.jsx)(n.p,{children:"The folder name can use the component name, referring to the redis component below"}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"img.png",src:t(7716).A+"",width:"505",height:"383"})}),"\n",(0,o.jsx)(n.p,{children:"Tools you may use in the process of development (for the purpose of reference only, hope to simplify the development) :"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"When staring a new goroutine, panic triggered in it may lead to a panic breakdown to the entire server. Therefore, it is common to start a goroutine with recover() inside deferred functions. You can also use the encapsulated utility classes, like utils.GoWithRecover in mosn.io/pkg/utils/goroutine.go"}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"log.DefaultLogger is a commonly used logging tool, and it is located in mosn.io/pkg/log/errorlog.go"}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Others: There are utility classes under pkg/common and mosn.io/pkg directory"}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(n.h3,{id:"22-copy-and-paste-other-components",children:"2.2. Copy and Paste Other Components"}),"\n",(0,o.jsx)(n.p,{children:"You can simply copy and paste other components for modification or development. For example, if you want to implement the distributed lock API using ZooKeeper, you can copy and paste the Redis component"}),"\n",(0,o.jsx)(n.h3,{id:"23-write-unit-tests",children:"2.3. Write Unit Tests!"}),"\n",(0,o.jsx)(n.h4,{id:"231-unit-testing-tips",children:"2.3.1. Unit testing tips"}),"\n",(0,o.jsx)(n.p,{children:"Unit tests will be run in various environments, including the docker provided by github action and other developers' computers. Thus, following problems need to be considered to run unit tests normally:"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Other people may not have ZooKeeper installed in their environments. So when we write a unit test, either mock out the network call code (for example, mock out the part of the ZooKeeper code in unit tests) or create a simplified ZooKeeper in the unit test (for example, in the Redis Unit test, A mini-redis will be created) to ensure others can pass the test."}),"\n",(0,o.jsx)(n.li,{children:"When someone commits code, it automatically runs unit tests, and and they will be merged only when they are all passed. Therefore, try to avoid sleeping too long in the unit test (sleeping too long can decrease the speed of unit tests)"}),"\n"]}),"\n",(0,o.jsx)(n.h4,{id:"232-how-to-mock-out-dependencies-in-the-environment-when-running-unit-tests-such-as-mock-zookeeper-or-mock-redis",children:"2.3.2. How to mock out dependencies in the environment when running unit tests? (Such as Mock ZooKeeper or Mock Redis)"}),"\n",(0,o.jsx)(n.p,{children:"It is usual to encapsulate all network call code into a single interface, and then mock out that interface in ut. Take the unit tests in Apollo configuration center as an example, referring to components/configstores/apollo/configstore.go. and\ncomponents/configstores/ apollo/configstore_test.go:"}),"\n",(0,o.jsx)(n.p,{children:"First, in configstore.go, encapsulate all calls to the SDK, network and Apollo into a single interface."}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.img,{alt:"mock.png",src:t(8651).A+"",width:"494",height:"460"}),"\n",(0,o.jsx)(n.img,{alt:"img_8.png",src:t(4901).A+"",width:"939",height:"345"})]}),"\n",(0,o.jsx)(n.p,{children:"Then, encapsulate your code that calls the SDK and network into a struct which achieves that interface:"}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"img_9.png",src:t(3276).A+"",width:"469",height:"165"})}),"\n",(0,o.jsx)(n.p,{children:"Once you've done this refactoring, your code is testable (this is part of the idea of test-driven development, refactoring code into a form that can be injectable in order to improve its testability)"}),"\n",(0,o.jsx)(n.p,{children:"Next, we can mock that interface when we write ut:"}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"img_10.png",src:t(4622).A+"",width:"565",height:"331"})}),"\n",(0,o.jsx)(n.p,{children:"Just mock it into the struct you want to test, and test it."}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"img_11.png",src:t(2935).A+"",width:"812",height:"474"})}),"\n",(0,o.jsx)(n.p,{children:'Note: Generally, during "integration test", network call will be made and a normal ZooKeeper or Redis will be called. On contract, the single test focuses on the local logic, and will not call the real environment'}),"\n",(0,o.jsx)(n.h2,{id:"3register-components-when-layotto-starts",children:"3\u3001Register components when Layotto starts"}),"\n",(0,o.jsx)(n.p,{children:"Following the steps above only develops the component which Layotto does not automatically load when it starts."}),"\n",(0,o.jsx)(n.p,{children:"So how should let Layotto load the components at startup?"}),"\n",(0,o.jsx)(n.p,{children:"Need to integrate new components in cmd/layotto/main.go, including:"}),"\n",(0,o.jsx)(n.h3,{id:"31-import-your-components-in-maingo",children:"3.1. Import your components in main.go"}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"img_1.png",src:t(2484).A+"",width:"896",height:"374"})}),"\n",(0,o.jsx)(n.h3,{id:"32-register-your-component-in-the-newruntimegrpcserver-function-of-maingo",children:"3.2. Register your component in the NewRuntimeGrpcServer function of main.go"}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"img_4.png",src:t(3929).A+"",width:"1652",height:"511"})}),"\n",(0,o.jsx)(n.p,{children:'After that, Layotto initializes the ZooKeeper component if the user has configured "I want to use ZooKeeper" in the Layotto configuration file'}),"\n",(0,o.jsx)(n.h2,{id:"4add-demo-for-integration-test",children:"4\u3001Add demo for integration test"}),"\n",(0,o.jsx)(n.p,{children:"According to the above operations, the development is completed, but we need to get the process running and testing, so we need to add an integration test demo"}),"\n",(0,o.jsx)(n.h3,{id:"41-add-a-sample-configuration-file",children:"4.1. Add a sample configuration file"}),"\n",(0,o.jsx)(n.p,{children:"As mentioned above:"}),"\n",(0,o.jsxs)(n.blockquote,{children:["\n",(0,o.jsx)(n.p,{children:'Layotto initializes the ZooKeeper component if the user has configured "I want to use ZooKeeper" in the Layotto configuration file'}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"So how to configure when users want to use Zookeeper? We need to provide a sample configuration, for both user reference and running integration tests"}),"\n",(0,o.jsx)(n.p,{children:"We can copy a json configuration file from another component. For example, copy configs/config_redis.json and paste it into configs/config_zookeeper.json when developing a plug-in component\nThen edit and modify the configuration shown below:"}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"img_3.png",src:t(3958).A+"",width:"1084",height:"1106"})}),"\n",(0,o.jsx)(n.h3,{id:"42-add-client-demo",children:"4.2. Add client Demo"}),"\n",(0,o.jsx)(n.p,{children:"We need a client demo, such as the distributed lock client demo that has two coroutines concurrently calling Layotto to grab the lock, and only one can grab the lock"}),"\n",(0,o.jsx)(n.h4,{id:"a-if-the-component-has-a-generic-client-it-doesnt-need-to-be-developed",children:"a. If the component has a generic client, it doesn't need to be developed"}),"\n",(0,o.jsx)(n.p,{children:"If there is a common folder under demo directory, it means the demo is a general purpose demo, which can be used by different components. You can pass the storeName parameter on the command line, and you don't need to develop a demo if you have this"}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"img_6.png",src:t(7291).A+"",width:"231",height:"428"})}),"\n",(0,o.jsx)(n.h4,{id:"b-if-the-component-does-not-have-a-generic-client-or-requires-custom-metadata-arguments-copy-and-paste-them",children:"b. If the component does not have a generic client or requires custom metadata arguments, copy and paste them"}),"\n",(0,o.jsx)(n.p,{children:"For example, when implementing distributed locks using ZooKeeper, you need some custom configurations. Then you can write your demo based on the Redis demo"}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"img_7.png",src:t(5746).A+"",width:"564",height:"463"})}),"\n",(0,o.jsx)(n.p,{children:"Note: If there are errors in the demo code that shouldn't be there , you can panic directly. Later, we will directly use demo to run the integration test. If panic occurs, it means that the integration test fails. For example the demo/lock/redis/client.go:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-go",children:"    //....\n  cli, err := client.NewClient()\n  if err != nil {\n    panic(err)\n  }\n    //....\n"})}),"\n",(0,o.jsx)(n.h3,{id:"43-refer-to-the-quickstart-documentation-to-start-layotto-and-demo-and-see-if-any-errors-are-reported",children:"4.3. Refer to the QuickStart documentation to start Layotto and Demo and see if any errors are reported"}),"\n",(0,o.jsxs)(n.p,{children:["For example, refer to the ",(0,o.jsx)(n.a,{href:"/en-US/docs/start/lock/start",children:"QuickStart documentation of the Distributed Lock API"})," , start your dependent environment (such as ZooKeeper), and start Layotto (remember to use the configuration file you just added!). And check for errors."]}),"\n",(0,o.jsx)(n.p,{children:"Note: The following Error is ok, just ignore it"}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"img_2.png",src:t(7759).A+"",width:"836",height:"404"})}),"\n",(0,o.jsx)(n.p,{children:"Start demo and call Layotto to see if any errors are reported. If it is a universal client, you can pass storeName with -s storeName in the command line"}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"img_5.png",src:t(9728).A+"",width:"519",height:"334"})}),"\n",(0,o.jsx)(n.p,{children:"If there is no error when running, it means the test passed!"}),"\n",(0,o.jsx)(n.h2,{id:"5new-component-description-documents",children:"5\u3001New component description documents"}),"\n",(0,o.jsx)(n.p,{children:"When the above code work is completed , it is better to add the configuration documentation of the component, explaining what configuration items the component supports and how to start the environment that the component depends on (for example, how to start ZooKeeper with Docker)."}),"\n",(0,o.jsxs)(n.p,{children:["You can refer to the ",(0,o.jsx)(n.a,{href:"/en-US/docs/component_specs/lock/redis",children:"Redis component description of the Lock API (Chinese)"})," and ",(0,o.jsx)(n.a,{href:"/en-US/docs/component_specs/lock/redis",children:"the Redis component description of the Lock API (English)"}),", also can copy and paste change."]})]})}function p(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(l,{...e})}):l(e)}},7716:(e,n,t)=>{t.d(n,{A:()=>o});const o=t.p+"assets/images/img-ed6f044901d313750a169e7fae5b850d.png"},2484:(e,n,t)=>{t.d(n,{A:()=>o});const o=t.p+"assets/images/img_1-d344ffaf7a6dd87def83a1747e3a37ff.png"},4622:(e,n,t)=>{t.d(n,{A:()=>o});const o=t.p+"assets/images/img_10-6b39f19e4db2c5de146f82ffbb76223f.png"},2935:(e,n,t)=>{t.d(n,{A:()=>o});const o=t.p+"assets/images/img_11-0986a3a47c4ccad9fcdbeef3875abe42.png"},7759:(e,n,t)=>{t.d(n,{A:()=>o});const o=t.p+"assets/images/img_2-5e7c28bfced25514591b1d019663a7a8.png"},3958:(e,n,t)=>{t.d(n,{A:()=>o});const o=t.p+"assets/images/img_3-3f0336b83566b423cee29bd085a3b7ed.png"},3929:(e,n,t)=>{t.d(n,{A:()=>o});const o=t.p+"assets/images/img_4-c239bf46926f7c6b205ed82c392911ad.png"},9728:(e,n,t)=>{t.d(n,{A:()=>o});const o=t.p+"assets/images/img_5-2149deb8c2b312422f4f2a1c3903c755.png"},7291:(e,n,t)=>{t.d(n,{A:()=>o});const o=t.p+"assets/images/img_6-ee374b56b183779ac643442b46e0ef11.png"},5746:(e,n,t)=>{t.d(n,{A:()=>o});const o=t.p+"assets/images/img_7-297f28adc8bb8a917f9e2bf6f9e3f218.png"},4901:(e,n,t)=>{t.d(n,{A:()=>o});const o=t.p+"assets/images/img_8-1c2f591603db8e9e21237c6a6c2669c3.png"},3276:(e,n,t)=>{t.d(n,{A:()=>o});const o=t.p+"assets/images/img_9-142266a6480f95461d00ae38253aa735.png"},8651:(e,n,t)=>{t.d(n,{A:()=>o});const o=t.p+"assets/images/mock-b7c6e959da5246bb60948edcb1fcfc71.png"},8453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>a});var o=t(6540);const i={},s=o.createContext(i);function r(e){const n=o.useContext(s);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),o.createElement(s.Provider,{value:n},e.children)}}}]);